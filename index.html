<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
  <title>å°å¿ƒè‚åŠ è½½ä¸­...</title>
  <link rel="icon" type="image/png" sizes="96x96" href="me.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&display=swap" rel="stylesheet">
  <!-- ä¼˜åŒ–ç‚¹: å°†æ‰€æœ‰CSSå†…è”ä»¥å‡å°‘HTTPè¯·æ±‚ï¼Œå¹¶ç§»é™¤æ‰€æœ‰ <link rel="preload">ã€‚èµ„æºåŠ è½½å°†ç”±JavaScriptç²¾ç¡®æ§åˆ¶ã€‚ -->
  <style>
    /* æ‰€æœ‰çš„æ¸¸æˆæ ·å¼éƒ½é›†ä¸­åœ¨è¿™é‡Œã€‚åŸæœ‰çš„ iconfont.css å’Œ style.css å†…å®¹åº”åˆå¹¶äºæ­¤ã€‚ */
    *{
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}
#player{
    position: relative;
    top:0px;
    left:0px;
}
/* æ­Œæ›²ä¿¡æ¯æ¨¡å— */
#player-content1{
    position: absolute;
    top:0px;
    left:15px;
    width:320px;
    height:90px;
    padding:0 20px 0 130px;
    background: rgb(209, 226, 245);
    border-top-left-radius: 10px;
    border-top-right-radius: 10px;
    /* transitionè¿‡æ¸¡åŠ¨ç”»ï¼šè®¾ç½®topå±æ€§è¿‡æ¸¡ï¼Œè¿‡æ¸¡æ—¶é—´0.3s,é€Ÿåº¦æ›²çº¿ä¸ºease(é€æ¸å˜æ…¢) */
    transition:top 0.3s ease; 
}
#player-content1.active{
    top:-85px;
}
.music-name,
.artist-name{
    height: 20px;
    margin-top:5px;
    font-size:14px;
}
.artist-name{
    font-size:12px;
    color: #656565
}
.time{
    font-size:12px;
    height:15px;
    margin: 5px 0;
}
.current-time{
    float: left;
}
.total-time{
    float: right;
}
.current-time,.total-time{
    color: transparent;
    font-size: 11px;
    background-color: #e8f5ff;
    border-radius: 10px;
    transition: 0.3s ease all;
}
.time.active .current-time, .time.active .total-time{
    color: rgb(54, 127, 196);
    background-color: transparent;
}


#s-area, #seek-bar{
    position: relative;
    height: 4px;
    border-radius: 4px;
}

#s-area{
    background-color:#e8f5ff;
    cursor: pointer;
}

#ins-time{
    position: absolute;
    top: -29px;
    color: #fff;
    font-size: 12px;
    white-space: pre;
    padding: 5px 6px;
    border-radius: 4px;
	display:none;
}

#s-hover{
    position: absolute;
    top: 0;
    bottom: 0;
    left: 0;
    opacity: 0.2;
    z-index: 2;
}

#ins-time, #s-hover{
    background-color: #4b4d5c;
}

#seek-bar{
    content: '';
    position: absolute;
    top: 0;
    bottom: 0;
    left: 0;
    width: 0;
    background-color: rgb(54, 127, 196);
    transition: 0.2s ease width;
}

#player-content2{
    position: relative;
    width:350px;
    height:100px;
    
    background: #fff;
    border-radius: 20px;
    box-shadow: 0 20px 50px #656565;
    margin-bottom: 70px; /* æ·»åŠ åº•éƒ¨é—´è· */
}
/* å·¦ä¾§å°é¢å›¾æ¨¡å— */
.music-imgs{
    position: absolute;
    top: -40px;
    width: 100px;
    height: 100px;
    margin-left: 30px;
    -webkit-transform: rotateZ(0);
    transform: rotateZ(0);
    transition: 0.3s ease all;
    box-shadow: 0 0 0 10px #fff;
    border-radius: 50%;
    overflow: hidden;
}
/* å·¦ä¾§å°é¢å›¾æ¨¡å—æ·»åŠ äº†activeç±»å */
.music-imgs.active{
    top: -50px;
    box-shadow: 0 0 0 4px #e8f5ff, 0 30px 50px -15px #afb7c1;
}
.music-imgs:before{
    content: '';
    position: absolute;
    top: 50%;
    right: 0;
    left: 0;
    width: 20px;
    height: 20px;
    margin: -10px auto 0 auto;
    background-color: #d6dee7;
    border-radius: 50%;
    box-shadow: inset 0 0 0 2px #fff;
    z-index: 2;
}
/* å·¦ä¾§å°é¢å›¾æ¨¡å—ä¸‹çš„ å›¾ç‰‡div */
.music-imgs .img{
    display: block;
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
}
/* å°é¢å›¾æ¨¡å—æ·»åŠ äº†activeç±»ååï¼Œå›¾ç‰‡divçš„æ ·å¼æ·»åŠ  */
.music-imgs.active .img{
    z-index: 1;
    -webkit-animation: rotateAlbumArt 3s linear 0s infinite forwards;
            animation: rotateAlbumArt 3s linear 0s infinite forwards;
}
@-webkit-keyframes rotateAlbumArt
{
    0%{ -webkit-transform: rotateZ(0); transform: rotateZ(0); }
    100%{ -webkit-transform: rotateZ(360deg); transform: rotateZ(360deg); }
}

@keyframes rotateAlbumArt
{
    0%{ -webkit-transform: rotateZ(0); transform: rotateZ(0); }
    100%{ -webkit-transform: rotateZ(360deg); transform: rotateZ(360deg); }
}
#buffer-box
{
    position: absolute;
    top: 50%;
    right: 0;
    left: 0;
    height: 13px;
    color: #1f1f1f;
    font-size: 13px;
    font-family: Helvetica;
    text-align: center;
    font-weight: bold;
    line-height: 1;
    padding: 6px;
    margin: -12px auto 0 auto;
    background-color: rgba(255, 255, 255, 0.19);
    opacity: 0;
    z-index: 2;
}

.music-imgs .img, #buffer-box
{
    transition: 0.1s linear all;
}

.music-imgs.buffering .img
{
    opacity: 0.25;
}

.music-imgs.buffering .img.active
{
    opacity: 0.8;
    filter: blur(2px);
    -webkit-filter: blur(2px);
}

.music-imgs.buffering #buffer-box
{
    opacity: 1;
}

.player-controls{
    position: absolute;
    top:20px;
    left:150px;
}
.player-controls .btn{
    float: left;
    width:60px;
    height:60px;
    line-height: 60px;
    font-size:24px;
    color:#D6DEE7;
}
    @font-face {font-family: "iconfont";
  src: url('iconfont.eot?t=1583039253866'); /* IE9 */
  src: url('iconfont.eot?t=1583039253866#iefix') format('embedded-opentype'), /* IE6-IE8 */
  url('data:application/x-font-woff2;charset=utf-8;base64,d09GMgABAAAAAAO4AAsAAAAACLAAAANrAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHEIGVgCDQAqEIIM5ATYCJAMYCw4ABCAFhG0HZBtzBxEVnHfIfhzkpqnr/HGf42RNtEXjvwfPY95/5yZpX7+EJQai9pS20wBY3BQFO8ZEKJ6cvf76rKQlvNC78z/HTJfWYPmB5pTZtDccjhJoQBkXzUd2B9ICh3wgIJ7NYF+8HwJ4E08uUr1m/eY4GIJNAkj/Pr264LQ0mBmy4MjtkZMGWYyFo+aoq8Ci/P3lC8XigMLSBDsb96zRncrv1ftnerI7mfYpAu7pTIB2DjSQCxiQ4aOWgegykovG2wkZqoK730Gh3uv3ke+XvX/muqcVIHggize+YTZYGNSJ/nliE+T6AlCfqAXvVcyppRoVBmkkYuakyxCD9Bm8j6SwT7jCG1gMVwhwqYQFjQpFvjj9/QOD+evjhuyYnDp4++Foa92Rbvfvt3zwoNW9ey3u3h17923ze+9aPPjQ6v771mfvJm65V+PCg5St98edu5dkNt+tfv5+srXtwaCWq5X3zr2n2Lkvw2fHniizene7XvvOZa2hXHM0dW56z50bY1aNG5Wlrkpu3X33+ey1Iu0+kTEvrceODZHLfUvSd0wcUDwg2TFulff/3SrcoPX66lUthOtVFoK6yOtO38cmIcEgfCyzaJKTet9s2tTPL5bdzGcQeMd/SN26EcERsnxI0TtOuuu4Fp8++Lunief7YPn3Xzx5R8Hk2ZG3Iwr8R70Mj9kZlTfvTC1Kgl+umdseAPeanqJLWP5bj9b+AHqxei1si9TLv/xj+HR6zsROAWX/HB8DwOMp3cOocCcb9GT436Ss5v7B3JUdxuUHWtvY7eOjCGCTigZA+QPewB/rCOb5qWxhUJsER+cCCg9xoHFIRRpsLlj4UAo2DpXAmxxqnfchhKFoxHgB2cwQIARyCBT+nABNINeQBvsMLML5BjaBosGblhJyTR/SBcO7oyMM1MH7B6xk0ZE+7Ir8G5k4oWvyc8qLnGc/NGXdjV9pIXeKPT6ZNgQN2skMF/EwmiaB1clAKpR9COuhqvTYK5VK5mxHNUcYqIP3D1jJotP+Ydd7+xuZOKGbaeswv8h5nh6asl6BvEqWVW1vZb5Ppg1By+u0kxkumGgKIwLr+LKBVCj7HaH1UEnd9FpJeXnZ/C1PAN4EL7VFiRYjltjiwa8vU8e4jMi+51zR63S54o+fKWkxe99jKvqNZkncfhlLdZYBAA==') format('woff2'),
  url('iconfont.woff?t=1583039253866') format('woff'),
  url('iconfont.ttf?t=1583039253866') format('truetype'), /* chrome, firefox, opera, Safari, Android, iOS 4.2+ */
  url('iconfont.svg?t=1583039253866#iconfont') format('svg'); /* iOS 4.1- */
}

.iconfont {
  font-family: "iconfont" !important;
  font-size: 16px;
  font-style: normal;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

.icon-jiediankaishi:before {
  content: "\e6dd";
}

.icon-center:before {
  content: "\e618";
}

.icon-zanting:before {
  content: "\e693";
}

.icon-shangyishou:before {
  content: "\e603";
}

.icon-xiayishou:before {
  content: "\e602";
}


    /* Keyframe animations */
    @keyframes card-entry {
      0% { opacity: 0; transform: scale(0.5) translateY(-50px); }
      70% { opacity: 1; transform: scale(1.05) translateY(10px); }
      100% { opacity: 1; transform: scale(1) translateY(0); }
    }
    @keyframes card-disappear {
        from { opacity: 1; transform: scale(1) rotate(0deg); }
        to { opacity: 0; transform: scale(0.4) rotate(20deg); }
    }
    .temp-card.disappearing { animation: card-disappear 0.3s ease-out forwards; }
    @keyframes slot-flash {
        0% { background-color: #fdf5e6; box-shadow: inset 0 1px 4px rgba(0,0,0,0.05); }
        50% { background-color: #fff8dc; box-shadow: inset 0 0 10px rgba(255, 215, 0, 0.8), 0 0 15px rgba(255, 215, 0, 0.5); }
        100% { background-color: #fdf5e6; box-shadow: inset 0 1px 4px rgba(0,0,0,0.05); }
    }
    .temp-slot.clearing { animation: slot-flash 0.4s ease-out; }
    @keyframes pulse-scale {
      0%, 100% { transform: scale(1); opacity: 0.8; }
      50% { transform: scale(1.05); opacity: 1; }
    }
    @keyframes text-progress {
      0% { content: "."; }
      33% { content: ".."; }
      66% { content: "..."; }
      100% { content: "."; }
    }
    @keyframes wave {
      0%, 100% { transform: translateY(0) rotate(0deg); }
      25% { transform: translateY(-10px) rotate(2deg); }
      75% { transform: translateY(5px) rotate(-1deg); }
    }
    @keyframes show-card-property {
      0% { opacity: 0; }
      20% { opacity: 1; }
      80% { opacity: 1; }
      100% { opacity: 0; }
    }
    @keyframes fade-in-out-scale {
      0% { opacity: 0; transform: scale(0.8); }
      50% { opacity: 1; transform: scale(1); }
      100% { opacity: 0; transform: scale(0.9); }
    }
    @keyframes shake {
      0%, 100% { transform: translateX(0) rotate(0deg); }
      10%, 30%, 50%, 70%, 90% { transform: translateX(-3px) rotate(-1deg); }
      20%, 40%, 60%, 80% { transform: translateX(3px) rotate(1deg); }
    }
    @keyframes score-pop {
      0% { opacity: 0; transform: translateY(0) scale(0.8); }
      20% { opacity: 1; transform: translateY(-15px) scale(1.1); }
      80% { opacity: 1; transform: translateY(-30px) scale(1); }
      100% { opacity: 0; transform: translateY(-40px) scale(0.7); }
    }
    .score-animation {
      position: absolute;
      font-size: 1.5rem;
      font-weight: bold;
      color: #4CAF50;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
      pointer-events: none;
      animation: score-pop 1s ease-out forwards;
      z-index: 2000;
    }
    @keyframes card-shuffle-out {
      0% { opacity: 1; transform: scale(1) rotate(0deg); }
      50% { opacity: 0; transform: scale(0.5) rotate(15deg); }
      100% { opacity: 0; transform: scale(0.5) rotate(15deg); }
    }
    .card-shuffling-out { animation: card-shuffle-out 0.3s ease-in forwards; }
    @keyframes fade-in-out-heart {
      0% { opacity: 0; transform: scale(0.5); }
      50% { opacity: 1; transform: scale(1.2); }
      100% { opacity: 0; transform: scale(0.8); }
    }
    .heart-animation {
      position: absolute;
      font-size: 30px;
      color: #ff69b4;
      pointer-events: none;
      animation: fade-in-out-heart 2.5s ease-out infinite alternate;
      z-index: 1000;
      text-shadow: 1px 1px 3px rgba(0,0,0,0.2);
    }
    .confetti-container {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        pointer-events: none; overflow: hidden; z-index: 9999;
    }
    .confetti-piece {
        position: absolute; width: 8px; height: 16px;
        background: #f00; top: -20px; opacity: 0;
        animation: fall linear forwards;
    }
    @keyframes fall {
        0% { transform: translateY(0) rotateZ(0deg); opacity: 1; }
        100% { transform: translateY(110vh) rotateZ(720deg); opacity: 0; }
    }
    @keyframes button-scale-pulse {
      0%, 100% { transform: scale(1); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
      50% { transform: scale(1.08); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
    }
    @keyframes button-scale-fade-pulse {
      0%, 100% { transform: scale(1); opacity: 0.8; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
      50% { transform: scale(1.08); opacity: 1; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
    }
    .animated-scale-fade { animation: button-scale-fade-pulse 1.8s infinite ease-in-out; }
    @keyframes cloud-pass {
      from { transform: translateX(-250px); }
      to { transform: translateX(100vw); }
    }
    body {
      margin: 0; min-height: 100vh; overflow-x: hidden;
      font-family: 'ZCOOL KuaiLe', 'HanyiSentyLotus', 'FangSong', cursive, sans-serif;
      color: #3e2723; position: relative;
    }
    body::before {
      content: ""; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: #f7f0e8 url('cat1.webp') no-repeat center center;
      background-size: cover; z-index: -2;
    }
    body::after {
      content: ""; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background-color: white; opacity: 0.3; z-index: -1;
    }
    body.no-scroll { overflow: hidden; }
    #game-container {
      max-width: 650px; margin: 30px auto; background: rgba(255, 255, 255, 0.7);
      border-radius: 25px; box-shadow: 0 5px 25px rgba(100, 60, 40, 0.3);
      padding: 0 0 20px 0; position: relative; min-height: 880px;
      display: flex; flex-direction: column; align-items: center;
      border: 3px solid #8B4513;
    }
    @media (max-width: 700px) {
      #game-container {
        max-width: 100vw; margin: 0; box-shadow: none; border-radius: 0;
        min-height: 100vh; border: none;
        padding-top: env(safe-area-inset-top); padding-bottom: env(safe-area-inset-bottom);
        padding-left: env(safe-area-inset-left); padding-right: env(safe-area-inset-right);
      }
    }
    @media (min-width: 701px) {
      #game-container {
        max-width: 900px; min-height: 90vh; margin: 5vh auto;
      }
    }
    #header-bar {
      width: 100%; padding: 15px 25px 0 25px; box-sizing: border-box;
      display: flex; justify-content: space-between; align-items: center;
      background: linear-gradient(to bottom, rgba(255,255,255,0.8), rgba(255,255,255,0));
      border-top-left-radius: 22px; border-top-right-radius: 22px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    #progress-info {
      font-size: 1.55rem; font-weight: bold; color: #5d4037;
      text-shadow: 0.5px 0.5px 0 rgba(255,255,255,0.7);
      display: flex; gap: 15px; align-items: center;
    }
    #music-toggle {
      background: none; border: none; outline: none; font-size: 1.8rem;
      cursor: pointer; color: #6d4c41; transition: transform 0.2s ease-in-out;
    }
    #music-toggle:hover { transform: scale(1.1); }
    .score-display, .target-display {
        font-size: 1.2rem; color: #8B4513; font-weight: bold;
        text-shadow: 0.5px 0.5px 0 rgba(255,255,255,0.7);
    }
    #main-area {
      flex:1; width: 100%; display: flex; flex-direction: column;
      align-items: center; justify-content: flex-start; position: relative;
      padding-top: 10px;
    }
    #display-area {
        margin-top: 20px; width: 90%; max-width: 580px; min-height: 100px;
        background: rgba(240, 230, 210, 0.6); border-radius: 15px;
        box-shadow: inset 0 2px 10px rgba(100, 60, 40, 0.15), 0 5px 15px rgba(100, 60, 40, 0.2);
        display: flex; flex-direction: row; flex-wrap: wrap; justify-content: center;
        align-items: center; border: 2px dashed #b8860b; padding: 10px;
        box-sizing: border-box; gap: 10px;
    }
    @media (max-width: 650px) {
      #display-area { width: 96vw; min-width: unset; min-height: 80px; }
    }
    .display-group {
        display: flex; gap: 5px; align-items: center; justify-content: center;
        background: rgba(255, 255, 255, 0.5); border-radius: 8px;
        padding: 5px 10px; border: 1px solid #d4a762;
    }
    .display-card {
        background: #fffdf7; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        border: 2px solid #a0522d; display: flex; align-items: center; justify-content: center;
        user-select: none; opacity: 1; transition: opacity 0.3s ease-out;
    }
    .display-card.matched-display { opacity: 0; }
    #curtain {
        position: absolute; background-color: rgba(255, 255, 255, 0.95);
        z-index: 1050; display: none; border-radius: 15px;
        transition: opacity 0.5s ease-in-out; overflow: hidden; opacity: 1;
    }
    #curtain::before {
        content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: linear-gradient(to bottom, #f7f0e8, #e0d8cf); opacity: 0.9;
    }
    #curtain.open { opacity: 0; pointer-events: none; }
    #curtain.closed { opacity: 1; pointer-events: all; }
    #cat-path {
        position: absolute; width: 100%; height: 20px; left: 0;
        z-index: 1060; pointer-events: none; overflow: visible;
    }
    @keyframes cat-walk {
        0% { left: 0; }
        100% { left: calc(100% - 55px); }
    }
    #walking-cat {
        position: absolute; width: 30px; height: 30px; font-size: 30px;
        line-height: 1; display: flex; z-index: 10; align-items: center;
        justify-content: center; color: #5d4037; top: -20px;
        transform: scaleX(-1); transition: transform 0.2s ease-in-out;
        animation: cat-walk 15s linear infinite alternate;
    }
    .wiggling-cat-instance {
        position: absolute; width: 35px; height: 35px; font-size: 35px;
        line-height: 1; display: flex; align-items: center; justify-content: center;
        color: #5d4037; transform: translateX(-50%);
        animation: shake 1.8s ease-in-out infinite alternate;
        z-index: 10; pointer-events: none; display: none;
    }
    #card-stack-area {
      margin-top: 20px; width: 90%; max-width: 580px; height: 500px;
      position: relative; background: rgba(240, 230, 210, 0.6);
      border-radius: 15px;
      box-shadow: inset 0 2px 10px rgba(100, 60, 40, 0.15), 0 5px 15px rgba(100, 60, 40, 0.2);
      overflow: visible; display: flex; align-items: center; justify-content: center;
      border: 2px dashed #b8860b;
    }
    @media (max-width: 650px) {
      #card-stack-area {
        width: 96vw; min-width: unset; height: 60vh;
        max-height: 420px; margin-top: 15px; margin-bottom: 15px;
      }
    }
    @media (min-width: 701px) {
      #card-stack-area { height: 600px; max-height: 60vh; }
    }
    .card {
      background: #fffdf7; border-radius: 10px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1), inset 0 0 0 1px rgba(255,255,255,0.5);
      border: 3px solid #d4a762; position: absolute; display: flex;
      align-items: center; justify-content: center; cursor: pointer;
      user-select: none;
      transition: transform 0.15s ease-out, box-shadow 0.15s ease-out, opacity 0.3s, border-color 0.15s;
      z-index: 1; overflow: hidden; color: #5d4037;
      -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none;
    }
    .card-entering { animation: card-entry 0.5s ease-out forwards; }
    .hint-animation { animation: show-card-property 2s forwards; }
    .card.selected {
      border: 3.5px solid #a0522d;
      box-shadow: 0 4px 20px rgba(160, 82, 45, 0.4), 0 0 25px rgba(255,255,0,0.5);
      z-index: 100 !important; transform: scale(1.01) rotate(-2deg);
    }
    .card.disabled { pointer-events: none; position: absolute; opacity: 1; }
    .card.disabled::before {
      content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(128, 128, 128, 0.4); border-radius: 8px; z-index: 2;
      transition: background 0.5s ease;
    }
    .card.disabled > *:not(.disabled::before) { opacity: 0.5; }
    .card:not(.disabled):not(.matched):hover {
      transform: translateY(-5px) scale(1.05) rotate(2deg);
      box-shadow: 0 8px 20px rgba(0,0,0,0.15), inset 0 0 0 1px rgba(255,255,255,0.5);
      transition: transform 0.1s ease-out, box-shadow 0.05s ease-out; z-index: 2;
    }
    .card.matched { opacity: 0.05; transition: opacity 0.2s; pointer-events: none; }
    .card .mini {
      font-size: 1.2rem; position: absolute; bottom: 7px; right: 9px;
      opacity: 0.5; user-select: none; -webkit-user-select: none;
      -moz-user-select: none; -ms-user-select: none;
    }
    .card.napping { pointer-events: none !important; }
    .card.napping::after {
        content: 'ğŸ’¤'; position: absolute; top: -10px; right: -5px;
        font-size: 1.5rem; animation: wave 1.5s infinite ease-in-out; z-index: 5;
    }
    .card.napping::before { background: rgba(100, 100, 150, 0.3) !important; }
    #temp-area {
      margin: 20px auto 0 auto; display: flex; justify-content: space-evenly;
      align-items: center; min-height: 80px; width: 90%; max-width: 500px;
      border-radius: 12px; background: #fffcf0; border: 2px dashed #b8860b;
      padding: 8px 0; box-sizing: border-box;
      box-shadow: inset 0 1px 5px rgba(0,0,0,0.08);
    }
    .temp-slot {
      margin: 0; background: #fdf5e6; border-radius: 9px;
      border: 2px dashed #d4a762; display: flex; align-items: center;
      justify-content: center; color: #92776c;
      box-shadow: inset 0 1px 4px rgba(0,0,0,0.05);
      position: relative; overflow: hidden; flex-shrink: 0;
    }
    .temp-card {
      width: 100%; height: 100%; background: #fffdf7; border-radius: 9px;
      border: 2.5px solid #a0522d; display: flex; align-items: center;
      justify-content: center; box-shadow: 0 2px 8px rgba(160, 82, 45, 0.3);
      cursor: default; position: absolute;
      transition: opacity 0.2s, border-color 0.2s, box-shadow 0.2s;
      box-sizing: border-box; color: #5d4037;
    }
    .temp-card.matched { opacity: 0.05; }
    .flying-card {
      background: #fffdf7; border-radius: 10px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1), inset 0 0 0 1px rgba(255,255,255,0.5);
      border: 3px solid #d4a762; position: fixed; display: flex;
      align-items: center; justify-content: center; user-select: none;
      z-index: 10000;
      transition: top 0.3s ease-in-out, left 0.3s ease-in-out, transform 0.3s ease-in-out;
      overflow: hidden; color: #5d4037;
    }
    #tools-bar {
      margin: 20px auto 0 auto; display: flex; align-items: center;
      justify-content: center; gap: 18px; width: 90%; max-width: 500px;
      flex-wrap: wrap;
    }
    #tools-bar button {
      padding: 9px 18px; background: #f7e9d7; border: 2px solid #b8860b;
      border-radius: 10px; font-size: 1.05rem; color: #6e352f;
      font-weight: bold; cursor: pointer;
      transition: background 0.15s, transform 0.1s; outline: none;
      position: relative; min-width: 75px; box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      font-family: 'ZCOOL KuaiLe', cursive;
    }
    #tools-bar button:hover { background: #e9d9c6; transform: translateY(-1px); }
    #tools-bar button:disabled {
      background: #f0f0f0; color: #b0b0b0; border-color: #d0d0d0;
      cursor: not-allowed; transform: none; box-shadow: none;
    }
    #restart-btn {
      background: #ffe0b3; border-color: #ffcc80; color: #96602c;
    }
    #restart-btn:hover { background: #ffd599; }
    #code-bar {
      margin: 15px auto 0 auto; display: flex; align-items: center;
      justify-content: center; gap: 8px; width: 90%; max-width: 450px;
    }
    #code-bar input {
      flex-grow: 1; max-width: 180px; padding: 7px 10px; border-radius: 8px;
      border: 2px solid #b8860b; outline: none; font-size: 1.05rem;
      color: #5d4037; background: #fffdf7;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
      font-family: 'ZCOOL KuaiLe', cursive;
    }
    #code-bar input::placeholder { color: #a0a0a0; }
    #code-bar button {
      padding: 7px 12px; font-size: 1.05rem; background: #e6f6d3;
      border: 2px solid #a0c388; border-radius: 9px; cursor: pointer;
      color: #3e5a2b; font-weight: bold; transition: background 0.15s;
      min-width: 65px; box-shadow: 0 1px 4px rgba(0,0,0,0.1);
      font-family: 'ZCOOL KuaiLe', cursive;
    }
    #code-bar button:hover { background: #d2e5bb; }
    #message-bar {
      margin: 15px auto 0 auto; text-align: center; font-size: 1.1rem;
      color: #c0392b; min-height: 28px; font-weight: bold; letter-spacing: 1.2px;
    }
    #event-overlay {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        display: none; align-items: center; justify-content: center;
        z-index: 2200; pointer-events: none;
    }
    #event-message-box {
        background: rgba(255, 253, 247, 0.9); padding: 20px 30px;
        border-radius: 15px; border: 3px solid #b8860b;
        box-shadow: 0 5px 20px rgba(0,0,0,0.2); text-align: center;
        animation: fade-in-out-scale 3.5s forwards;
    }
    #event-message-box p {
        font-size: 1.3rem; color: #6e352f; margin: 0; font-weight: bold;
        text-shadow: 1px 1px 0 rgba(255,255,255,0.5);
    }
    #event-message-box .event-icon { font-size: 2rem; margin-bottom: 10px; }
    #start-screen, #level-finish, #game-over {
      position: absolute; left: 0; right: 0; top: 0; bottom: 0;
      z-index: 1100; background: rgba(255,255,255,0.98);
      display: flex; align-items: center; justify-content: center;
      flex-direction: column; font-size: 1.1rem; border-radius: 25px;
      text-align: center;
    }
    #start-screen { padding-top: 10vh; overflow: hidden; box-sizing: border-box; }
    #start-screen-video {
        position: absolute; top: 50%; left: 50%;
        transform: translate(-50%, -50%); min-width: 100%; min-height: 100%;
        width: auto; height: auto; z-index: -1; opacity: 0.99; object-fit: cover;
    }
    #start-screen::before {
      content: ""; position: absolute; left: 0; right: 0; top: 0; bottom: 0;
      background-image: url('mao.webp'); background-size: cover;
      background-position: center; opacity: 0.5; z-index: -2;
    }
    #start-screen h1 {
      font-size: clamp(3rem, 12vw, 5rem); margin: 0 0 25px 0;
      letter-spacing: 3px;
      text-shadow: 2px 2px 0 #f7e9d7, 4px 4px 0 #b8860b;
      display: inline-block;
    }
    #start-screen h1 span {
      display: inline-block; animation: wave 2s infinite ease-in-out;
    }
    #start-screen h1 span:nth-child(1) { animation-delay: -0.4s; }
    #start-screen h1 span:nth-child(2) { animation-delay: -0.2s; }
    #start-screen h1 span:nth-child(3) { animation-delay: 0s; }
    #start-screen h1 span:nth-child(4) { animation-delay: 0.2s; }
    #start-screen h1 span:nth-child(5) { animation-delay: 0.4s; }
    #start-screen .start-btn {
      margin-top: 30px; padding: 15px 50px; font-size: 1.4rem;
      background: linear-gradient(90deg, #a0c388, #88b368);
      border: none; border-radius: 15px; color: #3e5a2b; font-weight: bold;
      cursor: pointer; box-shadow: 0 4px 15px rgba(160, 195, 136, 0.5);
      animation: pulse-scale 1.5s infinite ease-in-out;
      transition: background 0.2s, transform 0.1s;
      font-family: 'ZCOOL KuaiLe', cursive;
    }
    #start-screen .start-btn:hover {
      background: linear-gradient(90deg, #88b368, #a0c388);
      transform: translateY(-2px);
    }
    #start-screen p {
        color: #5d4037; line-height: 1.6; margin: 0 40px 15px; margin-top: 15vh;
    }
    #start-screen span { color: #c0392b; font-weight: bold; }
    .loading-footer {
        color: #795548; font-size: 0.85rem; position: absolute; bottom: 30px;
        left: 0; right: 0; text-align: center; letter-spacing: 1.5px;
        text-shadow: 0.5px 0.5px 0 rgba(255,255,255,0.5);
    }
    #level-finish, #game-over {
      font-size: 1.8rem; color: #5d4037; background: rgba(255,243,245,0.99);
      border-radius: 25px; position: absolute; overflow: hidden;
      border: 3px solid #8B4513; box-shadow: 0 5px 25px rgba(100, 60, 40, 0.3);
    }
    #game-over { overflow: hidden; }
    #game-over-content {
      width: 100%; height: 100%; display: flex; flex-direction: column;
      align-items: center; justify-content: center; animation: wave 2s infinite;
    }
    .cloud-layer {
      content: ''; position: absolute; left: 0; top: 0; width: 100%;
      height: 100%; pointer-events: none; z-index: 0;
    }
    .cloud-layer::before, .cloud-layer::after {
      content: 'ğŸŒ§ï¸'; position: absolute; opacity: 0.88; color: #888;
      animation-name: cloud-pass; animation-timing-function: linear;
      animation-iteration-count: infinite;
    }
    .cloud-layer::before {
      font-size: 120px; top: 10%; animation-duration: 20s; animation-delay: -5s;
    }
    .cloud-layer::after {
      font-size: 80px; top: 25%; animation-duration: 15s;
    }
    #game-over > * { position: relative; z-index: 1; }
    #level-finish::before, #game-over::before {
      content: ""; position: absolute; left: 0; right: 0; top: 0; bottom: 0;
      background-image: url('mao1.webp'); background-size: cover;
      background-position: center; opacity: 0.4; z-index: -1;
    }
    #level-finish button, #game-over button {
      margin-top: 20px; padding: 12px 35px; font-size: 1.25rem;
      background: #e6f6d3; border: 2px solid #a0c388; border-radius: 12px;
      color: #3e5a2b; font-weight: bold; cursor: pointer;
      transition: background 0.15s, transform 0.1s;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      font-family: 'ZCOOL KuaiLe', cursive;
    }
    #level-finish button:hover, #game-over button:hover {
      background: #d2e5bb; transform: translateY(-1px);
    }
    #retry-btn {
      margin-top: 18px; padding: 10px 30px; font-size: 1.15rem;
      background: #f7e9d7; border: 2px solid #d4a762; border-radius: 10px;
      color: #6e352f; font-weight: bold; cursor: pointer;
      transition: background 0.15s, transform 0.1s; display: inline-block;
      box-shadow: 0 1px 5px rgba(0,0,0,0.1);
    }
    #retry-btn:hover { background: #f0e1d0; transform: translateY(-1px); }
    #retry-btn2, #next-btn { animation: button-scale-pulse 1.5s infinite ease-in-out; }
    #footer {
      margin: 20px auto 0 auto; width: 100%; text-align: center; font-size: 1rem;
      color: #8B4513; letter-spacing: 1.5px;
      text-shadow: 0.5px 0.5px 0 rgba(255,255,255,0.5);
    }
    .hinted-shake { animation: shake 0.5s ease-in-out 4; }
    .modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.6); z-index: 2500; display: none;
        align-items: center; justify-content: center;
    }
    .modal-content {
        background: #fffdf7; padding: 30px 40px; border-radius: 15px;
        text-align: center; box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        border: 3px solid #d4a762;
    }
    .modal-content p {
        font-size: 1.2rem; color: #5d4037; margin: 0 0 25px 0; font-weight: bold;
    }
    .modal-content button {
        padding: 9px 25px; background: #f7e9d7; border: 2px solid #b8860b;
        border-radius: 10px; font-size: 1.05rem; color: #6e352f;
        font-weight: bold; cursor: pointer; margin: 0 10px;
        transition: background 0.15s, transform 0.1s;
        font-family: 'ZCOOL KuaiLe', cursive;
    }
    #confirm-yes {
        background: #e6f6d3; border-color: #a0c388; color: #3e5a2b;
    }
    #confirm-yes:hover { background: #d2e5bb; }
    #confirm-no:hover { background: #e9d9c6; }
    #level-finish-text {
      color: #3e2723; font-size: 1.2em; text-align: center;
      margin-top: 20px; margin-bottom: 20px;
    }
    #loading-screen {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      z-index: 1199; display: flex; align-items: center; justify-content: center;
      background-color: #f7f0e8; background-size: cover;
      transition: opacity 0.5s ease-out; border-radius: 25px; overflow: hidden;
    }
    #loading-screen::before {
      content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background-image: url('mao3.webp'); background-repeat: no-repeat;
      background-position: center center; background-size: cover; opacity: 0.6;
    }
    .loading-content {
      position: relative; z-index: 1001; text-align: center; width: 80%;
      max-width: 500px; display: flex; flex-direction: column; height: 100%;
      align-items: center; justify-content: flex-start; padding-top: 6vh;
      box-sizing: border-box;
    }
    .loading-title {
      font-size: 2.8rem; margin: 0 0 40px 0; color: #3e2723;
      letter-spacing: 3px;
      text-shadow: 2px 2px 0 #f7e9d7, 4px 4px 0 #b8860b;
      animation: pulse-scale 1.5s infinite ease-in-out;
    }
    .loading-title::after { content: "."; animation: text-progress 2s infinite; }
    .progress-bar-container {
      width: 100%; height: 30px; background: rgba(184, 134, 11, 0.2);
      border-radius: 10px; border: 2px solid #b8860b; overflow: hidden;
      margin-bottom: 15px; box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
      margin-top: 40vh; z-index: 1004;
    }
    #progress-bar {
      width: 0%; height: 100%;
      background: linear-gradient(90deg, #a0c388, #88b368);
      border-radius: 8px; transition: width 0.3s ease-out;
    }
    #loading-text {
      font-size: 1.1rem; color: #5d4037; margin-bottom: 40px;
      min-height: 20px; text-align: center;
    }
    .responsive-video-container {
        position: relative; width: 100%; max-width: 660px;
        padding-bottom: 68.1818%; height: 0; overflow: hidden;
        border-radius: 10px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    .responsive-video-container iframe {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        border: 0; border-radius: 10px;
    }
    #level2-outro-screen {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background-color: rgba(0, 0, 0, 0.9); z-index: 2000; display: none;
        flex-direction: column; align-items: center; justify-content: center;
        border-radius: 25px; overflow: hidden;
    }
    #level2-outro-screen video {
        position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
        height: 100%; width: auto; object-fit: cover;
        border-radius: 0; box-shadow: none;
    }
    #level2-outro-screen img {
        position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
        min-width: 100%; min-height: 100%; width: auto; height: auto;
        object-fit: cover; border-radius: 0; box-shadow: none;
    }
    #level2-outro-screen .loading-text {
        color: white; font-size: 1.5rem; margin-top: 20px;
    }
    #skip-outro-btn {
        position: absolute; top: 20px; right: 20px; padding: 8px 15px;
        background: rgba(255, 255, 255, 0.7); border: 1px solid #ccc;
        border-radius: 8px; font-size: 1rem; color: #333; cursor: pointer;
        z-index: 2001; transition: background 0.2s, transform 0.2s;
    }
    #skip-outro-btn:hover { background: rgba(255, 255, 255, 0.9); transform: scale(1.05); }
    @media (max-width: 500px) {
      #card-stack-area, #temp-area, #tools-bar, #code-bar { width: 98vw; }
      #tools-bar button {
          min-width: unset; width: 30%; margin-bottom: 8px;
          padding: 8px 10px; font-size: 0.95rem;
      }
      #tools-bar { gap: 6px; }
      #temp-area { width: 98vw; margin: 15px auto 0 auto; }
      #code-bar input { width: 50%; }
      #display-area { width: 96vw; padding: 5px; }
      #level-finish, #game-over {
        font-size: 1.2rem; padding: 20px; box-sizing: border-box;
      }
      #level-finish button, #game-over button, #retry-btn {
          font-size: 1rem; padding: 10px 20px;
      }
      #level-finish-text { font-size: 1em; }
    }
  </style>
</head>
<body>
<div id="game-container">
  <div id="loading-screen">
    <div class="loading-content">
      <h1 class="loading-title">Loading.</h1>
      <div class="progress-bar-container">
        <div id="progress-bar"></div>
      </div>
      <p id="loading-text">æ­£åœ¨åŠ è½½èµ„æº...</p>
      <small class="loading-footer">å–µäº†ä¸ªå–µ &copy; 2025 | Designed by å¼€å…ƒ</small>
    </div>
  </div>

  <div id="header-bar" style="display:none;">
    <div id="progress-info">
        <span id="level-info">å…³å¡: 1 / 2</span>
        <span class="score-display">åˆ†æ•°: <span id="current-score">0</span></span>
        <span class="target-display">ç›®æ ‡: <span id="target-score">0</span></span>
    </div>
    <button id="music-toggle" title="éŸ³ä¹å¼€å…³">ğŸ¼</button>
  </div>
  <div id="main-area" style="display:none;">
    <div id="display-area"></div>
    <div id="curtain"></div>
    <div id="cat-path">
        <div id="walking-cat">ğŸˆ</div>
    </div>
    <div id="card-stack-area"></div>
    <div id="wiggling-cat-1" class="wiggling-cat-instance">ğŸ¥³</div>
    <div id="wiggling-cat-4" class="wiggling-cat-instance">ğŸ‰</div>
    <div id="wiggling-cat-7" class="wiggling-cat-instance">ğŸ»</div>

    <div id="temp-area">
      <div class="temp-slot"></div>
      <div class="temp-slot"></div>
      <div class="temp-slot"></div>
      <div class="temp-slot"></div>
      <div class="temp-slot"></div>
      <div class="temp-slot"></div>
      <div class="temp-slot"></div>
    </div>
    <div id="tools-bar">
      <button id="undo-btn" disabled title="æ’¤é”€(éœ€å…‘æ¢ç )">â†©ï¸ æ’¤é”€ (<span id="undo-count">0</span>)</button>
      <button id="hint-btn" disabled title="æç¤º(éœ€å…‘æ¢ç )">ğŸ’¡ æç¤º (<span id="hint-count">0</span>)</button>
      <button id="shuffle-btn" disabled title="æ´—ç‰Œ(éœ€å…‘æ¢ç )">ğŸ”€ æ´—ç‰Œ (<span id="shuffle-count">0</span>)</button>
      <button id="restart-btn" title="é‡æ–°å¼€å§‹å½“å‰å…³å¡">ğŸ”„ é‡æ–°å¼€å§‹</button>
    </div>
    <div id="code-bar">
      <input type="text" id="code-input" placeholder="å…‘æ¢ç " maxlength="12">
      <button id="code-btn">å…‘æ¢</button>
    </div>
    <div id="message-bar"></div>
  </div>
  <div id="footer" style="display:none;">
    å–µäº†ä¸ªå–µ &copy; 2025 | Designed by å¼€å…ƒ
  </div>

  <div id="event-overlay">
      <div id="event-message-box">
          <div class="event-icon"></div>
          <p class="event-text"></p>
      </div>
  </div>

  <div id="start-screen" style="display:none;">
    <video id="start-screen-video" autoplay loop muted playsinline>
      <source src="mao.webm" type="video/webm">
      <source src="mao.mp4" type="video/mp4">
      <img src="mao.webp" alt="èƒŒæ™¯å›¾">
    </video>
    <h1><span>å–µ</span><span>äº†</span><span>ä¸ª</span><span>å–µ</span><span> ğŸ¾</span></h1>
    <p> </p> <p>
      <button class="start-btn" id="start-btn">å¼€å§‹æ¸¸æˆ</button>
    </p>
    <p>æ”¶é›†å¡ç‰Œè·å¾—åˆ†æ•°ã€å…¨éƒ¨æ¸…ç©ºè¿‡å…³<br>
    <span style="color:#c0392b;">ç¬¬äºŒå…³éš¾åº¦ç•¥æœ‰å‡çº§<br></span>å¯ä½¿ç”¨å…‘æ¢ç è§£é”é“å…·</p>
    <small class="loading-footer">å–µäº†ä¸ªå–µ &copy; 2025 | Designed by å¼€å…ƒ</small>
  </div>

  <div id="level2-outro-screen" style="display:none;">
    <video id="outro-video" playsinline muted>
        <source src="mao2.mp4" type="video/mp4">
        æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾ã€‚
    </video>
    <img id="outro-image" src="mao2.webp" alt="Level 2 Outro Image" style="display:none;">
    <div class="loading-text" style="display:none;">æ­£åœ¨åŠ è½½...</div>
    <button id="skip-outro-btn" style="display:none;">è·³è¿‡åŠ¨ç”»</button>
  </div>

  <div id="level-finish" style="display:none;">
    <div id="netease-player" class="responsive-video-container" style="display:none;">
      <iframe allow="encrypted-media *; fullscreen *; clipboard-write" frameborder="0" height="450" style="width:100%;max-width:660px;overflow:hidden;border-radius:10px;" sandbox="allow-forms allow-popups allow-same-origin allow-scripts allow-storage-access-by-user-activation allow-top-navigation-by-user-activation" src="https://player.bilibili.com/player.html?isOutside=true&aid=114878413148199&bvid=BV1X9uQz6E6v&cid=31143166462&p=1"></iframe>
    </div>
    <div id="player" style="display:none;">
        <div id="player-content1">
            <div class="music-name"></div>
            <div class="artist-name"></div>
            <div class="time">
                <div class="current-time"></div>
                <div class="total-time"></div>
            </div>
            <div id="s-area">
                <div id="ins-time"></div>
                <div id="s-hover"></div>
                <div id="seek-bar"></div>
            </div>
        </div>
        <div id="player-content2">
            <div class="music-imgs">
                <div class="img"></div>
                <div id="buffer-box">ç¼“å†²,ç¨ç­‰...</div>
            </div>
            <div class="player-controls">
                <div class="btn prev iconfont">î˜ƒ</div>
                <div class="btn play-pause icon-jiediankaishi iconfont"></div>
                <div class="btn next iconfont">î˜‚</div>
            </div>
        </div>
    </div>
    <div id="level-finish-text"></div>
    <button id="next-btn">ä¸‹ä¸€å…³</button>
    <button id="retry-btn" style="margin-left:10px;">é‡ç©</button>
    <button id="gobang-btn" style="margin-left:10px; display:none;">äº”å­æ£‹å¯¹å¼ˆ</button>
    <button id="restart-game-btn" style="margin-left:10px; display:none;">é‡å¼€æ¸¸æˆ</button>
    <button id="close-game-btn-level" style="margin-left:10px;">å…³é—­æ¸¸æˆ</button>
  </div>

  <div id="game-over" style="display:none;">
    <div class="cloud-layer"></div>
    <div id="game-over-content">
        <div id="game-over-text"></div>
        <button id="retry-btn2">é‡è¯•</button>
        <button id="close-game-btn-gameover" style="margin-left:10px;">å…³é—­æ¸¸æˆ</button>
    </div>
  </div>
</div>

<div id="confirm-modal" class="modal-overlay">
  <div class="modal-content">
    <p id="confirm-msg">ä½ ç¡®å®šå—ï¼Ÿ</p>
    <div class="modal-buttons">
        <button id="confirm-yes">ç¡®å®š</button>
        <button id="confirm-no">å–æ¶ˆ</button>
    </div>
  </div>
</div>

<!-- ä¼˜åŒ–ç‚¹: audio æ ‡ç­¾çš„ preload="auto" å…è®¸æµè§ˆå™¨è‡ªè¡Œå†³å®šåŠ è½½æ—¶æœºï¼Œä¸ä¼šé˜»å¡é¡µé¢æ¸²æŸ“ -->
<audio id="bgm" loop preload="auto">
  <source src="Get.mp3" type="audio/mpeg">
  <source src="Get.ogg" type="audio/ogg">
  æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘å…ƒç´ ã€‚
</audio>

<!-- ä¼˜åŒ–ç‚¹: è„šæœ¬æ”¾åœ¨ body å°¾éƒ¨ï¼Œé˜²æ­¢é˜»å¡æ¸²æŸ“ -->
<script src="js/jquery-3.4.1.min.js"></script>
<!-- <script src="js/index.js"></script> -->

<script>
// ä¸ºäº†æ–¹ä¾¿æ¼”ç¤ºå’Œä¿®æ”¹ï¼Œè¿™é‡Œå°† index.js çš„å†…å®¹ç›´æ¥æ”¾å…¥ã€‚å®é™…éƒ¨ç½²æ—¶å¯ä»¥ä¿æŒä¸ºå¤–éƒ¨æ–‡ä»¶ã€‚
// ======================= START OF GAME LOGIC (index.js) =======================
$(function(){
    var playerContent1 = $('#player-content1');// æ­Œæ›²ä¿¡æ¯æ¨¡å—éƒ¨åˆ†domå…ƒç´ 
    var musicName = $('.music-name');          // æ­Œæ›²åéƒ¨åˆ†domå…ƒç´  
    var artistName = $('.artist-name');        // æ­Œæ‰‹åéƒ¨åˆ†domå…ƒç´ 
    
    var musicImgs = $('.music-imgs');          // å·¦ä¾§å°é¢å›¾domå…ƒç´ 
  
    var playPauseBtn = $('.play-pause');       // æ’­æ”¾/æš‚åœæŒ‰é’® domå…ƒç´ 
    var playPrevBtn = $('.prev');              // ä¸Šä¸€é¦–æŒ‰é’® domå…ƒç´ 
    var playNextBtn = $('.next')               // ä¸‹ä¸€é¦–æŒ‰é’® domå…ƒç´ 
    
    var time = $('.time');                     // æ—¶é—´ä¿¡æ¯éƒ¨åˆ† domå…ƒç´ 
    var tProgress = $('.current-time');        // å½“å‰æ’­æ”¾æ—¶é—´æ–‡æœ¬éƒ¨åˆ† domå…ƒç´ 
    var totalTime = $('.total-time');          // æ­Œæ›²æ€»æ—¶é•¿æ–‡æœ¬éƒ¨åˆ† domå…ƒç´ 
    
    var sArea = $('#s-area');                  // è¿›åº¦æ¡éƒ¨åˆ†
    var insTime = $('#ins-time');              // é¼ æ ‡ç§»åŠ¨è‡³è¿›åº¦æ¡ä¸Šé¢ï¼Œæ˜¾ç¤ºçš„ä¿¡æ¯éƒ¨åˆ†
    var sHover = $('#s-hover');                // é¼ æ ‡ç§»åŠ¨è‡³è¿›åº¦æ¡ä¸Šé¢ï¼Œå‰é¢å˜æš—çš„è¿›åº¦æ¡éƒ¨åˆ†
    var seekBar = $('#seek-bar');              // æ’­æ”¾è¿›åº¦æ¡éƒ¨åˆ†
    
    // ä¸€äº›è®¡ç®—æ‰€éœ€çš„å˜é‡
    var seekT, seekLoc, seekBarPos, cM, ctMinutes, ctSeconds, curMinutes, curSeconds, durMinutes, durSeconds, playProgress, bTime, nTime = 0
    var musicImgsData = ['img/bg.webp','img/bg1.webp','img/bg2.webp','img/null.webp','img/null.webp','img/null.webp','img/null.webp','img/null.webp','img/null.webp','img/null.webp','img/null.webp','img/null.webp','img/null.webp','img/null.webp','img/null.webp','img/null.webp','img/null.webp','img/null.webp','img/null.webp','img/null.webp','img/null.webp','img/null.webp','img/null.webp','img/null.webp','img/null.webp','img/null.webp']    // å›¾ç‰‡åœ°å€æ•°ç»„
    var musicNameData = ['ç¨»é¦™','Symphony','Mood (Lofi)','ä¸€æ— æ‰€æœ‰+Mood','Dream It Possible','Fractures','Fadeï¼ˆbass+drumï¼‰','è‡´ä½ ','å¹´è½®','2018å°æ‹æ›²','ä½ æ˜¯æˆ‘çš„å¥³æœ‹å‹','å¾®å¾®','çˆ±å°±ä¸€ä¸ªå­—','ç‹æ‹›å›','è½åœ¨ç”Ÿå‘½é‡Œçš„å…‰','å¤§å¤©è“¬','é’ä¸','ç¬¬äºŒæ¯åŠä»·','Waiting For Love','ç»™ä½ å‘€','é˜¿æ‹‰æ–¯åŠ æµ·æ¹¾','ä¸²çƒ§','è¾ä¹é—¨å›å¿†','ä¸€è·¯ç”ŸèŠ±','åœˆä½ä½ ','çˆ±/å­˜åœ¨'];                   // æ­Œæ›²åæ•°ç»„
    var artistNameData = ['å‘¨æ°ä¼¦','One Voice/Rob Landes','Hloshit','é©¬æ€å”¯','Delacey','ILLENIUM','Phil','yihuikè‹¡æ…§','ä¸æ˜¯èŠ±ç«å‘€','ä¸«è›‹è›‹/æ²ˆè™«è™«','ä½™ç”Ÿå“¥å“¥','å‚…å¦‚ä¹”','å‚²ä¸ƒçˆ·','æˆè¹Š','æ±ªç‚æ¥ ','æ¸…æ°´er','ç­‰ä»€ä¹ˆå›','çº³è±†nado','è«å®/å—æŸ¯ä¸€æ¢¦','è’‹å°å‘¢','è“å¿ƒç¾½','è®¸å¤©æ˜±/é™ˆæ—­è¾‰','èµµæ¢“å©·','è½¶å¿ƒ','é˜¿å…®åŒå­¦','é­å¥‡å¥‡']            // åˆ›ä½œæ­Œæ‰‹æ•°ç»„
    var musicUrls=['mp3/music1.mp3','mp3/music2.mp3','mp3/music3.mp3','mp3/4.mp3','mp3/5.mp3','mp3/6.mp3','mp3/7.mp3','mp3/8.mp3','mp3/9.mp3','mp3/10.mp3','mp3/11.mp3','mp3/12.mp3','mp3/13.mp3','mp3/14.mp3','mp3/15.mp3','mp3/16.mp3','mp3/17.mp3','mp3/18.mp3','mp3/19.mp3','mp3/20.mp3','mp3/21.mp3','mp3/22.mp3','mp3/23.mp3','mp3/24.mp3','mp3/25.mp3','mp3/26.mp3'];// æ­Œæ›²mp3æ•°ç»„
    var currIndex = -1;              // å½“å‰æ’­æ”¾ç´¢å¼•
    
    var buffInterval = null          // åˆå§‹åŒ–å®šæ—¶å™¨ åˆ¤æ–­æ˜¯å¦éœ€è¦ç¼“å†²
    var len = musicNameData.length;  // æ­Œæ›²é•¿åº¦
 

    // ç‚¹å‡» æ’­æ”¾/æš‚åœ æŒ‰é’®ï¼Œè§¦å‘è¯¥å‡½æ•°
    // ä½œç”¨ï¼šæ ¹æ®audioçš„pausedå±æ€§ æ¥æ£€æµ‹å½“å‰éŸ³é¢‘æ˜¯å¦å·²æš‚åœ  true:æš‚åœ  false:æ’­æ”¾ä¸­
    function playPause(){
        if(audio.paused){
            playerContent1.addClass('active'); // å†…å®¹æ ä¸Šç§»
            musicImgs.addClass('active');      // å·¦ä¾§å›¾ç‰‡å¼€å§‹åŠ¨ç”»æ•ˆæœ
            playPauseBtn.attr('class','btn play-pause icon-zanting iconfont') // æ˜¾ç¤ºæš‚åœå›¾æ ‡
            checkBuffering(); // æ£€æµ‹æ˜¯å¦éœ€è¦ç¼“å†²
            audio.play();     // æ’­æ”¾
        }else{
            playerContent1.removeClass('active'); // å†…å®¹æ ä¸‹ç§»
            musicImgs.removeClass('active');      // å·¦ä¾§å›¾ç‰‡åœæ­¢æ—‹è½¬ç­‰åŠ¨ç”»æ•ˆæœ
            playPauseBtn.attr('class','btn play-pause icon-jiediankaishi iconfont'); // æ˜¾ç¤ºæ’­æ”¾æŒ‰é’®
            clearInterval(buffInterval);          // æ¸…é™¤æ£€æµ‹æ˜¯å¦éœ€è¦ç¼“å†²çš„å®šæ—¶å™¨
            musicImgs.removeClass('buffering');    // ç§»é™¤ç¼“å†²ç±»å
            audio.pause(); // æš‚åœ
        }  
    }
function stopPlayer() {
    if (!audio.paused) { // ä»…å½“éŸ³é¢‘æ­£åœ¨æ’­æ”¾æ—¶æ‰æ‰§è¡Œæš‚åœæ“ä½œ
        audio.pause(); // æš‚åœéŸ³é¢‘
        playerContent1.removeClass('active'); // ç§»é™¤å†…å®¹æ çš„æ¿€æ´»çŠ¶æ€ï¼Œä½¿å…¶ä¸‹ç§»
        musicImgs.removeClass('active'); // ç§»é™¤å°é¢å›¾çš„æ¿€æ´»çŠ¶æ€ï¼Œåœæ­¢åŠ¨ç”»
        playPauseBtn.attr('class','btn play-pause icon-jiediankaishi iconfont'); // å°†æ’­æ”¾/æš‚åœæŒ‰é’®è®¾ç½®ä¸ºæ’­æ”¾å›¾æ ‡
        clearInterval(buffInterval); // æ¸…é™¤ç¼“å†²æ£€æµ‹å®šæ—¶å™¨
        musicImgs.removeClass('buffering'); // ç§»é™¤ç¼“å†²åŠ¨ç”»ç±»å
    }
}

    // é¼ æ ‡ç§»åŠ¨åœ¨è¿›åº¦æ¡ä¸Šï¼Œ è§¦å‘è¯¥å‡½æ•°	
	function showHover(event){
		seekBarPos = sArea.offset();    // è·å–è¿›åº¦æ¡é•¿åº¦
		seekT = event.clientX - seekBarPos.left;  //è·å–å½“å‰é¼ æ ‡åœ¨è¿›åº¦æ¡ä¸Šçš„ä½ç½®
		seekLoc = audio.duration * (seekT / sArea.outerWidth()); //å½“å‰é¼ æ ‡ä½ç½®çš„éŸ³é¢‘æ’­æ”¾ç§’æ•°ï¼š éŸ³é¢‘é•¿åº¦(å•ä½ï¼šs)*ï¼ˆé¼ æ ‡åœ¨è¿›åº¦æ¡ä¸Šçš„ä½ç½®/è¿›åº¦æ¡çš„å®½åº¦ï¼‰
		
		sHover.width(seekT);  //è®¾ç½®é¼ æ ‡ç§»åŠ¨åˆ°è¿›åº¦æ¡ä¸Šå˜æš—çš„éƒ¨åˆ†å®½åº¦
		
		cM = seekLoc / 60;    // è®¡ç®—æ’­æ”¾äº†å¤šå°‘åˆ†é’Ÿï¼š éŸ³é¢‘æ’­æ”¾ç§’é€Ÿ/60
		
		ctMinutes = Math.floor(cM);  // å‘ä¸‹å–æ•´
		ctSeconds = Math.floor(seekLoc - ctMinutes * 60); // è®¡ç®—æ’­æ”¾ç§’æ•°
		
		if( (ctMinutes < 0) || (ctSeconds < 0) )
			return;
		
        if( (ctMinutes < 0) || (ctSeconds < 0) )
			return;
		
		if(ctMinutes < 10)
			ctMinutes = '0'+ctMinutes;
		if(ctSeconds < 10)
			ctSeconds = '0'+ctSeconds;
        
        if( isNaN(ctMinutes) || isNaN(ctSeconds) )
            insTime.text('--:--');
        else
		    insTime.text(ctMinutes+':'+ctSeconds);  // è®¾ç½®é¼ æ ‡ç§»åŠ¨åˆ°è¿›åº¦æ¡ä¸Šæ˜¾ç¤ºçš„ä¿¡æ¯
            
		insTime.css({'left':seekT,'margin-left':'-21px'}).fadeIn(0);  // æ·¡å…¥æ•ˆæœæ˜¾ç¤º
		
	}

    // é¼ æ ‡ç§»å‡ºè¿›åº¦æ¡ï¼Œè§¦å‘è¯¥å‡½æ•°
    function hideHover()
	{
        sHover.width(0);  // è®¾ç½®é¼ æ ‡ç§»åŠ¨åˆ°è¿›åº¦æ¡ä¸Šå˜æš—çš„éƒ¨åˆ†å®½åº¦ é‡ç½®ä¸º0
        insTime.text('00:00').css({'left':'0px','margin-left':'0px'}).fadeOut(0); // æ·¡å‡ºæ•ˆæœæ˜¾ç¤º
    }

    // é¼ æ ‡ç‚¹å‡»è¿›åº¦æ¡ï¼Œè§¦å‘è¯¥å‡½æ•°
    function playFromClickedPos()
    {
        audio.currentTime = seekLoc; // è®¾ç½®éŸ³é¢‘æ’­æ”¾æ—¶é—´ ä¸ºå½“å‰é¼ æ ‡ç‚¹å‡»çš„ä½ç½®æ—¶é—´
		seekBar.width(seekT);        // è®¾ç½®è¿›åº¦æ¡æ’­æ”¾é•¿åº¦ï¼Œä¸ºå½“å‰é¼ æ ‡ç‚¹å‡»çš„é•¿åº¦
		hideHover();                 // è°ƒç”¨è¯¥å‡½æ•°ï¼Œéšè—åŸæ¥é¼ æ ‡ç§»åŠ¨åˆ°ä¸Šæ–¹è§¦å‘çš„è¿›åº¦æ¡é˜´å½±
    }

    // åœ¨éŸ³é¢‘çš„æ’­æ”¾ä½ç½®å‘ç”Ÿæ”¹å˜æ˜¯è§¦å‘è¯¥å‡½æ•°
    function updateCurrTime()
	{
        nTime = new Date();      // è·å–å½“å‰æ—¶é—´
        nTime = nTime.getTime(); // å°†è¯¥æ—¶é—´è½¬åŒ–ä¸ºæ¯«ç§’æ•°

        // è®¡ç®—å½“å‰éŸ³é¢‘æ’­æ”¾çš„æ—¶é—´
		curMinutes = Math.floor(audio.currentTime  / 60);
        curSeconds = Math.floor(audio.currentTime  - curMinutes * 60);
        
		// è®¡ç®—å½“å‰éŸ³é¢‘æ€»æ—¶é—´
		durMinutes = Math.floor(audio.duration / 60);
        durSeconds = Math.floor(audio.duration - durMinutes * 60);
        
		// è®¡ç®—æ’­æ”¾è¿›åº¦ç™¾åˆ†æ¯”
		playProgress = (audio.currentTime  / audio.duration) * 100;
        
        // å¦‚æœæ—¶é—´ä¸ºä¸ªä½æ•°ï¼Œè®¾ç½®å…¶æ ¼å¼
		if(curMinutes < 10)
			curMinutes = '0'+curMinutes;
		if(curSeconds < 10)
			curSeconds = '0'+curSeconds;
		
		if(durMinutes < 10)
			durMinutes = '0'+durMinutes;
		if(durSeconds < 10)
			durSeconds = '0'+durSeconds;
        
        if( isNaN(curMinutes) || isNaN(curSeconds) )
            tProgress.text('00:00');
        else
            tProgress.text(curMinutes+':'+curSeconds);
        
        if( isNaN(durMinutes) || isNaN(durSeconds) )
            totalTime.text('00:00');
        else
		    totalTime.text(durMinutes+':'+durSeconds);
        
        if( isNaN(curMinutes) || isNaN(curSeconds) || isNaN(durMinutes) || isNaN(durSeconds) )
            time.removeClass('active');
        else
            time.addClass('active');

        // è®¾ç½®æ’­æ”¾è¿›åº¦æ¡çš„é•¿åº¦
		seekBar.width(playProgress+'%');
        
        // è¿›åº¦æ¡ä¸º100 å³æ­Œæ›²æ’­æ”¾å®Œæ—¶
		if( playProgress == 100 )
		{
            playPauseBtn.attr('class','btn play-pause icon-jiediankaishi iconfont'); // æ˜¾ç¤ºæ’­æ”¾æŒ‰é’®
			seekBar.width(0);              // æ’­æ”¾è¿›åº¦æ¡é‡ç½®ä¸º0
            tProgress.text('00:00');       // æ’­æ”¾æ—¶é—´é‡ç½®ä¸º 00:00
            musicImgs.removeClass('buffering').removeClass('active');  // ç§»é™¤ç›¸å…³ç±»å
            clearInterval(buffInterval);   // æ¸…é™¤å®šæ—¶å™¨

            selectTrack(1);  // æ·»åŠ è¿™ä¸€å¥ï¼Œå¯ä»¥å®ç°è‡ªåŠ¨æ’­æ”¾
		}
    }

    // å®šæ—¶å™¨æ£€æµ‹æ˜¯å¦éœ€è¦ç¼“å†²
    function checkBuffering(){
        clearInterval(buffInterval);
        buffInterval = setInterval(function()
        { 
            // è¿™é‡Œå¦‚æœéŸ³é¢‘æ’­æ”¾äº†ï¼Œåˆ™nTimeä¸ºå½“å‰æ—¶é—´æ¯«ç§’æ•°ï¼Œå¦‚æœæ²¡æ’­æ”¾åˆ™ä¸º0ï¼›å¦‚æœæ—¶é—´é—´éš”è¿‡é•¿ï¼Œä¹Ÿå°†ç¼“å­˜
            if( (nTime == 0) || (bTime - nTime) > 1000  ){ 
                musicImgs.addClass('buffering');  // æ·»åŠ ç¼“å­˜æ ·å¼ç±»
            } else{
                musicImgs.removeClass('buffering'); // ç§»é™¤ç¼“å­˜æ ·å¼ç±»
            }
                
            bTime = new Date();
            bTime = bTime.getTime();

        },100);
    }
   
    // ç‚¹å‡»ä¸Šä¸€é¦–/ä¸‹ä¸€é¦–æ—¶ï¼Œè§¦å‘è¯¥å‡½æ•°ã€‚ 
    //æ³¨æ„ï¼šåé¢ä»£ç åˆå§‹åŒ–æ—¶ï¼Œä¼šè§¦å‘ä¸€æ¬¡selectTrack(0)ï¼Œå› æ­¤ä¸‹é¢ä¸€äº›åœ°æ–¹éœ€è¦åˆ¤æ–­flagæ˜¯å¦ä¸º0
    function selectTrack(flag){
        if( flag == 0 || flag == 1 ){  // åˆå§‹ || ç‚¹å‡»ä¸‹ä¸€é¦–
            ++ currIndex;
            if(currIndex >=len){      // å½“å¤„äºæœ€åä¸€é¦–æ—¶ï¼Œç‚¹å‡»ä¸‹ä¸€é¦–ï¼Œæ’­æ”¾ç´¢å¼•ç½®ä¸ºç¬¬ä¸€é¦–
                currIndex = 0;
            }
        }else{                    // ç‚¹å‡»ä¸Šä¸€é¦–
            --currIndex;
            if(currIndex<=-1){    // å½“å¤„äºç¬¬ä¸€é¦–æ—¶ï¼Œç‚¹å‡»ä¸Šä¸€é¦–ï¼Œæ’­æ”¾ç´¢å¼•ç½®ä¸ºæœ€åä¸€é¦–
                currIndex = len-1;
            }
        }

        if( flag == 0 ){
            playPauseBtn.attr('class','btn play-pause icon-jiediankaishi iconfont'); // æ˜¾ç¤ºæ’­æ”¾å›¾æ ‡
        }else{
            musicImgs.removeClass('buffering');   
            playPauseBtn.attr('class','btn play-pause icon-zanting iconfont') // æ˜¾ç¤ºæš‚åœå›¾æ ‡
        }

        seekBar.width(0);           // é‡ç½®æ’­æ”¾è¿›åº¦æ¡ä¸º0
        time.removeClass('active');
        tProgress.text('00:00');    // æ’­æ”¾æ—¶é—´é‡ç½®
        totalTime.text('00:00');    // æ€»æ—¶é—´é‡ç½®

        // è·å–å½“å‰ç´¢å¼•çš„:æ­Œæ›²åï¼Œæ­Œæ‰‹åï¼Œå›¾ç‰‡ï¼Œæ­Œæ›²é“¾æ¥ç­‰ä¿¡æ¯
        currMusic = musicNameData[currIndex];
        currArtist = artistNameData[currIndex];
        currImg = musicImgsData[currIndex];
        audio.src = musicUrls[currIndex];
        
        nTime = 0;
        bTime = new Date();
        bTime = bTime.getTime();

        // å¦‚æœç‚¹å‡»çš„æ˜¯ä¸Šä¸€é¦–/ä¸‹ä¸€é¦– åˆ™è®¾ç½®å¼€å§‹æ’­æ”¾ï¼Œæ·»åŠ ç›¸å…³ç±»åï¼Œé‡æ–°å¼€å¯å®šæ—¶å™¨
        if(flag != 0){
            audio.play();
            playerContent1.addClass('active');
            musicImgs.addClass('active');
        
            clearInterval(buffInterval);
            checkBuffering();
        }

        // å°†æ­Œæ‰‹åï¼Œæ­Œæ›²åï¼Œå›¾ç‰‡é“¾æ¥ï¼Œè®¾ç½®åˆ°å…ƒç´ ä¸Š
        artistName.text(currArtist);
        musicName.text(currMusic);
        musicImgs.find('.img').css({'background':'url('+currImg+')'})
        
    }


    // åˆå§‹åŒ–å‡½æ•°
    function initPlayer() {
        audio = new Audio();  // åˆ›å»ºAudioå¯¹è±¡
		selectTrack(0);       // åˆå§‹åŒ–ç¬¬ä¸€é¦–æ­Œæ›²çš„ç›¸å…³ä¿¡æ¯
		audio.loop = false;   // å–æ¶ˆæ­Œæ›²çš„å¾ªç¯æ’­æ”¾åŠŸèƒ½
		
        playPauseBtn.on('click',playPause); // ç‚¹å‡»æ’­æ”¾/æš‚åœ æŒ‰é’®ï¼Œè§¦å‘playPauseå‡½æ•°
        
		// è¿›åº¦æ¡ ç§»å…¥/ç§»å‡º/ç‚¹å‡» åŠ¨ä½œè§¦å‘ç›¸åº”å‡½æ•°
		sArea.mousemove(function(event){ showHover(event); }); 
        sArea.mouseout(hideHover);
        sArea.on('click',playFromClickedPos);
        
        // å®æ—¶æ›´æ–°æ’­æ”¾æ—¶é—´
        $(audio).on('timeupdate',updateCurrTime); 
 $('#retry-btn').on('click', function() {
        stopPlayer(); // æš‚åœæ’­æ”¾å™¨
        // è¿™é‡Œæ·»åŠ æ‚¨æ¸¸æˆåŸæœ‰çš„â€œé‡æ–°å¼€å§‹â€é€»è¾‘
        // ä¾‹å¦‚ï¼šresetGame(); æˆ– window.location.reload();
    });
   

    // ç›‘å¬é€šå…³ç•Œé¢çš„é€šç”¨æŒ‰é’®ç‚¹å‡»äº‹ä»¶
    // ç”±äºæ‚¨çš„HTMLä¸­#level-finishä¸‹çš„æŒ‰é’®æ²¡æœ‰å…·ä½“IDï¼Œå¯ä»¥ç›‘å¬æ‰€æœ‰æŒ‰é’®
    // æ‚¨å¯èƒ½éœ€è¦æ ¹æ®æŒ‰é’®çš„æ–‡æœ¬å†…å®¹æˆ–è€…å…¶ä»–å±æ€§æ¥åŒºåˆ†â€œä¸‹ä¸€å…³â€æŒ‰é’®
    $('#level-finish button').on('click', function() {
        // æ‚¨å¯èƒ½éœ€è¦åœ¨è¿™é‡Œåˆ¤æ–­ç‚¹å‡»çš„æ˜¯å“ªä¸ªæŒ‰é’® (ä¾‹å¦‚ï¼Œé€šè¿‡æŒ‰é’®çš„æ–‡æœ¬æˆ–class)
        // å‡è®¾â€œä¸‹ä¸€å…³â€æŒ‰é’®çš„æ–‡æœ¬æ˜¯â€œä¸‹ä¸€å…³â€
        if ($(this).text().includes('ä¸‹ä¸€å…³')) {
            stopPlayer(); // æš‚åœæ’­æ”¾å™¨
            // è¿™é‡Œæ·»åŠ æ‚¨æ¸¸æˆåŸæœ‰çš„â€œä¸‹ä¸€å…³â€é€»è¾‘
            // ä¾‹å¦‚ï¼šloadNextLevel();
        } else if ($(this).text().includes('é‡æ–°å¼€å§‹')) {
            stopPlayer(); // æš‚åœæ’­æ”¾å™¨
            // è¿™é‡Œæ·»åŠ æ‚¨æ¸¸æˆåŸæœ‰çš„â€œé‡æ–°å¼€å§‹â€é€»è¾‘
        }
    });
   
    
    // å¦‚æœâ€œæ¸¸æˆç»“æŸâ€ç•Œé¢ä¹Ÿæœ‰â€œé‡æ–°å¼€å§‹â€æŒ‰é’®ï¼Œä¹Ÿéœ€è¦å¤„ç†
    $('#game-over button').on('click', function() {
        if ($(this).text().includes('é‡æ–°å¼€å§‹')) { // æˆ–è€…å…¶ä»–è¯†åˆ«æ–¹å¼
            stopPlayer(); // æš‚åœæ’­æ”¾å™¨
            // è¿™é‡Œæ·»åŠ æ¸¸æˆç»“æŸåçš„â€œé‡æ–°å¼€å§‹â€é€»è¾‘
        }
    });

        // ä¸Šä¸‹é¦–åˆ‡æ¢
        playPrevBtn.on('click',function(){ selectTrack(-1);} );
        playNextBtn.on('click',function(){ selectTrack(1);});
    }

    // è°ƒç”¨åˆå§‹åŒ–å‡½æ•°
    initPlayer();

});

// Game configuration constants
const CARD_ICONS = [
  "ğŸˆ", "ğŸ’", "ğŸª¼", "ğŸ‘’", "ğŸµï¸", "ğŸ§¸", "ğŸ¬", "ğŸ”®", "ğŸ¡", "ğŸˆâ€â¬›", "ğŸ«", "ğŸª­",
  "ğŸ–", "ğŸ§¶", "ğŸŒ»", "ğŸ¦‹", "ğŸ’", "ğŸŒˆ", "ğŸ‚"
];
const LEVELS = [
  {num: 1, visible: 20, total: 27, stack: 2, rows: 3, cols: 5, overlap: 24, targetScore: 30, totalDisplaySets: 9},
  {num: 2, visible: 18, total: 168, stack: 3, rows: 7, cols: 8, overlap: 24, targetScore: 150, totalDisplaySets: 25}
];
const TEMP_LIMIT = 7;
const DISPLAY_CARD_MATCH_SCORE = 5;
const INITIAL_DISPLAY_SETS_VISIBLE = 2;

const REDEMPTION_CODES = {
  "kaiyuan": { undo: 20, hint: 20, shuffle: 20 },
  "å…‘æ¢ç ": { undo: 5, hint: 5, shuffle: 5 },
  "å–µäº†ä¸ªå–µ": { undo: 50, hint: 50, shuffle: 50 },
  "ä¸çŸ¥é“": { undo: 3, hint: 1, shuffle: 1 },
  "å¼€å…ƒ": { undo: 10, hint: 10, shuffle: 10 },
  "é€šå…³": { type: "skip_level" },
  "xianshi": { type: "curtain_off" }
};

// DOM Elements
const bgm = document.getElementById('bgm');
const confirmModal = document.getElementById('confirm-modal');
const confirmMsg = document.getElementById('confirm-msg');
const confirmYes = document.getElementById('confirm-yes');
const confirmNo = document.getElementById('confirm-no');
const footer = document.getElementById('footer');
const musicToggleBtn = document.getElementById('music-toggle');
const startBtn = document.getElementById('start-btn');
const nextBtn = document.getElementById('next-btn');
const retryBtnLevelFinish = document.getElementById('retry-btn');
const retryBtnGameOver = document.getElementById('retry-btn2');
const gobangBtn = document.getElementById('gobang-btn');
const restartGameBtn = document.getElementById('restart-game-btn');
const closeGameBtnLevel = document.getElementById('close-game-btn-level');
const closeGameBtnGameOver = document.getElementById('close-game-btn-gameover');
const undoBtn = document.getElementById('undo-btn');
const hintBtn = document.getElementById('hint-btn');
const shuffleBtn = document.getElementById('shuffle-btn');
const restartCurrentLevelBtn = document.getElementById('restart-btn');
const codeInput = document.getElementById('code-input');
const codeBtn = document.getElementById('code-btn');
const levelFinishTextElement = document.getElementById('level-finish-text');
const neteasePlayerDiv = document.getElementById('netease-player');
const playerDiv = document.getElementById('player');
const currentScoreElement = document.getElementById('current-score');
const targetScoreElement = document.getElementById('target-score');
const levelInfoElement = document.getElementById('level-info');
const displayArea = document.getElementById('display-area');
const cardStackArea = document.getElementById('card-stack-area');
const catPath = document.getElementById('cat-path');
const walkingCat = document.getElementById('walking-cat');
const curtainElement = document.getElementById('curtain');

const wigglingCat1 = document.getElementById('wiggling-cat-1');
const wigglingCat4 = document.getElementById('wiggling-cat-4');
const wigglingCat7 = document.getElementById('wiggling-cat-7');

const level2OutroScreen = document.getElementById('level2-outro-screen');
const outroVideo = document.getElementById('outro-video');
const outroImage = document.getElementById('outro-image');
const outroLoadingText = level2OutroScreen.querySelector('.loading-text');
const skipOutroBtn = document.getElementById('skip-outro-btn');

const eventOverlay = document.getElementById('event-overlay');
const eventMessageBox = document.getElementById('event-message-box');
const eventIconEl = eventMessageBox.querySelector('.event-icon');
const eventTextEl = eventMessageBox.querySelector('.event-text');


let confirmCallback = null;
let outroVideoTimeout = null;
let isCatMirrored = true;
let randomEventTimer = null;
let curtainTimer = null;
let isLandscape = false; 
let hasShownLandscapeMessage = false;
let lastShakeTime = 0;

let audioContext;
let clickSoundBuffer;

let game = {
  level: 1,
  levelStartTime: 0,
  cards: [],
  board: [],
  temp: [],
  matched: [],
  usedIcons: [],
  toolUses: {undo: 0, hint: 0, shuffle: 0},
  score: 0,
  targetScore: 0,
  displayCards: [],
  totalDisplaySetsGenerated: 0,
  progress: 0,
  stepStack: [],
  bgmOn: true,
  isNewLevel: false,
  lock: false,
  cardDimensions: { width: 0, height: 0, fontSize: 0, borderRadius: 0, borderWidth: 0 },
  layout: { areaWidth: 0, areaHeight: 0 },
  isCurtainEnabled: true
};

// Utility Functions
function randArr(arr) { return arr.slice().sort(() => Math.random() - 0.5); }
function shuffle(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
}
function deepClone(obj) { return JSON.parse(JSON.stringify(obj)); }
function randBetween(a, b) { return a + Math.random() * (b - a); }

function playBgm(on) {
  if (!bgm) return;
  if (on) {
    const playPromise = bgm.play();
    if (playPromise !== undefined) {
      playPromise.catch(error => {
        console.error("BGM autoplay was blocked:", error);
        game.bgmOn = false;
        musicToggleBtn.innerHTML = 'ğŸ”‡';
      });
    }
  } else {
    bgm.pause();
  }
}

async function initAudio() {
    try {
        if (!audioContext) {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
        }
        if (audioContext.state === 'suspended') {
            await audioContext.resume();
        }
        if (!clickSoundBuffer) {
            // This sound is preloaded by our new loader, but we still need to decode it.
            const response = await fetch('kaa.mp3');
            const arrayBuffer = await response.arrayBuffer();
            clickSoundBuffer = await audioContext.decodeAudioData(arrayBuffer);
        }
    } catch (e) {
        console.error("Failed to initialize Web Audio:", e);
    }
}

function playClickSound() {
    if (!clickSoundBuffer || !audioContext || !game.bgmOn) return;
    try {
        const source = audioContext.createBufferSource();
        source.buffer = clickSoundBuffer;
        source.connect(audioContext.destination);
        source.start(0);
    } catch (e) {
        console.error("Failed to play click sound:", e);
    }
}

function triggerMatchFeedback() {
    if (navigator.vibrate) {
        navigator.vibrate(100);
    }
    playClickSound();
}

function showConfirm(msg, callback) {
  confirmMsg.innerHTML = msg;
  confirmCallback = callback;
  confirmModal.style.display = 'flex';
}

function hideConfirm() {
  confirmModal.style.display = 'none';
  confirmCallback = null;
}

confirmYes.onclick = () => {
  const callback = confirmCallback;
  hideConfirm();
  if (callback) {
    setTimeout(callback, 20);
  }
};
confirmNo.onclick = hideConfirm;

function generateDisplayCardSet(excludeIcons = []) {
    let chosenIcon = null;
    const visibleLayeredCards = game.board.filter(c => !c.matched && isCardClickable(c, game.board) && c.stack >= 0 && c.stack <= 3);
    const visibleLayeredIconCounts = {};
    visibleLayeredCards.forEach(c => visibleLayeredIconCounts[c.icon] = (visibleLayeredIconCounts[c.icon] || 0) + 1);
    let potentialVisibleLayeredIcons = Object.keys(visibleLayeredIconCounts).filter(icon => !excludeIcons.includes(icon) && visibleLayeredIconCounts[icon] >= 3);
    if (potentialVisibleLayeredIcons.length > 0) {
        chosenIcon = potentialVisibleLayeredIcons[Math.floor(Math.random() * potentialVisibleLayeredIcons.length)];
    } else {
        const allClickableBoardCards = game.board.filter(c => !c.matched && isCardClickable(c, game.board));
        const combinedClickableIcons = [...allClickableBoardCards.map(c => c.icon), ...game.temp.map(c => c.icon)];
        const combinedClickableIconCounts = {};
        combinedClickableIcons.forEach(icon => combinedClickableIconCounts[icon] = (combinedClickableIconCounts[icon] || 0) + 1);
        let potentialCombinedIcons = Object.keys(combinedClickableIconCounts).filter(icon => !excludeIcons.includes(icon) && combinedClickableIconCounts[icon] >= 3);
        if (potentialCombinedIcons.length > 0) {
            chosenIcon = potentialCombinedIcons[Math.floor(Math.random() * potentialCombinedIcons.length)];
        } else {
            const allIconsInGame = game.cards.map(c => c.icon);
            const allIconCounts = {};
            allIconsInGame.forEach(icon => allIconCounts[icon] = (allIconCounts[icon] || 0) + 1);
            const anyTripletIcons = Object.keys(allIconCounts).filter(icon => !excludeIcons.includes(icon) && allIconCounts[icon] >= 3);
            if (anyTripletIcons.length > 0) {
                chosenIcon = anyTripletIcons[Math.floor(Math.random() * anyTripletIcons.length)];
            } else {
                const availableIconsWithoutExclusion = allIconsInGame.filter(icon => !excludeIcons.includes(icon));
                if (availableIconsWithoutExclusion.length > 0) {
                    chosenIcon = availableIconsWithoutExclusion[Math.floor(Math.random() * availableIconsWithoutExclusion.length)];
                } else if (allIconsInGame.length > 0) {
                    chosenIcon = allIconsInGame[Math.floor(Math.random() * allIconsInGame.length)];
                } else {
                    return null;
                }
            }
        }
    }
    if (chosenIcon) {
        return [
            { icon: chosenIcon, id: Date.now() + 1 },
            { icon: chosenIcon, id: Date.now() + 2 },
            { icon: chosenIcon, id: Date.now() + 3 }
        ];
    } else {
        return null;
    }
}

function calculateResponsiveSizes() {
    const areaW = cardStackArea.offsetWidth;
    const lv = LEVELS[game.level - 1];
    const baseCardWidth = areaW / (lv.cols + 2);
    const clampedCardWidth = Math.max(40, Math.min(baseCardWidth, 80));
    const cardAspectRatio = 65 / 85;
    const finalCardW = clampedCardWidth;
    const finalCardH = finalCardW / cardAspectRatio;
    game.cardDimensions = {
        width: finalCardW, height: finalCardH,
        fontSize: finalCardW * 0.45, borderRadius: finalCardW * 0.15,
        borderWidth: Math.max(2, finalCardW * 0.04)
    };
}

function repositionCardsAndLayout(currentBoard, levelConfig) {
    const lv = levelConfig;
    const newUnmatchedBoard = [];
    const unmatchedCards = currentBoard.filter(c => !c.matched);
    const matchedCards = currentBoard.filter(c => c.matched); 
    game.layout.areaWidth = cardStackArea.offsetWidth;
    game.layout.areaHeight = cardStackArea.offsetHeight;
    calculateResponsiveSizes();
    let stackDepth = lv.stack;
    const cardsPerStackLayer = Math.ceil(unmatchedCards.length / stackDepth);
    const placementOverlapFactor = 0.9;
    let maxAttempts = 150;
    let cardsToPlace = unmatchedCards.map(c => ({ ...c }));
    shuffle(cardsToPlace);
    for (let i = 0; i < cardsToPlace.length; i++) {
        const card = cardsToPlace[i];
        const s = Math.min(Math.floor(i / cardsPerStackLayer), stackDepth - 1);
        let x = 0, y = 0;
        let foundPosition = false;
        for (let attempt = 0; attempt < maxAttempts; attempt++) {
            let tempX = randBetween(5, game.layout.areaWidth - game.cardDimensions.width - 5);
            let tempY = randBetween(5, game.layout.areaHeight - game.cardDimensions.height - 5);
            tempX += (s * 5 * (Math.random() - 0.5));
            tempY += (s * 5 * (Math.random() - 0.5));
            tempX = Math.max(5, Math.min(tempX, game.layout.areaWidth - game.cardDimensions.width - 5));
            tempY = Math.max(5, Math.min(tempY, game.layout.areaHeight - game.cardDimensions.height - 5));
            let overlap = false;
            for (const existingCard of newUnmatchedBoard) {
                if (existingCard.stack <= s) {
                    const dx = Math.abs(tempX - existingCard.x);
                    const dy = Math.abs(tempY - existingCard.y);
                    if (dx < game.cardDimensions.width * placementOverlapFactor && dy < game.cardDimensions.height * placementOverlapFactor) {
                        overlap = true;
                        break;
                    }
                }
            }
            if (!overlap) {
                x = tempX; y = tempY; foundPosition = true; break;
            }
        }
        if (!foundPosition) {
            x = randBetween(5, game.layout.areaWidth - game.cardDimensions.width - 5);
            y = randBetween(5, game.layout.areaHeight - game.cardDimensions.height - 5);
        }
        const z = s * 1000 + i;
        newUnmatchedBoard.push({ ...card, x, y, z, stack: s });
    }
    const finalBoard = [...newUnmatchedBoard, ...matchedCards];
    finalBoard.sort((a, b) => (a.z || 0) - (b.z || 0));
    return finalBoard;
}

function genLevel(levelIdx){
  const lv = LEVELS[levelIdx - 1];
  game.score = 0;
  game.targetScore = lv.targetScore;
  game.totalDisplaySetsGenerated = 0;
  game.isCurtainEnabled = true;
  let allIcons = [];
  const requiredUniqueIcons = Math.ceil(lv.total / 3);
  let availableIcons = randArr(CARD_ICONS).slice(0, Math.min(CARD_ICONS.length, requiredUniqueIcons + 2));
  let iconPool = [];
  for (let i = 0; i < requiredUniqueIcons; i++) {
    for (let j = 0; j < 3; j++) {
      iconPool.push(availableIcons[i % availableIcons.length]);
    }
  }
  while (iconPool.length < lv.total) {
      const remaining = lv.total - iconPool.length;
      if (remaining < 3) {
          for (let i = 0; i < remaining; i++) iconPool.push(availableIcons[i % availableIcons.length]);
      } else {
          const iconToAdd = availableIcons[Math.floor(Math.random() * availableIcons.length)];
          iconPool.push(iconToAdd, iconToAdd, iconToAdd);
      }
  }
  shuffle(iconPool);
  allIcons = iconPool;
  let cards = [];
  for(let i = 0; i < lv.total; i++){
    cards.push({ id: i, icon: allIcons[i], matched: false });
  }
  game.cards = cards;
  game.board = repositionCardsAndLayout(cards.map(c => ({...c, covered: false, isNapping: false})), lv);
  game.displayCards = [];
  const usedDisplayIconsForLevel = new Set();
  for (let i = 0; i < INITIAL_DISPLAY_SETS_VISIBLE; i++) {
      const newSet = generateDisplayCardSet(Array.from(usedDisplayIconsForLevel));
      if (newSet) {
          game.displayCards.push({ id: `display-set-${i}`, cards: newSet, matched: false });
          usedDisplayIconsForLevel.add(newSet[0].icon);
          game.totalDisplaySetsGenerated++;
      }
  }
  return {cards: game.cards, board: game.board, usedIcons: availableIcons.slice(0, Math.ceil(lv.total/3))};
}

function isCardClickable(card, board){
  if(card.matched || card.isNapping) return false;
  const activeCards = board.filter(c => !c.matched);
  const cardW = game.cardDimensions.width;
  const cardH = game.cardDimensions.height;
  const currentLevelConfig = LEVELS[game.level - 1];
  const clickableOverlapFactor = 1 - (currentLevelConfig.overlap / 100);
  const overlapThresholdX = cardW * clickableOverlapFactor;
  const overlapThresholdY = cardH * clickableOverlapFactor;
  for (const otherCard of activeCards) {
    if (card.id === otherCard.id) continue;
    if (otherCard.z > card.z) {
      const dx = Math.abs(otherCard.x - card.x);
      const dy = Math.abs(otherCard.y - card.y);
      if (dx < overlapThresholdX && dy < overlapThresholdY) return false;
    }
  }
  return true;
}

function clickCard(id) {
  if (game.lock) return;
  let cardData = game.board.find(c => c.id === id);
  if (!cardData || cardData.matched || !isCardClickable(cardData, game.board)) return;
  playClickSound();
  let tempCheck = [...game.temp, { icon: cardData.icon, id: cardData.id }];
  let iconCntCheck = {};
  tempCheck.forEach(c => iconCntCheck[c.icon] = (iconCntCheck[c.icon] || 0) + 1);
  let matchedIconCheck = Object.keys(iconCntCheck).find(k => iconCntCheck[k] === 3);
  if (game.temp.length >= TEMP_LIMIT && !matchedIconCheck) {
      gameOver('æš‚å­˜åŒºå·²è¶…é™ï¼Œæ¸¸æˆå¤±è´¥ï¼');
      return;
  }
  saveStep();
  game.lock = true;
  const clickedCardEl = document.querySelector(`#card-stack-area .card[data-id='${id}']`);
  if (!clickedCardEl) {
    game.lock = false;
    return;
  }
  const startRect = clickedCardEl.getBoundingClientRect();
  const flyingCard = document.createElement('div');
  flyingCard.className = 'flying-card';
  flyingCard.innerHTML = cardData.icon;
  document.body.appendChild(flyingCard);
  flyingCard.style.left = `${startRect.left}px`;
  flyingCard.style.top = `${startRect.top}px`;
  flyingCard.style.width = `${startRect.width}px`;
  flyingCard.style.height = `${startRect.height}px`;
  flyingCard.style.fontSize = `${game.cardDimensions.fontSize}px`;
  flyingCard.style.borderRadius = `${game.cardDimensions.borderRadius}px`;
  flyingCard.style.borderWidth = `${game.cardDimensions.borderWidth}px`;
  clickedCardEl.style.opacity = '0';
  clickedCardEl.style.pointerEvents = 'none';
  const animationDuration = 150;
  const tempAppearanceDelay = 80;
  requestAnimationFrame(() => {
    const tempForPositionCalculation = [...game.temp, { icon: cardData.icon, id: cardData.id }];
    tempForPositionCalculation.sort((a, b) => a.icon.localeCompare(b.icon) || a.id - b.id);
    const endSlotIndex = tempForPositionCalculation.findIndex(c => c.id === id);
    const tempSlots = document.querySelectorAll('#temp-area .temp-slot');
    if (endSlotIndex < 0 || endSlotIndex >= tempSlots.length) {
        console.error("Invalid end slot index for flying card. Aborting animation.");
        if(flyingCard.parentNode) document.body.removeChild(flyingCard);
        game.lock = false;
        return;
    }
    const endRect = tempSlots[endSlotIndex].getBoundingClientRect();
    const tempSlotStyle = window.getComputedStyle(tempSlots[endSlotIndex]);
    const flyingCardFinalWidth = parseFloat(tempSlotStyle.width) * 0.9;
    const flyingCardFinalHeight = parseFloat(tempSlotStyle.height) * 0.9;
    const destLeft = endRect.left + (endRect.width - flyingCardFinalWidth) / 2;
    const destTop = endRect.top + (endRect.height - flyingCardFinalHeight) / 2;
    flyingCard.style.left = `${destLeft}px`;
    flyingCard.style.top = `${destTop}px`;
    flyingCard.style.transform = `scale(${flyingCardFinalWidth / parseFloat(startRect.width)})`;
  });
  setTimeout(() => {
    if (flyingCard.parentNode) document.body.removeChild(flyingCard);
  }, animationDuration);
  setTimeout(() => {
    cardData.matched = true;
    game.temp.push({ icon: cardData.icon, id: cardData.id, matched: false });
    game.temp.sort((a, b) => a.icon.localeCompare(b.icon) || a.id - b.id);
    renderTemp();
    renderBoard();
    renderProgressAndScore();
    updateWigglingCatVisibility();
    let iconCnt = {};
    game.temp.forEach(c => { if (!c.matched) iconCnt[c.icon] = (iconCnt[c.icon] || 0) + 1; });
    let matchedIcon = Object.keys(iconCnt).find(k => iconCnt[k] === 3);
    if (matchedIcon) {
      triggerMatchFeedback();
      const tempSlots = document.querySelectorAll('#temp-area .temp-slot');
      const matchedElements = [];
      game.temp.forEach((c, index) => {
          if (c.icon === matchedIcon) {
              c.matched = true;
              const slot = tempSlots[index];
              if (slot) {
                  const cardEl = slot.querySelector('.temp-card');
                  matchedElements.push({ slot, cardEl });
              }
          }
      });
      matchedElements.forEach(({ slot, cardEl }) => {
          if (cardEl) cardEl.classList.add('disappearing');
          slot.classList.add('clearing');
          slot.addEventListener('animationend', () => slot.classList.remove('clearing'), { once: true });
      });
      game.displayCards.forEach(displaySet => {
          if (!displaySet.matched && displaySet.cards[0].icon === matchedIcon) {
              displaySet.matched = true;
              game.score += DISPLAY_CARD_MATCH_SCORE;
              renderProgressAndScore();
              const matchedDisplayGroupEl = document.querySelector(`#display-area .display-group[data-id='${displaySet.id}']`);
              if (matchedDisplayGroupEl) {
                  const groupRect = matchedDisplayGroupEl.getBoundingClientRect();
                  const scoreAnimDiv = document.createElement('div');
                  scoreAnimDiv.className = 'score-animation';
                  scoreAnimDiv.textContent = `+${DISPLAY_CARD_MATCH_SCORE}`;
                  document.body.appendChild(scoreAnimDiv);
                  scoreAnimDiv.style.left = `${groupRect.left + groupRect.width / 2}px`;
                  scoreAnimDiv.style.top = `${groupRect.top + groupRect.height / 2}px`;
                  scoreAnimDiv.style.transform = 'translate(-50%, -50%)';
                  scoreAnimDiv.addEventListener('animationend', () => scoreAnimDiv.remove(), { once: true });
              }
              setTimeout(() => {
                  const newSet = generateDisplayCardSet(game.displayCards.map(ds => ds.cards[0].icon));
                  if (newSet) {
                      displaySet.cards = newSet;
                      displaySet.matched = false;
                  } else {
                      game.displayCards = game.displayCards.filter(ds => ds.id !== displaySet.id);
                  }
                  renderDisplay();
              }, 400);
          }
      });
      setTimeout(() => {
        game.temp = game.temp.filter(c => !c.matched);
        renderTemp();
        renderBoard();
        checkWin();
        game.lock = false;
      }, 450);
    } else {
      checkWin();
      game.lock = false;
    }
  }, tempAppearanceDelay);
}

function checkWin() {
    const allCardsMatched = game.board.every(c => c.matched);
    const scoreMet = game.score >= game.targetScore;
    if (allCardsMatched && scoreMet) {
        stopRandomEvents();
        stopCurtainRandomToggle();
        game.lock = true;
        const elapsedSeconds = ((Date.now() - game.levelStartTime) / 1000).toFixed(1);
        const message = `æœ¬å…³è¿‡å…³ç”¨æ—¶ ${elapsedSeconds} ç§’`;
        const originalYesText = confirmYes.textContent;
        const originalNoDisplay = confirmNo.style.display;
        confirmYes.textContent = 'å¥½çš„';
        confirmNo.style.display = 'none';
        showConfirm(message, () => {
            if (game.level === 1) {
                showLevelFinish('æ­å–œæ­å–œï¼ç¬¬ä¸€å…³é€šå…³ï¼');
            } else {
                showLevelFinish('<p> <p>æ‰€æœ‰å…³å¡å…¨éƒ¨é€šå…³ï¼<br> ğŸ‰ ä½ å¤ªæ£’å•¦ï¼ğŸ‰');
            }
            confirmYes.textContent = originalYesText;
            confirmNo.style.display = originalNoDisplay;
        });
    } else if (allCardsMatched && !scoreMet) {
        gameOver(`å¡ç‰Œå·²å…¨éƒ¨æ¶ˆé™¤ï¼Œä½†åˆ†æ•°æœªè¾¾æ ‡ï¼<br>å½“å‰åˆ†æ•°: ${game.score} / ç›®æ ‡åˆ†æ•°: ${game.targetScore}`);
    }
}

function saveStep(){
  game.stepStack.push({
    board: deepClone(game.board),
    temp: deepClone(game.temp),
    score: game.score,
    displayCards: deepClone(game.displayCards),
    totalDisplaySetsGenerated: game.totalDisplaySetsGenerated
  });
  if(game.stepStack.length > 20) game.stepStack.shift();
}

function undoStep(){
  if(game.stepStack.length > 0){
    let prev = game.stepStack.pop();
    game.board = deepClone(prev.board);
    game.temp = deepClone(prev.temp);
    game.score = prev.score;
    game.displayCards = deepClone(prev.displayCards);
    game.totalDisplaySetsGenerated = prev.totalDisplaySetsGenerated;
    renderAll();
    showMessage('å·²æ’¤é”€');
    updateWigglingCatVisibility();
  } else {
    showMessage('æ— æ³•æ’¤é”€æ›´å¤š', '#888');
  }
}

function shuffleStep(){
  saveStep();
  game.lock = true;
  let unmatchedCardsElements = document.querySelectorAll('#card-stack-area .card:not(.matched)');
  unmatchedCardsElements.forEach(el => el.classList.add('card-shuffling-out'));
  setTimeout(() => {
      game.board = repositionCardsAndLayout(game.board, LEVELS[game.level - 1]);
      renderAll();
      showMessage('å·²æ´—ç‰Œ');
      game.lock = false;
      updateWigglingCatVisibility();
  }, 300);
}

function hintStep(){
  let tempIcons = game.temp.map(c => c.icon);
  let clickableBoardCards = game.board.filter(c => !c.matched && isCardClickable(c, game.board));
  let clickableBoardIcons = clickableBoardCards.map(c => c.icon);
  let allAvailableIcons = [...tempIcons, ...clickableBoardIcons];
  let iconCounts = {};
  allAvailableIcons.forEach(icon => iconCounts[icon] = (iconCounts[icon] || 0) + 1);
  let targetIcon = Object.keys(iconCounts).find(icon => iconCounts[icon] >= 3);
  document.querySelectorAll('.hinted-shake').forEach(el => el.classList.remove('hinted-shake'));
  if (targetIcon) {
    let hintDone = 0;
    const hintedElements = [];
    for (let i = 0; i < game.temp.length && hintDone < 3; i++) {
      if (game.temp[i].icon === targetIcon && !game.temp[i].matched) {
        const tempCardElement = document.querySelectorAll('#temp-area .temp-slot .temp-card')[i];
        if (tempCardElement) {
          tempCardElement.classList.add('hinted-shake');
          hintedElements.push(tempCardElement);
          hintDone++;
        }
      }
    }
    for (let i = 0; i < clickableBoardCards.length && hintDone < 3; i++) {
      let boardCard = clickableBoardCards[i];
      if (boardCard.icon === targetIcon) {
        let doms = document.querySelector(`#card-stack-area .card[data-id='${boardCard.id}']`);
        if (doms) {
          doms.classList.add('hinted-shake');
          hintedElements.push(doms);
          hintDone++;
        }
      }
    }
    showMessage('å·²æç¤ºå¯æ¶ˆé™¤ä¸‰å¼ ');
    setTimeout(() => hintedElements.forEach(el => el.classList.remove('hinted-shake')), 2000);
  } else {
    showMessage('å½“å‰æ— å¯ä¸‰æ¶ˆ', "#888");
  }
}

function gameOver(msg){
  stopRandomEvents();
  stopCurtainRandomToggle();
  toggleCurtain(true);
  game.lock = true;
  document.getElementById('card-stack-area').innerHTML = '';
  document.querySelectorAll('#temp-area .temp-slot').forEach(slot => { slot.innerHTML = ''; });
  displayArea.innerHTML = '';
  document.getElementById('level-info').textContent = '';
  currentScoreElement.textContent = '0';
  targetScoreElement.textContent = '0';
  document.getElementById('message-bar').textContent = '';
  hideWigglingCats();
  setTimeout(() => {
    const gameOverScreen = document.getElementById('game-over');
    gameOverScreen.style.display = 'flex';
    gameOverScreen.querySelector('#game-over-text').innerHTML = msg;
  }, 100);
}

function startGame(level){
  document.getElementById('header-bar').style.display = 'flex';
  document.getElementById('main-area').style.display = 'flex';
  footer.style.display = 'block';
  game.level = level;
  game.levelStartTime = Date.now();
  let lvData = genLevel(level);
  game.cards = lvData.cards;
  game.board = lvData.board;
  game.usedIcons = lvData.usedIcons;
  game.temp = [];
  game.matched = [];
  game.toolUses = {undo: 0, hint: 0, shuffle: 0};
  game.stepStack = [];
  game.lock = false;
  game.isNewLevel = true;
  renderAll();
  updateToolButtons();
  if (game.bgmOn) playBgm(true);
  positionCatWalker();
  updateWigglingCatVisibility();
  startRandomEvents();
  positionCurtain();
  toggleCurtain(false);
  setTimeout(() => {
      toggleCurtain(true);
      startCurtainRandomToggle();
  }, 2000);
}

function renderBoard(){
  const area = document.getElementById('card-stack-area');
  area.innerHTML = '';
  let cardsToRender = game.board.filter(c => !c.matched);
  cardsToRender.sort((a, b) => a.z - b.z);
  const isInitialRenderForLevel = game.isNewLevel;
  cardsToRender.forEach((card, index) => {
    let el = document.createElement('div');
    const clickable = isCardClickable(card, game.board);
    el.className = "card" + (clickable ? "" : " disabled");
    if (card.isNapping) el.classList.add('napping');
    el.style.left = card.x + 'px';
    el.style.top = card.y + 'px';
    el.style.zIndex = card.z;
    el.innerHTML = card.icon;
    el.dataset.id = card.id;
    el.style.width = `${game.cardDimensions.width}px`;
    el.style.height = `${game.cardDimensions.height}px`;
    el.style.fontSize = `${game.cardDimensions.fontSize}px`;
    el.style.borderRadius = `${game.cardDimensions.borderRadius}px`;
    el.style.borderWidth = `${game.cardDimensions.borderWidth}px`;
    if(clickable) el.onclick = () => clickCard(card.id);
    if (isInitialRenderForLevel) {
        el.classList.add('card-entering');
        el.style.animationDelay = `${index * 0.03}s`;
        el.addEventListener('animationend', function handler() {
            el.classList.remove('card-entering');
            el.style.animationDelay = '';
            el.removeEventListener('animationend', handler);
        }, { once: true });
    }
    area.appendChild(el);
  });
  game.isNewLevel = false;
}

function renderTemp(){
  const tempSlots = document.querySelectorAll('#temp-area .temp-slot');
  const tempArea = document.getElementById('temp-area');
  const tempCardScaleFactor = 0.8;
  const tempCardWidth = game.cardDimensions.width * tempCardScaleFactor;
  const tempCardHeight = game.cardDimensions.height * tempCardScaleFactor;
  const tempCardFontSize = game.cardDimensions.fontSize * tempCardScaleFactor;
  const tempCardBorderRadius = game.cardDimensions.borderRadius * tempCardScaleFactor;
  const tempCardBorderWidth = game.cardDimensions.borderWidth * tempCardScaleFactor;
  tempArea.style.minHeight = `${tempCardHeight + (tempCardBorderWidth * 2) + 16}px`;
  tempSlots.forEach((slot, i) => {
    slot.innerHTML = '';
    slot.style.width = `${tempCardWidth}px`;
    slot.style.height = `${tempCardHeight}px`;
    slot.style.borderRadius = `${tempCardBorderRadius}px`;
    slot.style.borderWidth = `${tempCardBorderWidth}px`;
    slot.style.margin = '0';
    if (i < game.temp.length) {
      const c = game.temp[i];
      let el = document.createElement('div');
      el.className = "temp-card" + (c.matched ? " matched" : "");
      el.innerHTML = c.icon;
      el.style.fontSize = `${tempCardFontSize}px`;
      el.style.borderRadius = `${tempCardBorderRadius}px`;
      el.style.borderWidth = `${tempCardBorderWidth}px`;
      slot.appendChild(el);
    }
  });
  let persistentHeart = document.getElementById('persistent-heart');
  if (game.temp.length === 7) {
    const seventhTempSlot = tempSlots[6];
    if (seventhTempSlot) {
      const mainArea = document.getElementById('main-area');
      const cardStackArea = document.getElementById('card-stack-area');
      const seventhSlotRect = seventhTempSlot.getBoundingClientRect();
      const cardStackRect = cardStackArea.getBoundingClientRect();
      const mainAreaRect = mainArea.getBoundingClientRect();
      const heartVerticalMidpointAbsolute = cardStackRect.bottom + (seventhSlotRect.top - cardStackRect.bottom) / 2;
      const heartTopRelativeToMainArea = heartVerticalMidpointAbsolute - mainAreaRect.top;
      const heartLeftRelativeToMainArea = (seventhTempSlot.left + seventhTempSlot.offsetWidth / 2) - mainAreaRect.left;
      if (!persistentHeart) {
        persistentHeart = document.createElement('div');
        persistentHeart.id = 'persistent-heart';
        persistentHeart.className = 'heart-animation';
        persistentHeart.innerHTML = 'ğŸ’';
        mainArea.appendChild(persistentHeart);
      }
      persistentHeart.style.left = `${heartLeftRelativeToMainArea}px`;
      persistentHeart.style.top = `${heartTopRelativeToMainArea}px`;
      persistentHeart.style.transform = 'translate(-50%, -50%)';
      persistentHeart.style.display = 'block';
    }
  } else {
    if (persistentHeart) persistentHeart.style.display = 'none';
  }
}

function renderDisplay() {
    displayArea.innerHTML = '';
    const displayCardWidth = game.cardDimensions.width * 0.7;
    const displayCardHeight = game.cardDimensions.height * 0.7;
    const displayCardFontSize = game.cardDimensions.fontSize * 0.7;
    const displayCardBorderRadius = game.cardDimensions.borderRadius * 0.7;
    const displayCardBorderWidth = game.cardDimensions.borderWidth * 0.7;
    const displayGroupGap = displayCardWidth * 0.1;
    displayArea.style.width = `${cardStackArea.offsetWidth * 0.95}px`;
    displayArea.style.minHeight = `${displayCardHeight + displayCardBorderWidth * 2 + 20}px`;
    game.displayCards.forEach(displaySet => {
        const groupDiv = document.createElement('div');
        groupDiv.className = 'display-group';
        groupDiv.dataset.id = displaySet.id;
        groupDiv.style.gap = `${displayGroupGap}px`;
        displaySet.cards.forEach(card => {
            const cardDiv = document.createElement('div');
            cardDiv.className = 'display-card' + (displaySet.matched ? ' matched-display' : '');
            cardDiv.innerHTML = card.icon;
            cardDiv.style.width = `${displayCardWidth}px`;
            cardDiv.style.height = `${displayCardHeight}px`;
            cardDiv.style.fontSize = `${displayCardFontSize}px`;
            cardDiv.style.borderRadius = `${displayCardBorderRadius}px`;
            cardDiv.style.borderWidth = `${displayCardBorderWidth}px`;
            groupDiv.appendChild(cardDiv);
        });
        displayArea.appendChild(groupDiv);
    });
}

function renderProgressAndScore(){
  levelInfoElement.textContent = `å…³å¡: ${game.level} / 2`;
  currentScoreElement.textContent = game.score;
  targetScoreElement.textContent = game.targetScore;
  updateWigglingCatVisibility();
}

function showMessage(msg, color){
  let bar = document.getElementById('message-bar');
  bar.style.color = color || '#c0392b';
  bar.textContent = msg || '';
  if(msg) setTimeout(()=>{bar.textContent='';}, 2300);
}

function updateToolButtons() {
  document.getElementById('undo-count').textContent = game.toolUses.undo;
  document.getElementById('hint-count').textContent = game.toolUses.hint;
  document.getElementById('shuffle-count').textContent = game.toolUses.shuffle;
  const undoDisabledByCount = game.toolUses.undo <= 0;
  if (isLandscape) {
    undoBtn.disabled = true;
    undoBtn.title = "æ¨ªå±æ¨¡å¼ä¸‹ä¸å¯ç”¨";
  } else {
    undoBtn.disabled = undoDisabledByCount;
    undoBtn.title = "æ’¤é”€(éœ€å…‘æ¢ç )";
  }
  hintBtn.disabled = game.toolUses.hint <= 0;
  shuffleBtn.disabled = game.toolUses.shuffle <= 0;
}

function renderAll(){
  renderBoard();
  renderTemp();
  renderDisplay();
  renderProgressAndScore();
  updateToolButtons();
  positionCatWalker();
  updateWigglingCatVisibility();
  positionCurtain();
}

function showLevelFinish(msg){
  stopRandomEvents();
  stopCurtainRandomToggle();
  toggleCurtain(true);
  playBgm(false);
  if (outroVideoTimeout) clearTimeout(outroVideoTimeout);
  if (outroVideo) {
      outroVideo.pause();
      outroVideo.currentTime = 0;
  }
  level2OutroScreen.style.display = 'none';
  skipOutroBtn.style.display = 'none';
  game.lock = false;
  const levelFinishScreen = document.getElementById('level-finish');
  levelFinishScreen.style.display='flex';
  levelFinishTextElement.innerHTML = msg;
  const existingConfetti = levelFinishScreen.querySelector('.confetti-container');
  if (existingConfetti) existingConfetti.remove();
  const confettiContainer = document.createElement('div');
  confettiContainer.className = 'confetti-container';
  levelFinishScreen.appendChild(confettiContainer);
  const colors = ['#f44336', '#e91e63', '#9c27b0', '#673ab7', '#3f51b5', '#2196f3', '#03a9f4', '#00bcd4', '#009688', '#4caf50', '#8bc34a', '#cddc39', '#ffeb3b', '#ffc107', '#ff9800'];
  for (let i = 0; i < 150; i++) {
      const piece = document.createElement('div');
      piece.className = 'confetti-piece';
      piece.style.left = Math.random() * 100 + 'vw';
      piece.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
      const duration = Math.random() * 3 + 4;
      piece.style.animationDuration = `${duration}s`;
      piece.style.animationDelay = `${Math.random() * 5}s`;
      piece.style.transform = `rotate(${Math.random() * 360}deg)`;
      confettiContainer.appendChild(piece);
  }
  nextBtn.style.display = (game.level === 1) ? 'inline-block' : 'none';
  gobangBtn.classList.remove('animated-scale-fade');
  closeGameBtnLevel.classList.remove('animated-scale-fade');
  if (game.level === 1) {
    levelFinishTextElement.style.animation = 'shake 6s infinite, show-card-property 15s forwards';
    levelFinishTextElement.innerHTML += '<br>ä¸‹ä¸€å…³åæœ‰å½©è›‹ğŸª…ï¼';
    playerDiv.style.display = 'block';
    neteasePlayerDiv.style.display = 'none';
    gobangBtn.style.display = 'none';
    restartGameBtn.style.display = 'none';
    retryBtnLevelFinish.style.display = 'inline-block';
    closeGameBtnLevel.onclick = () => handleCloseGame('level');
  } else if (game.level === 2) {
    levelFinishTextElement.style.animation = 'pulse-scale 2s infinite alternate, wave 2s infinite';
    playerDiv.style.display = 'none';
    neteasePlayerDiv.style.display = 'block';
    gobangBtn.style.display = 'inline-block';
    restartGameBtn.style.display = 'inline-block';
    retryBtnLevelFinish.style.display = 'none';
    gobangBtn.classList.add('animated-scale-fade');
    closeGameBtnLevel.classList.add('animated-scale-fade');
    closeGameBtnLevel.onclick = () => {
        document.getElementById('level-finish').style.display = 'none';
        playLevel2Outro();
    };
  }
}

function initializeGame(){
  musicToggleBtn.innerHTML = game.bgmOn ? 'ğŸ¼' : 'ğŸ”‡';
  updateToolButtons();
  if (bgm) bgm.volume = 0.5;
}

function handleCloseGame(type) {
    showConfirm('ç¡®å®šè¦å…³é—­æ¸¸æˆå—ï¼Ÿ', () => {
        window.close();
        setTimeout(() => {
            document.getElementById('game-container').style.display = 'none';
            let messageHtml = type === 'level' ? `<p>å½“å‰å®¢æˆ·ç«¯æš‚ä¸æ”¯æŒè‡ªåŠ¨å…³é—­ï¼Œ</p><p>è¯·ç‚¹å‡»é¡µé¢å…³é—­æ ‡ç­¾å…³é—­ã€‚</p><br> å¦‚è‹¥é‡æ–°å¼€å§‹æ¸¸æˆï¼Œè¯·ç‚¹å‡»<br><br><button onclick="window.location.href='https://www.kaiyuanzhu.qzz.io/cat/'" style="padding: 10px 20px; border: 1px solid #dc2626; background-color: #fef2f2; cursor: pointer; border-radius: 0.375rem;">é‡æ–°å¼€å§‹</button>` : `<p>å½“å‰å®¢æˆ·ç«¯æš‚ä¸æ”¯æŒè‡ªåŠ¨å…³é—­</p><p>å°æç¤ºï¼šå¯è¾“å…¥"kaiyuan"å…‘æ¢æç¤ºæ¬¡æ•°ã€‚</p><br> å¦‚æœæƒ³é‡æ–°å¼€å§‹æ¸¸æˆï¼Œè¯·ç‚¹å‡»<br><br><button onclick="window.location.href='https://www.kaiyuanzhu.qzz.io/cat/'" style="padding: 10px 20px; border: 1px solid #dc2626; background-color: #fef2f2; cursor: pointer; border-radius: 0.375rem;">é‡æ–°å¼€å§‹</button>`;
            document.body.innerHTML = `<div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:60vh; font-size:1.2em; color:#5d4037; text-align:center;opacity: 1;">${messageHtml}<br><small class="loading-footer mt-8">å–µäº†ä¸ªå–µ &copy; 2025 | Designed by å¼€å…ƒ</small></div>`;
        }, 100);
    });
}

function showEventMessage(icon, text) {
    eventIconEl.textContent = icon;
    eventTextEl.innerHTML = text;
    eventOverlay.style.display = 'flex';
    setTimeout(() => eventOverlay.style.display = 'none', 3500);
}
function eventCatNap() {
    const clickableCards = game.board.filter(c => isCardClickable(c, game.board));
    if (clickableCards.length < 3) return;
    showEventMessage('ğŸ’¤', 'çŒ«å’ªåœ¨æ‰“ç›¹...<br>æœ‰äº›å¡ç‰Œæš‚æ—¶æ‹¿ä¸åˆ°äº†ï¼');
    game.lock = true;
    const nappingCards = [];
    const centerCard = clickableCards[Math.floor(Math.random() * clickableCards.length)];
    nappingCards.push(centerCard);
    const otherCards = game.board.filter(c => !c.matched && c.id !== centerCard.id);
    otherCards.sort((a, b) => Math.hypot(a.x - centerCard.x, a.y - centerCard.y) - Math.hypot(b.x - centerCard.x, b.y - centerCard.y));
    nappingCards.push(...otherCards.slice(0, Math.floor(Math.random() * 2) + 2));
    nappingCards.forEach(card => card.isNapping = true);
    renderBoard();
    game.lock = false;
    setTimeout(() => {
        nappingCards.forEach(card => {
            const boardCard = game.board.find(c => c.id === card.id);
            if (boardCard) boardCard.isNapping = false;
        });
        renderBoard();
    }, 10000);
}
function eventCuriousPaw() {
    const clickableCards = game.board.filter(c => isCardClickable(c, game.board));
    const unclickableCards = game.board.filter(c => !c.matched && !isCardClickable(c, game.board));
    if (clickableCards.length === 0 || unclickableCards.length === 0) return;
    showEventMessage('ğŸ¾', 'å¥½å¥‡çš„çˆªå­...<br>ä¸€å¼ å¯è§å¡ç‰Œå’Œä¸€å¼ ä¸å¯è§å¡ç‰Œçš„å›¾æ ‡è¢«äº¤æ¢äº†ï¼');
    game.lock = true;
    const card1 = clickableCards[Math.floor(Math.random() * clickableCards.length)];
    const card2 = unclickableCards[Math.floor(Math.random() * unclickableCards.length)];
    [card1.icon, card2.icon] = [card2.icon, card1.icon];
    const card1El = document.querySelector(`.card[data-id='${card1.id}']`);
    const card2El = document.querySelector(`.card[data-id='${card2.id}']`);
    if (card1El) card1El.classList.add('hinted-shake');
    if (card2El) card2El.classList.add('hinted-shake');
    setTimeout(() => {
        renderBoard();
        game.lock = false;
    }, 800);
}
function eventGiftOffering() {
    const tools = ['undo', 'hint', 'shuffle'];
    const toolNames = { undo: 'æ’¤é”€', hint: 'æç¤º', shuffle: 'æ´—ç‰Œ' };
    const randomTool = tools[Math.floor(Math.random() * tools.length)];
    game.toolUses[randomTool]++;
    updateToolButtons();
    showEventMessage('ğŸ', `çŒ«å’ªé€æ¥äº†ç¤¼ç‰©ï¼<br>è·å¾—1æ¬¡å…è´¹<b>${toolNames[randomTool]}</b>ï¼`);
}
const randomEvents = [
    { name: 'catNap', func: eventCatNap, weight: 3 },
    { name: 'curiousPaw', func: eventCuriousPaw, weight: 3 },
    { name: 'giftOffering', func: eventGiftOffering, weight: 2 }
];
function startRandomEvents() {
    stopRandomEvents();
    randomEventTimer = setInterval(() => {
        if (game.lock || document.getElementById('level-finish').style.display === 'flex' || document.getElementById('game-over').style.display === 'flex') return;
        const weightedList = [];
        randomEvents.forEach(event => { for (let i = 0; i < event.weight; i++) weightedList.push(event.func); });
        const randomEventFunc = weightedList[Math.floor(Math.random() * weightedList.length)];
        randomEventFunc();
    }, randBetween(20000, 30000));
}
function stopRandomEvents() {
    if (randomEventTimer) clearInterval(randomEventTimer);
    randomEventTimer = null;
}

function positionCurtain() {
    if (!curtainElement || !displayArea) return;
    const displayRect = displayArea.getBoundingClientRect();
    const mainAreaRect = document.getElementById('main-area').getBoundingClientRect();
    curtainElement.style.left = `${displayRect.left - mainAreaRect.left}px`;
    curtainElement.style.top = `${displayRect.top - mainAreaRect.top}px`;
    curtainElement.style.width = `${displayRect.width}px`;
    curtainElement.style.height = `${displayRect.height}px`;
    curtainElement.style.borderRadius = window.getComputedStyle(displayArea).borderRadius;
    curtainElement.style.display = 'block';
}

function toggleCurtain(open) {
    if (!curtainElement) return;
    if (!game.isCurtainEnabled) {
        curtainElement.classList.remove('closed');
        curtainElement.classList.add('open');
        return;
    }
    if (open) {
        curtainElement.classList.remove('closed');
        curtainElement.classList.add('open');
    } else {
        curtainElement.classList.remove('open');
        curtainElement.classList.add('closed');
    }
}

function startCurtainRandomToggle() {
    stopCurtainRandomToggle();
    curtainTimer = setInterval(() => {
        if (game.lock || !game.isCurtainEnabled || document.getElementById('level-finish').style.display === 'flex' || document.getElementById('game-over').style.display === 'flex') {
            toggleCurtain(true);
            return;
        }
        const shouldClose = Math.random() < 0.5;
        if (shouldClose) {
            toggleCurtain(false);
            setTimeout(() => {
                toggleCurtain(true);
            }, 2000);
        } else {
            toggleCurtain(true);
        }
    }, randBetween(20000, 30000));
}

function stopCurtainRandomToggle() {
    if (curtainTimer) {
        clearInterval(curtainTimer);
        curtainTimer = null;
    }
}

function handleResize() {
    if (!game.board || game.board.length === 0 || document.getElementById('start-screen').style.display !== 'none' || document.getElementById('level-finish').style.display !== 'none' || document.getElementById('game-over').style.display !== 'none') {
        positionCatWalker();
        positionCurtain();
        return;
    }
    const currentAreaWidth = cardStackArea.offsetWidth;
    const currentAreaHeight = cardStackArea.offsetHeight;
    if (game.layout.areaWidth === currentAreaWidth && game.layout.areaHeight === currentAreaHeight) {
        return;
    }
    game.layout.areaWidth = currentAreaWidth;
    game.layout.areaHeight = currentAreaHeight;
    calculateResponsiveSizes();
    game.board = repositionCardsAndLayout(game.board, LEVELS[game.level - 1]);
    renderAll();
}

function handleDeviceMotion(event) {
    if (game.lock || game.toolUses.shuffle <= 0) return;
    const currentTime = new Date().getTime();
    if ((currentTime - lastShakeTime) > 1500) {
        const acceleration = event.accelerationIncludingGravity;
        const shakeThreshold = 18;
        if (
            Math.abs(acceleration.x) > shakeThreshold ||
            Math.abs(acceleration.y) > shakeThreshold
        ) {
            lastShakeTime = currentTime;
            shuffleStep();
            game.toolUses.shuffle--;
            updateToolButtons();
            showMessage('ä½ æ‘‡åŠ¨äº†æ‰‹æœºï¼Œè‡ªåŠ¨ä½¿ç”¨äº†ä¸€æ¬¡æ´—ç‰Œï¼', '#3e5a2b');
        }
    }
}

// ======================= OPTIMIZED LOADING LOGIC =======================

/**
 * ä¼˜åŒ–ç‚¹: åå°èµ„æºåŠ è½½å™¨
 * æ­¤å‡½æ•°åœ¨ä¸»åŠ è½½å®Œæˆåè¢«è°ƒç”¨ï¼Œç”¨äºåœ¨åå°é™é»˜åŠ è½½éç´§æ€¥èµ„æºã€‚
 * è¿™æ ·ä¸ä¼šé˜»å¡æ¸¸æˆå¯åŠ¨ï¼ŒåŒæ—¶èƒ½åˆ©ç”¨ç©å®¶åœ¨å¼€å§‹èœå•åœç•™æˆ–ç©ç¬¬ä¸€å…³çš„æ—¶é—´æå‰å‡†å¤‡å¥½åç»­èµ„æºã€‚
 */
function loadSecondaryAssets() {
    const secondaryAssets = [
        { type: 'audio', src: 'Get.mp3' },      // èƒŒæ™¯éŸ³ä¹
        { type: 'image', src: 'mao1.webp' },     // ç¬¬ä¸€å…³é€šå…³èƒŒæ™¯
        { type: 'video', src: 'mao2.mp4' },     // ç¬¬äºŒå…³é€šå…³è§†é¢‘ (æŒ‰è¦æ±‚åŠ è½½)
        { type: 'image', src: 'mao2.webp' }      // ç¬¬äºŒå…³é€šå…³è§†é¢‘çš„å¤‡ç”¨å›¾ç‰‡
    ];

    console.log("å¼€å§‹åœ¨åå°åŠ è½½æ¬¡è¦èµ„æº...");

    secondaryAssets.forEach(asset => {
        // åˆ›å»ºå…ƒç´ å¹¶è®¾ç½®srcå³å¯è§¦å‘æµè§ˆå™¨ä¸‹è½½å’Œç¼“å­˜ï¼Œæ— éœ€æ·»åŠ åˆ°DOMä¸­
        try {
            let element;
            switch (asset.type) {
                case 'image':
                    element = new Image();
                    element.src = asset.src;
                    break;
                case 'audio':
                case 'video':
                    element = document.createElement(asset.type);
                    element.src = asset.src;
                    break;
            }
            console.log(`  - å¼€å§‹åŠ è½½: ${asset.src}`);
        } catch (e) {
            console.error(`åŠ è½½åå°èµ„æºå¤±è´¥: ${asset.src}`, e);
        }
    });
}


/**
 * ä¼˜åŒ–ç‚¹: æ ¸å¿ƒèµ„æºåŠ è½½å™¨
 * æ­¤å‡½æ•°ç»è¿‡ä¿®æ”¹ï¼Œç°åœ¨åªåŠ è½½å¯åŠ¨æ¸¸æˆç»å¯¹å¿…è¦çš„èµ„æºã€‚
 * åŠ è½½åˆ—è¡¨è¢«ç²¾ç®€ï¼Œä»¥å®ç°æœ€å¿«çš„åˆå§‹åŠ è½½é€Ÿåº¦ã€‚
 */
function initializeAndLoadAssets() {
    const loadingScreen = document.getElementById('loading-screen');
    const progressBar = document.getElementById('progress-bar');
    const loadingText = document.getElementById('loading-text');
    const LOAD_TIMEOUT = 4000; // æ¯ä¸ªèµ„æº4ç§’è¶…æ—¶

    // æ ¸å¿ƒèµ„æºåˆ—è¡¨ï¼šè¿™äº›æ˜¯æ˜¾ç¤ºå¼€å§‹å±å¹•å’Œå¯åŠ¨ç¬¬ä¸€å…³æ‰€å¿…éœ€çš„
    const criticalAssets = [
        { type: 'image', src: 'me.png', name: 'å›¾æ ‡' },
        { type: 'image', src: 'mao3.webp', name: 'ä¸»é¢˜èƒŒæ™¯' },
        { type: 'image', src: 'mao.webp', name: 'å¼€å§‹èƒŒæ™¯' },
        { type: 'image', src: 'cat1.webp', name: 'æ¸¸æˆèƒŒæ™¯' },
        { type: 'audio', src: 'kaa.mp3', name: 'ç‚¹å‡»éŸ³æ•ˆ' },
        { type: 'video', src: 'mao.mp4', name: 'æ¸¸æˆåŠ¨ç”»' },
    ];

    let assetsLoaded = 0;
    const totalAssets = criticalAssets.length;

    const updateProgress = () => {
        assetsLoaded++;
        const progress = (assetsLoaded / totalAssets) * 100;
        progressBar.style.width = progress + '%';

        if (assetsLoaded === totalAssets) {
            loadingText.textContent = 'å®Œæˆ!';
            setTimeout(() => {
                loadingScreen.style.opacity = '0';
                loadingScreen.addEventListener('transitionend', () => {
                    loadingScreen.style.display = 'none';
                    document.title = "å–µäº†ä¸ªå–µ";
                    document.getElementById('start-screen').style.display = 'flex';
                    initializeGame();
                    // å…³é”®ä¼˜åŒ–ç‚¹ï¼šåœ¨æ ¸å¿ƒèµ„æºåŠ è½½å®Œæ¯•åï¼Œç«‹å³å¼€å§‹åå°åŠ è½½æ¬¡è¦èµ„æº
                    loadSecondaryAssets(); 
                }, { once: true });
            }, 400);
        } else {
            loadNextAsset();
        }
    };

    const loadAsset = (asset) => {
        return new Promise((resolve, reject) => {
            const timeoutId = setTimeout(() => reject(new Error(`åŠ è½½è¶…æ—¶ ${asset.src}`)), LOAD_TIMEOUT);
            
            const successHandler = () => { clearTimeout(timeoutId); resolve(); };
            const errorHandler = (e) => { clearTimeout(timeoutId); reject(new Error(`åŠ è½½å¤±è´¥ ${asset.src}`)); };
            
            switch (asset.type) {
                case 'image':
                    const img = new Image();
                    img.onload = successHandler;
                    img.onerror = errorHandler;
                    img.src = asset.src;
                    break;
                case 'audio':
                case 'video':
                    const media = document.createElement(asset.type);
                    media.addEventListener('canplaythrough', successHandler, { once: true });
                    media.onerror = errorHandler;
                    media.src = asset.src;
                    media.load(); // æŸäº›æµè§ˆå™¨éœ€è¦è°ƒç”¨load()
                    break;
            }
        });
    };

    const loadNextAsset = async () => {
        if (assetsLoaded >= totalAssets) return;

        const asset = criticalAssets[assetsLoaded];
        loadingText.textContent = `æ­£åœ¨åŠ è½½ ${asset.name}... (${assetsLoaded + 1}/${totalAssets})`;
        
        try {
            await loadAsset(asset);
        } catch (error) {
            console.error(error.message);
            // å³ä½¿æŸä¸ªèµ„æºåŠ è½½å¤±è´¥ï¼Œä¹Ÿç»§ç»­åŠ è½½ä¸‹ä¸€ä¸ªï¼Œä»¥é˜²å¡æ­»
        } finally {
            updateProgress();
        }
    };

    // å¯åŠ¨é¡ºåºåŠ è½½è¿‡ç¨‹
    loadNextAsset();
}


function attemptVideoAutoplay() {
    const video = document.getElementById('start-screen-video');
    if (!video) return;
    const playPromise = video.play();
    if (playPromise !== undefined) {
        playPromise.catch(error => {
            console.log("Video direct play failed, waiting for user interaction.", error);
            document.body.addEventListener('touchstart', function onFirstTouch() {
                video.play().catch(e => console.error("Video playback failed after touch:", e));
                document.body.removeEventListener('touchstart', onFirstTouch);
            }, { once: true });
        });
    }
    if (typeof WeixinJSBridge == "object" && typeof WeixinJSBridge.invoke == "function") {
        WeixinJSBridge.invoke('getNetworkType', {}, e => video.play().catch(err => console.error("Video playback failed in WeixinJSBridge:", err)));
    } else {
        document.addEventListener("WeixinJSBridgeReady", () => WeixinJSBridge.invoke('getNetworkType', {}, e => video.play().catch(err => console.error("Video playback failed on WeixinJSBridgeReady:", err))), false);
    }
}

function positionCatWalker() {
    const displayArea = document.getElementById('display-area');
    const catPath = document.getElementById('cat-path');
    const mainArea = document.getElementById('main-area');
    if (!displayArea || !catPath || !mainArea || mainArea.style.display === 'none') return;
    const displayAreaBottomRelativeToMainArea = displayArea.offsetTop + displayArea.offsetHeight;
    catPath.style.top = `${displayAreaBottomRelativeToMainArea}px`;
    catPath.style.width = `${mainArea.offsetWidth}px`;
}

function positionWigglingCat(wigglingCatEl, slotIndex) {
    const tempSlots = document.querySelectorAll('#temp-area .temp-slot');
    const cardStackArea = document.getElementById('card-stack-area');
    const mainArea = document.getElementById('main-area');
    if (!wigglingCatEl || tempSlots.length === 0 || !cardStackArea || !mainArea || slotIndex < 0 || slotIndex >= tempSlots.length) {
        if(wigglingCatEl) wigglingCatEl.style.display = 'none';
        return;
    }
    const targetTempSlot = tempSlots[slotIndex];
    const cardStackRect = cardStackArea.getBoundingClientRect();
    const targetTempSlotRect = targetTempSlot.getBoundingClientRect();
    const mainAreaRect = mainArea.getBoundingClientRect();
    const gapMidpointAbsolute = cardStackRect.bottom + (targetTempSlotRect.top - cardStackRect.bottom) / 2;
    const topRelativeToMainArea = gapMidpointAbsolute - mainAreaRect.top;
    const leftRelativeToMainArea = (targetTempSlotRect.left + targetTempSlot.offsetWidth / 2) - mainAreaRect.left;
    wigglingCatEl.style.top = `${topRelativeToMainArea - (wigglingCatEl.offsetHeight / 2)}px`;
    wigglingCatEl.style.left = `${leftRelativeToMainArea}px`;
    wigglingCatEl.style.display = 'block';
}

function hideWigglingCats() {
    wigglingCat1.style.display = 'none';
    wigglingCat4.style.display = 'none';
    wigglingCat7.style.display = 'none';
}

function updateWigglingCatVisibility() {
    if (game.score >= game.targetScore) {
        positionWigglingCat(wigglingCat1, 0);
        positionWigglingCat(wigglingCat4, 3);
        positionWigglingCat(wigglingCat7, 6);
    } else {
        hideWigglingCats();
    }
}

function playLevel2Outro() {
    game.lock = true;
    playBgm(false);
    level2OutroScreen.style.display = 'flex';
    outroLoadingText.style.display = 'block';
    skipOutroBtn.style.display = 'block';
    outroVideo.style.display = 'none';
    outroImage.style.display = 'none';
    const finalCloseAction = () => handleCloseGame('level');
    outroVideoTimeout = setTimeout(() => {
        outroVideo.style.display = 'none';
        outroImage.style.display = 'block';
        outroLoadingText.textContent = 'è§†é¢‘æ— æ³•æ’­æ”¾ï¼Œæ˜¾ç¤ºå›¾ç‰‡...';
        setTimeout(finalCloseAction, 3000);
    }, 7000);
    outroVideo.load();
    const playPromise = outroVideo.play();
    if (playPromise !== undefined) {
        playPromise.then(() => {
            outroVideo.style.display = 'block';
            outroLoadingText.style.display = 'none';
            if (outroVideoTimeout) clearTimeout(outroVideoTimeout);
        }).catch(error => {
            outroVideo.style.display = 'none';
            outroImage.style.display = 'block';
            outroLoadingText.textContent = 'è§†é¢‘æ— æ³•æ’­æ”¾ï¼Œæ˜¾ç¤ºå›¾ç‰‡...';
            if (outroVideoTimeout) clearTimeout(outroVideoTimeout);
            setTimeout(finalCloseAction, 3000);
        });
    }
    outroVideo.onended = () => {
        if (outroVideoTimeout) clearTimeout(outroVideoTimeout);
        finalCloseAction();
    };
    outroVideo.onerror = (e) => {
        if (outroVideoTimeout) clearTimeout(outroVideoTimeout);
        outroVideo.style.display = 'none';
        outroImage.style.display = 'block';
        outroLoadingText.textContent = 'è§†é¢‘åŠ è½½å¤±è´¥ï¼Œæ˜¾ç¤ºå›¾ç‰‡...';
        setTimeout(finalCloseAction, 3000);
    };
}

function debounce(func, delay) {
  let timeout;
  return function() {
    const context = this;
    const args = arguments;
    clearTimeout(timeout);
    timeout = setTimeout(() => func.apply(context, args), delay);
  };
}

// ======================= EVENT LISTENERS =======================
document.addEventListener('DOMContentLoaded', function() {
    // å¯åŠ¨ä¼˜åŒ–åçš„åŠ è½½æµç¨‹
    initializeAndLoadAssets();
    attemptVideoAutoplay();
    
    const orientationQuery = window.matchMedia("(orientation: landscape)");
    isLandscape = orientationQuery.matches;
    if (isLandscape && !hasShownLandscapeMessage && document.getElementById('loading-screen').style.display === 'none' && document.getElementById('start-screen').style.display === 'none') {
        showEventMessage('âœ¨', 'å‘ç°äº†æ–°åŠŸèƒ½ï¼<br>æ¨ªå±æ¨¡å¼ä¸‹ï¼Œæ’¤é”€æŒ‰é’®ä¼šæš‚æ—¶ç¦ç”¨å“¦ï¼');
        hasShownLandscapeMessage = true;
    }
    function handleOrientationChange(event) {
        isLandscape = event.matches;
        updateToolButtons();
        if (isLandscape && !hasShownLandscapeMessage && document.getElementById('loading-screen').style.display === 'none' && document.getElementById('start-screen').style.display === 'none') {
            showEventMessage('âœ¨', 'å‘ç°äº†æ–°åŠŸèƒ½ï¼<br>æ¨ªå±æ¨¡å¼ä¸‹ï¼Œæ’¤é”€æŒ‰é’®ä¼šæš‚æ—¶ç¦ç”¨å“¦ï¼');
            hasShownLandscapeMessage = true;
        } else if (!isLandscape) {
            hasShownLandscapeMessage = false;
        }
    }
    orientationQuery.addEventListener('change', handleOrientationChange);

    if (window.DeviceMotionEvent) {
        window.addEventListener('devicemotion', handleDeviceMotion);
    } else {
        console.log("æ­¤è®¾å¤‡ä¸æ”¯æŒæ‘‡ä¸€æ‘‡åŠŸèƒ½ã€‚");
    }

    document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
            bgm.pause();
        } else {
            if (audioContext && audioContext.state === 'suspended') {
                audioContext.resume().catch(e => console.error("AudioContext resume failed on visibility change.", e));
            }
            const isGameEndScreenVisible = document.getElementById('level-finish').style.display === 'flex' || document.getElementById('game-over').style.display === 'flex';
            if (game.bgmOn && !isGameEndScreenVisible) {
                bgm.play().catch(e => console.error("BGM resume failed", e));
            }
        }
    });

    const feedbackDiv = document.createElement('div');
    feedbackDiv.style.cssText = 'color: red; font-size: 12px; margin-top: 5px;';
    codeInput.parentNode.insertBefore(feedbackDiv, codeInput.nextSibling);
    codeInput.addEventListener('input', function() {
        const code = codeInput.value.trim();
        feedbackDiv.textContent = '';
        codeInput.style.borderColor = '';
        const codeRegex = /^[\u4e00-\u9fa5a-zA-Z0-9]*$/;
        if (code.length === 7) {
            if (codeRegex.test(code)) {
                feedbackDiv.textContent = 'å­—ç¬¦æ•°æ­£ç¡®';
                feedbackDiv.style.color = 'green';
                codeInput.style.borderColor = 'green';
                codeBtn.disabled = false;
                codeBtn.click();
            } else {
                feedbackDiv.textContent = 'å…‘æ¢ç åŒ…å«ä¸æ”¯æŒçš„å­—ç¬¦';
                feedbackDiv.style.color = 'red';
                codeInput.style.borderColor = 'red';
                codeBtn.disabled = true;
            }
        } else if (code.length < 7) {
            feedbackDiv.textContent = `è¿˜å¯è¾“å…¥ ${7 - code.length} ä½`;
            feedbackDiv.style.color = 'orange';
            codeInput.style.borderColor = 'orange';
        } else {
            codeBtn.disabled = true;
        }
    });
    codeBtn.addEventListener('click', function() {
       codeInput.value = '';
       feedbackDiv.textContent = '';
       codeInput.style.borderColor = '';
    });
    codeBtn.disabled = true;
    codeInput.addEventListener('keyup', e => { if (e.key === 'Enter' && !codeBtn.disabled) codeBtn.click(); });

    window.addEventListener('resize', debounce(handleResize, 200));
    handleResize(); 

    skipOutroBtn.addEventListener('click', () => handleCloseGame('level'));

    if (walkingCat) {
        walkingCat.addEventListener('animationiteration', () => {
            isCatMirrored = !isCatMirrored;
            walkingCat.style.transform = isCatMirrored ? 'scaleX(-1)' : 'scaleX(1)';
        });
    }
});

undoBtn.onclick = function(){
  if(game.toolUses.undo > 0 && game.stepStack.length > 0){
    undoStep();
    game.toolUses.undo--;
    updateToolButtons();
  } else if (game.toolUses.undo > 0 && game.stepStack.length === 0) {
    showMessage('æ— æ³•æ’¤é”€æ›´å¤š', '#888');
  }
};
hintBtn.onclick = function(){
  if(game.toolUses.hint > 0){
    hintStep();
    game.toolUses.hint--;
    updateToolButtons();
  }
};
shuffleBtn.onclick = function(){
  if(game.toolUses.shuffle > 0){
    shuffleStep();
    game.toolUses.shuffle--;
    updateToolButtons();
  }
};
restartCurrentLevelBtn.onclick = () => showConfirm('ç¡®å®šè¦é‡æ–°å¼€å§‹å½“å‰å…³å¡å—ï¼Ÿ', () => {
    stopRandomEvents();
    stopCurtainRandomToggle();
    startGame(game.level);
    showMessage('å…³å¡å·²é‡æ–°å¼€å§‹ï¼', '#3e5a2b');
});
codeBtn.onclick = function(){
  let val = codeInput.value.trim().toLowerCase();
  if (REDEMPTION_CODES[val]) {
    const rewards = REDEMPTION_CODES[val];
    if (rewards.type === "skip_level") {
      game.board.forEach(card => card.matched = true);
      game.score = game.targetScore;
      renderBoard();
      renderProgressAndScore();
      checkWin();
      showMessage(`å…‘æ¢æˆåŠŸï¼å½“å‰å…³å¡å·²è·³è¿‡ï¼`, "#3e5a2b");
    } else if (rewards.type === "curtain_off") {
        game.isCurtainEnabled = false;
        toggleCurtain(true);
        stopCurtainRandomToggle();
        showMessage(`å…‘æ¢æˆåŠŸï¼å¹•å¸ƒå·²åœ¨æœ¬å…³å¡å…³é—­ï¼`, "#3e5a2b");
    }
    else {
      game.toolUses.undo += rewards.undo;
      game.toolUses.hint += rewards.hint;
      game.toolUses.shuffle += rewards.shuffle;
      showMessage(`å…‘æ¢æˆåŠŸï¼è·å¾—æ’¤é”€x${rewards.undo}, æç¤ºx${rewards.hint}, æ´—ç‰Œx${rewards.shuffle}`, "#3e5a2b");
    }
    updateToolButtons();
  } else {
    showMessage('å…‘æ¢ç é”™è¯¯', "#c0392b");
  }
  codeInput.value = '';
};
musicToggleBtn.onclick = function(){
  game.bgmOn = !game.bgmOn;
  this.innerHTML = game.bgmOn ? 'ğŸ¼' : 'ğŸ”‡';
  playBgm(game.bgmOn);
};
startBtn.onclick = function(){
  document.getElementById('start-screen').style.display = 'none';
  initAudio(); 
  startGame(1);
};
nextBtn.onclick = function(){
  document.getElementById('level-finish').style.display = 'none';
  startGame(2);
};
retryBtnLevelFinish.onclick = function(){
  document.getElementById('level-finish').style.display = 'none';
  startGame(game.level);
};
retryBtnGameOver.onclick = function(){
  document.getElementById('game-over').style.display = 'none';
  startGame(game.level);
};
gobangBtn.onclick = () => window.open('https://www.kaiyuanzhu.qzz.io/kaiyuan/', '_blank');
restartGameBtn.onclick = () => window.location.href = 'https://www.kaiyuanzhu.qzz.io/cat/';
closeGameBtnLevel.onclick = () => handleCloseGame('level');
closeGameBtnGameOver.onclick = () => handleCloseGame('gameover');
</script>

</body>
</html>
