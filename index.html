<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
  <title>è‡­å®åŠ è½½ä¸­...</title>
  <link rel="icon" type="image/png" sizes="96x96" href="me.png">
  <link rel="preload" href="mao3.webp" as="image">
  <link rel="preload" href="mao1.webp" as="image">
  <link rel="preload" href="font/iconfont.css" as="style">
  <link rel="preload" href="css/style.css" as="style">
  <link rel="preload" href="https://fonts.cdnfonts.com/s/72921/hanyisentyjilian.woff" as="font" crossorigin>
  <link rel="preload" href="mao.webp" as="image">
  <link rel="preload" href="mao.mp4" as="video">
  <link rel="preload" href="cat1.webp" as="image">
  <link rel="preload" href="js/index.js" as="script">
  <link rel="preload" href="Get.mp3" as="audio">
  <link rel="preload" href="kaa.mp3" as="audio">
  <!-- Preload mao2.mp4 and mao2.webp for level 2 outro -->
  <link rel="preload" href="mao2.mp4" as="video">
  <link rel="preload" href="mao2.webp" as="image">
  <style>
    /* Keyframe animations */
    @keyframes card-entry {
      0% { opacity: 0; transform: scale(0.5) translateY(-50px); }
      70% { opacity: 1; transform: scale(1.05) translateY(10px); }
      100% { opacity: 1; transform: scale(1) translateY(0); }
    }

    @font-face {
        font-family: 'HanyiSentyLotus';
        src: url('https://fonts.cdnfonts.com/s/72921/hanyisentyjilian.woff') format('woff');
        font-weight: normal;
        font-style: normal;
    }
    /* Fallback for FangSong, using local system fonts */
    @font-face {
        font-family: 'FangSong';
        src: local('FangSong'), local('æ–¹æ­£ä»¿å®‹ç®€ä½“'), local('FZFSJW');
        font-weight: normal;
        font-style: normal;
    }
    @keyframes pulse-scale {
      0%, 100% { transform: scale(1); opacity: 0.8; }
      50% { transform: scale(1.05); opacity: 1; }
    }
    @keyframes text-progress {
      0% { content: "."; }
      33% { content: ".."; }
      66% { content: "..."; }
      100% { content: "."; }
    }
    @keyframes wave {
      0%, 100% { transform: translateY(0) rotate(0deg); }
      25% { transform: translateY(-10px) rotate(2deg); }
      75% { transform: translateY(5px) rotate(-1deg); }
    }
    @keyframes show-card-property {
      0% { opacity: 0; }
      20% { opacity: 1; }
      80% { opacity: 1; }
      100% { opacity: 0; }
    }
    @keyframes fade-in-out-scale {
      0% { opacity: 0; transform: scale(0.8); }
      50% { opacity: 1; transform: scale(1); }
      100% { opacity: 0; transform: scale(0.9); }
    }
    @keyframes shake {
      0%, 100% { transform: translateX(0) rotate(0deg); }
      10%, 30%, 50%, 70%, 90% { transform: translateX(-3px) rotate(-1deg); }
      20%, 40%, 60%, 80% { transform: translateX(3px) rotate(1deg); }
    }

    /* New: Score Pop Animation */
    @keyframes score-pop {
      0% { opacity: 0; transform: translateY(0) scale(0.8); }
      20% { opacity: 1; transform: translateY(-15px) scale(1.1); }
      80% { opacity: 1; transform: translateY(-30px) scale(1); }
      100% { opacity: 0; transform: translateY(-40px) scale(0.7); }
    }
    .score-animation {
      position: absolute;
      font-size: 1.5rem;
      font-weight: bold;
      color: #4CAF50; /* Green for positive score */
      text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
      pointer-events: none; /* Make it non-interactive */
      animation: score-pop 1s ease-out forwards;
      z-index: 2000; /* Ensure it's above other elements */
    }

    /* New: Card Shuffle Out Animation */
    @keyframes card-shuffle-out {
      0% { opacity: 1; transform: scale(1) rotate(0deg); }
      50% { opacity: 0; transform: scale(0.5) rotate(15deg); }
      100% { opacity: 0; transform: scale(0.5) rotate(15deg); } /* Stay hidden */
    }
    .card-shuffling-out {
      animation: card-shuffle-out 0.3s ease-in forwards;
    }

    /* New: Heart Animation */
    @keyframes fade-in-out-heart {
      0% { opacity: 0; transform: scale(0.5); }
      50% { opacity: 1; transform: scale(1.2); }
      100% { opacity: 0; transform: scale(0.8); }
    }
    .heart-animation {
      position: absolute;
      font-size: 40px; /* User requested 40px */
      color: #ff69b4; /* Pink color for heart */
      pointer-events: none;
      animation: fade-in-out-heart 1.5s ease-out infinite alternate; /* Changed to infinite alternate */
      z-index: 1000; /* Ensure it's above cards but below cat wiggler if needed */
      text-shadow: 1px 1px 3px rgba(0,0,0,0.2);
    }

    /* Global body styles */
    body {
      margin: 0;
      min-height: 100vh;
      overflow-x: hidden;
      font-family: 'FangSong', 'Segoe UI', 'PingFang SC', 'Helvetica Neue', Arial, 'Microsoft Yahei', sans-serif;
      color: #3e2723;
      position: relative; /* Key: provides positioning reference for pseudo-elements */
    }
    /* Body background image */
    body::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #f7f0e8 url('cat1.webp') no-repeat center center fixed;
      background-size: cover;
      z-index: -2; /* Placed below content */
    }
    /* Body overlay for transparency */
    body::after {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: white;
      opacity: 0.3; /* 30% transparent white mask */
      z-index: -1; /* Placed above background image, below content */
    }
    /* Disable scrolling for loading screen */
    body.no-scroll {
      overflow: hidden;
    }

    /* Game Container */
    #game-container {
      max-width: 650px;
      margin: 30px auto;
      background: rgba(255, 255, 255, 0.7);
      border-radius: 25px;
      box-shadow: 0 5px 25px rgba(100, 60, 40, 0.3);
      padding: 0 0 20px 0;
      position: relative; /* Crucial for absolute positioning of loading screen */
      min-height: 880px;
      display: flex;
      flex-direction: column;
      align-items: center;
      border: 3px solid #8B4513;
    }
    /* Responsive adjustments for game container */
    @media (max-width: 700px) {
      #game-container { max-width: 100vw; margin: 0; box-shadow: none; border-radius: 0; min-height: 100vh; border: none;}
    }

    /* Header Bar */
    #header-bar {
      width: 100%;
      padding: 15px 25px 0 25px;
      box-sizing: border-box;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: linear-gradient(to bottom, rgba(255,255,255,0.8), rgba(255,255,255,0));
      border-top-left-radius: 22px;
      border-top-right-radius: 22px;
    }
    #progress-info {
      font-size: 1.55rem;
      font-weight: bold;
      color: #5d4037;
      text-shadow: 0.5px 0.5px 0 rgba(255,255,255,0.7);
      display: flex; /* Make it a flex container */
      gap: 15px; /* Space between level/cards and score/target */
      align-items: center;
    }
    #music-toggle {
      background: none;
      border: none;
      outline: none;
      font-size: 1.8rem;
      cursor: pointer;
      color: #6d4c41;
      transition: transform 0.2s ease-in-out;
    }
    #music-toggle:hover {
      transform: scale(1.1);
    }
    .score-display, .target-display {
        font-size: 1.2rem; /* Slightly smaller than main progress */
        color: #8B4513; /* A distinct color for score/target */
        font-weight: bold;
        text-shadow: 0.5px 0.5px 0 rgba(255,255,255,0.7);
    }

    /* Main Game Area */
    #main-area {
      flex:1;
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      position: relative; /* Crucial for absolute positioning of cat-path */
    }

    /* Display Area */
    #display-area {
        margin-top: 20px;
        width: 580px;
        min-height: 100px; /* Adjust height as needed */
        background: rgba(240, 230, 210, 0.6);
        border-radius: 15px;
        box-shadow: inset 0 2px 10px rgba(100, 60, 40, 0.15), 0 5px 15px rgba(100, 60, 40, 0.2);
        /* MODIFICATION START: æ¨ªå‘æ’åˆ— */
        display: flex;
        flex-direction: row; /* Changed from column to row */
        flex-wrap: wrap; /* Allow items to wrap to the next line */
        justify-content: center; /* Center items horizontally */
        align-items: center;
        /* MODIFICATION END */
        border: 2px dashed #b8860b;
        padding: 10px;
        box-sizing: border-box;
        gap: 10px; /* Space between display groups */
    }
    @media (max-width: 650px) {
      #display-area {
        width: 96vw;
        min-width: 250px;
        min-height: 80px;
      }
    }

    .display-group {
        display: flex;
        gap: 5px; /* Space between cards in a display group */
        align-items: center;
        justify-content: center;
        background: rgba(255, 255, 255, 0.5);
        border-radius: 8px;
        padding: 5px 10px;
        border: 1px solid #d4a762;
    }

    .display-card {
        width: 45px; /* Smaller size for display cards */
        height: 60px;
        background: #fffdf7;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        border: 2px solid #a0522d;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.8rem; /* Smaller font size */
        color: #5d4037;
        user-select: none;
        opacity: 1;
        transition: opacity 0.3s ease-out;
    }
    .display-card.matched-display {
        opacity: 0; /* Fade out when matched */
    }

    /* Cat Animation Path (Left Cat) */
    #cat-path {
        position: absolute;
        width: 100%; /* Spans the width of its parent (#main-area) */
        height: 20px; /* Height of the gap */
        left: 0; /* Align with parent's left edge */
        /* top will be set by JS */
        z-index: 100; /* Ensure it's visible */
        pointer-events: none; /* Crucial: allows clicks to pass through to cards */
        overflow: visible; /* Allow cat to overflow if it's larger than path height */
        /* background-color: rgba(255, 0, 0, 0.1); /* For debugging positioning */
    }

    /* MODIFICATION: Updated cat-walk keyframes - removed transform */
    @keyframes cat-walk {
        0% { left: 0; }
        100% { left: calc(100% - 35px); } /* Moves across the width of #cat-path */
    }

    #walking-cat {
        position: absolute; /* Position within #cat-path */
        width: 40px; /* New size */
        height: 40px; /* New size */
        font-size: 40px; /* Match font size to element size for emoji */
        line-height: 1; /* Ensure emoji sits correctly */
        display: flex;
        align-items: center;
        justify-content: center;
        color: #5d4037; /* Cat color */
        top: -7.5px; /* (20px - 35px) / 2 = -7.5px to center 35px cat in 20px path */
        transform: scaleX(1); /* Initial state */
        transition: transform 0.01s linear, opacity 0.01s linear; /* Quick transition for mirroring */
        animation: cat-walk 4s linear infinite alternate; /* Animation */
    }

    /* New: Cat Wiggler Instances (Right Cat) */
    .wiggling-cat-instance {
        position: absolute;
        width: 35px;
        height: 35px;
        font-size: 35px;
        line-height: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #5d4037;
        transform: translateX(-50%); /* Center horizontally within its position */
        animation: shake 0.8s ease-in-out infinite alternate; /* Use existing shake animation */
        z-index: 1000; /* Higher z-index to be on top of cards/temp-area */
        pointer-events: none;
        display: none; /* Hidden by default, controlled by JS */
    }


    /* Card Stack Area */
    #card-stack-area {
      margin-top: 20px; /* This margin creates the gap where the cat animates */
      width: 580px;
      height: 500px;
      position: relative;
      background: rgba(240, 230, 210, 0.6);
      border-radius: 15px;
      box-shadow: inset 0 2px 10px rgba(100, 60, 40, 0.15), 0 5px 15px rgba(100, 60, 40, 0.2);
      overflow: visible;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2px dashed #b8860b;
    }
    /* Responsive adjustments for card stack area */
    @media (max-width: 650px) {
      #card-stack-area {
        width: 96vw;
        min-width: 250px;
        height: 420px;
      }
    }

    /* Individual Card Styles */
    .card {
      width: 65px;
      height: 85px;
      background: #fffdf7;
      border-radius: 10px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1), inset 0 0 0 1px rgba(255,255,255,0.5);
      border: 3px solid #d4a762;
      position: absolute;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.6rem;
      cursor: pointer;
      user-select: none;
      transition: transform 0.15s ease-out, box-shadow 0.15s ease-out, opacity 0.3s, border-color 0.15s;
      z-index: 1;
      overflow: hidden;
      color: #5d4037;
      -webkit-user-select: none; /* For WebKit browsers (Chrome, Safari) */
      -moz-user-select: none; /* For Firefox */
      -ms-user-select: none; /* For Internet Explorer/Edge */
    }
    .card-entering {
      animation: card-entry 0.5s ease-out forwards; /* Adjust duration and easing as needed */
    }
    .hint-animation {
      animation: show-card-property 2s forwards; /* Example duration and fill-mode */
    }
    .card.selected {
      border: 3.5px solid #a0522d;
      box-shadow: 0 4px 20px rgba(160, 82, 45, 0.4), 0 0 25px rgba(255,255,0,0.5);
      z-index: 100 !important;
      transform: scale(1.01) rotate(-2deg);
    }
    .card.disabled {
      pointer-events: none;
      position: absolute;
      opacity: 1; /* Keep opacity for disabled cards */
    }
    .card.disabled::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(128, 128, 128, 0.4);
      border-radius: 8px;
      z-index: 2;
      transition: background 0.5s ease;
    }
    .card.disabled > *:not(.disabled::before) {
        opacity: 0.5;
    }
    .card:not(.disabled):not(.matched):hover {
      transform: translateY(-5px) scale(1.05) rotate(2deg);
      box-shadow: 0 8px 20px rgba(0,0,0,0.15), inset 0 0 0 1px rgba(255,255,255,0.5);
      transition: transform 0.1s ease-out, box-shadow 0.05s ease-out;
      z-index: 2;
    }
    .card.matched {
      opacity: 0.05;
      transition: opacity 0.2s;
      pointer-events: none;
    }
    .card .mini {
      font-size: 1.2rem;
      position: absolute;
      bottom: 7px;
      right: 9px;
      opacity: 0.5;
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
    }

    /* Temporary Area (Temp Slot) */
    #temp-area {
      margin: 20px auto 0 auto;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 80px;
      width: 500px;
      border-radius: 12px;
      background: #fffcf0;
      border: 2px dashed #b8860b;
      padding: 8px 0;
      box-sizing: border-box;
      box-shadow: inset 0 1px 5px rgba(0,0,0,0.08);
    }
    .temp-slot {
      width: 63px;
      height: 80px;
      margin: 0 6px;
      background: #fdf5e6;
      border-radius: 9px;
      border: 2px dashed #d4a762;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      color: #92776c;
      box-shadow: inset 0 1px 4px rgba(0,0,0,0.05);
      position: relative;
      overflow: hidden;
    }
    .temp-card {
      width: 100%;
      height: 100%;
      background: #fffdf7;
      border-radius: 9px;
      border: 2.5px solid #a0522d;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.2rem;
      box-shadow: 0 2px 8px rgba(160, 82, 45, 0.3);
      cursor: default;
      position: absolute;
      transition: opacity 0.2s, border-color 0.2s, box-shadow 0.2s;
      box-sizing: border-box;
      color: #5d4037;
    }
    .temp-card.matched {
      opacity: 0.05;
    }

    /* Flying Card Animation */
    .flying-card {
      width: 65px;
      height: 85px;
      background: #fffdf7;
      border-radius: 10px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1), inset 0 0 0 1px rgba(255,255,255,0.5);
      border: 3px solid #d4a762;
      position: fixed;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.6rem;
      user-select: none;
      z-index: 10000; /* Ensured it's on top */
      transition: top 0.3s ease-in-out, left 0.3s ease-in-out, transform 0.3s ease-in-out;
      overflow: hidden;
      color: #5d4037;
    }

    /* Tools Bar */
    #tools-bar {
      margin: 20px auto 0 auto;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 18px;
      width: 500px;
      flex-wrap: wrap;
    }
    #tools-bar button {
      padding: 9px 18px;
      background: #f7e9d7;
      border: 2px solid #b8860b;
      border-radius: 10px;
      font-size: 1.05rem;
      color: #6e352f;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.15s, transform 0.1s;
      outline: none;
      position: relative;
      min-width: 75px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    #tools-bar button:hover {
      background: #e9d9c6;
      transform: translateY(-1px);
    }
    #tools-bar button:disabled {
      background: #f0f0f0;
      color: #b0b0b0;
      border-color: #d0d0d0;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    #restart-btn {
      background: #ffe0b3;
      border-color: #ffcc80;
      color: #96602c;
    }
    #restart-btn:hover {
      background: #ffd599;
    }

    /* Code Redemption Bar */
    #code-bar {
      margin: 15px auto 0 auto;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      width: 450px;
    }
    #code-bar input {
      width: 180px;
      padding: 7px 10px;
      border-radius: 8px;
      border: 2px solid #b8860b;
      outline: none;
      font-size: 1.05rem;
      color: #5d4037;
      background: #fffdf7;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
    }
    #code-bar input::placeholder {
      color: #a0a0a0;
    }
    #code-bar button {
      padding: 7px 12px;
      font-size: 1.05rem;
      background: #e6f6d3;
      border: 2px solid #a0c388;
      border-radius: 9px;
      cursor: pointer;
      color: #3e5a2b;
      font-weight: bold;
      transition: background 0.15s;
      min-width: 65px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    }
    #code-bar button:hover {
      background: #d2e5bb;
    }

    /* Message Bar */
    #message-bar {
      margin: 15px auto 0 auto;
      text-align: center;
      font-size: 1.1rem;
      color: #c0392b;
      min-height: 28px;
      font-weight: bold;
      letter-spacing: 1.2px;
    }

    /* Overlay Screens (Start, Level Finish, Game Over) */
    #start-screen, #level-finish, #game-over {
      position: absolute;
      left: 0; right: 0; top: 0; bottom: 0;
      z-index: 1100;
      background: rgba(255,255,255,0.98);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      font-size: 1.1rem;
      border-radius: 25px;
      text-align: center;
    }
    /* Start Screen Specific Styles */
    #start-screen {
      padding-top: 10vh;
      overflow: hidden; /* Ensure background video/image doesn't overflow */
      box-sizing: border-box;
    }
    
    /* MODIFICATION START: Video Background */
    #start-screen-video {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        min-width: 100%;
        min-height: 100%;
        width: auto;
        height: auto;
        z-index: -1; /* Sits on top of the ::before pseudo-element */
        opacity: 0.99;
        background-size: cover;
    }
    /* MODIFICATION END: Video Background */

    /* Start Screen background image (FALLBACK) */
    #start-screen::before {
      content: "";
      position: absolute;
      left: 0; right: 0; top: 0; bottom: 0;
      background-image: url('mao.webp');
      background-size: cover;
      background-position: center;
      opacity: 0.5; /* 50% opacity */
      z-index: -2; /* MODIFIED: Place it behind the video */
    }
    #start-screen h1 {
      font-size: 4rem;
      margin: 0 0 25px 0;
      letter-spacing: 3px;
      text-shadow: 2px 2px 0 #f7e9d7, 4px 4px 0 #b8860b;
      display: inline-block;
    }
    #start-screen h1 span {
      display: inline-block;
      animation: wave 2s infinite ease-in-out;
    }
    #start-screen h1 span:nth-child(1) { animation-delay: -0.4s; }
    #start-screen h1 span:nth-child(2) { animation-delay: -0.2s; }
    #start-screen h1 span:nth-child(3) { animation-delay: 0s; }
    #start-screen h1 span:nth-child(4) { animation-delay: 0.2s; }
    #start-screen h1 span:nth-child(5) { animation-delay: 0.4s; } /* For the last emoji */
    #start-screen .start-btn {
      margin-top: 30px;
      padding: 15px 50px;
      font-size: 1.4rem;
      background: linear-gradient(90deg, #a0c388, #88b368);
      border: none;
      border-radius: 15px;
      color: #3e5a2b;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(160, 195, 136, 0.5);
      animation: pulse-scale 1.5s infinite ease-in-out;
      transition: background 0.2s, transform 0.1s;
    }
    #start-screen .start-btn:hover {
      background: linear-gradient(90deg, #88b368, #a0c388);
      transform: translateY(-2px);
    }
    #start-screen p {
        color: #5d4037;
        line-height: 1.6;
        margin: 0 40px 15px;
        margin-top: 15vh; /* Pushed down from title */
    }
    #start-screen span {
        color: #c0392b;
        font-weight: bold;
    }

    /* Footer for loading and start screens */
    .loading-footer {
        color: #795548;
        font-size: 0.85rem;
        position: absolute;
        bottom: 30px;
        left: 0;
        right: 0;
        text-align: center;
        font-family: 'FangSong', 'Comic Sans MS', cursive;
        letter-spacing: 1.5px;
        text-shadow: 0.5px 0.5px 0 rgba(255,255,255,0.5);
    }

    /* Level Finish and Game Over Screens */
    #level-finish, #game-over {
      font-size: 1.8rem;
      font-family: 'Segoe UI', 'PingFang SC', 'Helvetica Neue', Arial, 'Microsoft Yahei', sans-serif;
      color: #5d4037;
      background: rgba(255,243,245,0.99);
      border-radius: 25px;
      position: absolute;
      overflow: hidden; /* Ensure background image doesn't overflow */
      border: 3px solid #8B4513; /* Consistent with game container border */
      box-shadow: 0 5px 25px rgba(100, 60, 40, 0.3); /* Consistent with game container shadow */
    }
    #game-over {
      animation: wave 2s infinite; /* Add these lines */
    }
    #level-finish::before, #game-over::before {
      content: "";
      position: absolute;
      left: 0;
      right: 0;
      top: 0;
      bottom: 0;
      background-image: url('mao1.webp'); /* Use same background image as start screen */
      background-size: cover;
      background-position: center;
      opacity: 0.4; /* 40% opacity */
      z-index: -1; /* Ensure background is behind content */
    }
    #level-finish button, #game-over button {
      margin-top: 25px;
      padding: 12px 35px;
      font-size: 1.25rem;
      background: #e6f6d3;
      border: 2px solid #a0c388;
      border-radius: 12px;
      color: #3e5a2b;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.15s, transform 0.1s;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    #level-finish button:hover, #game-over button:hover {
      background: #d2e5bb;
      transform: translateY(-1px);
    }
    #retry-btn {
      margin-top: 18px;
      padding: 10px 30px;
      font-size: 1.15rem;
      background: #f7e9d7;
      border: 2px solid #d4a762;
      border-radius: 10px;
      color: #6e352f;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.15s, transform 0.1s;
      display: inline-block;
      box-shadow: 0 1px 5px rgba(0,0,0,0.1);
    }
    #retry-btn:hover {
      background: #f0e1d0;
      transform: translateY(-1px);
    }

    /* Main Game Footer */
    #footer {
      margin: 20px auto 0 auto;
      width: 100%;
      text-align: center;
      font-size: 1rem;
      color: #8B4513;
      font-family: 'FangSong', 'Comic Sans MS', cursive;
      letter-spacing: 1.5px;
      text-shadow: 0.5px 0.5px 0 rgba(255,255,255,0.5);
    }

    /* Styles for Level 2 on ALL devices to reduce difficulty */
    body.level-2-active .card {
      width: 50px;
      height: 65px;
      font-size: 2rem;
      border-width: 2px;
      border-radius: 8px;
    }
    body.level-2-active .flying-card {
      width: 50px;
      height: 65px;
      font-size: 2rem;
      border-width: 2px;
      border-radius: 8px;
    }
    body.level-2-active .temp-slot {
      width: 45px;
      height: 60px;
      margin: 0 4px;
      border-width: 1.5px;
      border-radius: 7px;
    }
    body.level-2-active .temp-card {
      font-size: 1.8rem;
      border-width: 1.5px;
      border-radius: 7px;
    }
    body.level-2-active #temp-area {
      width: 380px;
      min-height: 65px;
      padding: 6px 0;
    }
    body.level-2-active #card-stack-area {
      height: 420px;
    }

    /* Hint Animation */
    .hinted-shake {
      animation: shake 0.5s ease-in-out 4; /* Adjust duration and iteration count as needed */
    }

    /* Custom Confirm Modal Styles */
    .modal-overlay {
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.6);
        z-index: 2500; /* Increased z-index to ensure modal is on top */
        display: none;
        align-items: center;
        justify-content: center;
    }
    .modal-content {
        background: #fffdf7;
        padding: 30px 40px;
        border-radius: 15px;
        text-align: center;
        box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        border: 3px solid #d4a762;
    }
    .modal-content p {
        font-size: 1.2rem;
        color: #5d4037;
        margin: 0 0 25px 0;
        font-weight: bold;
    }
    .modal-content button {
        padding: 9px 25px;
        background: #f7e9d7;
        border: 2px solid #b8860b;
        border-radius: 10px;
        font-size: 1.05rem;
        color: #6e352f;
        font-weight: bold;
        cursor: pointer;
        margin: 0 10px;
        transition: background 0.15s, transform 0.1s;
    }
    #confirm-yes {
        background: #e6f6d3;
        border-color: #a0c388;
        color: #3e5a2b;
    }
    #confirm-yes:hover {
        background: #d2e5bb;
    }
    #confirm-no:hover {
        background: #e9d9c6;
    }

    /* Level Finish Text */
    #level-finish-text {
      font-family: 'Microsoft Yahei','Segoe UI', 'PingFang SC', 'Helvetica Neue', Arial, sans-serif;
      color: #3e2723;
      font-size: 1.2em; /* Adjust font size as needed */
      text-align: center;
      margin-bottom: 20px;
    }

    /* Loading Screen Styles */
    #loading-screen {
      /* Changed from fixed to absolute, so it's relative to #game-container */
      position: absolute;
      top: 0; left: 0; width: 100%; height: 100%;
      z-index: 1199; /* Keep a high z-index to cover content within game-container */
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: #f7f0e8; /* Game's main background color */
      background-size: cover;
      transition: opacity 0.5s ease-out;
      border-radius: 25px; /* Inherit parent's border-radius for visual consistency */
      overflow: hidden; /* Hide overflow if content goes beyond rounded corners */
    }
    #loading-screen::before {
      content: '';
      /* Changed from fixed to absolute */
      position: absolute;
      top: 0; left: 0; width: 100%; height: 100%;
      background-image: url('mao3.webp');
      background-repeat: no-repeat;
      background-position: center center;
      /* Removed background-attachment: fixed; as it's no longer full screen */
      background-size: cover;
      opacity: 0.6;
    }
    .loading-content {
      position: relative;
      z-index: 1001;
      text-align: center;
      width: 80%;
      max-width: 500px;
      display: flex;
      flex-direction: column;
      height: 100%;
      align-items: center;
      justify-content: flex-start;
      padding-top: 6vh;
      box-sizing: border-box;
    }
    .loading-title {
      font-size: 2.8rem;
      margin: 0 0 40px 0;
      font-family: 'FangSong', 'Segoe UI', 'PingFang SC', 'Helvetica Neue', Arial, 'Microsoft Yahei', sans-serif;
      color: #3e2723;
      letter-spacing: 3px;
      text-shadow: 2px 2px 0 #f7e9d7, 4px 4px 0 #b8860b;
      animation: pulse-scale 1.5s infinite ease-in-out;
    }
    .loading-title::after {
      content: ".";
      animation: text-progress 2s infinite;
    }
    .progress-bar-container {
      width: 100%;
      height: 30px;
      background: rgba(184, 134, 11, 0.2);
      border-radius: 10px;
      border: 2px solid #b8860b;
      overflow: hidden;
      margin-bottom: 15px;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
      margin-top: 40vh; /* Pushed down from the title */
      z-index: 1004;
    }
    #progress-bar {
      width: 0%;
      height: 100%;
      background: linear-gradient(90deg, #a0c388, #88b368);
      border-radius: 8px;
      transition: width 0.3s ease-out;
    }
    #loading-text {
      font-size: 1.1rem;
      color: #5d4037;
      margin-bottom: 40px;
      min-height: 20px;
      text-align: center;
    }

    /* Responsive Video Container for Bilibili Player */
    .responsive-video-container {
        position: relative;
        width: 100%;
        max-width: 660px; /* Or a suitable max-width for the video */
        padding-bottom: 68.1818%; /* 16:9 Aspect Ratio (9 / 16 * 100%) */
        height: 0;
        overflow: hidden;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    .responsive-video-container iframe {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        border: 0;
        border-radius: 10px;
    }

    /* MODIFICATION: New Level 2 Outro Screen Styles */
    #level2-outro-screen {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.9); /* Dark overlay */
        z-index: 2000; /* Above all game elements */
        display: none; /* Hidden by default */
        flex-direction: column;
        align-items: center;
        justify-content: center;
        border-radius: 25px; /* Inherit game container border-radius */
        overflow: hidden;
    }

    /* MODIFICATION: Fullscreen video styles for outro */
    #level2-outro-screen video {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        min-width: 100%;
        min-height: 100%;
        width: auto;
        height: auto;
        object-fit: cover; /* This is key for full-screen without black borders */
        border-radius: 0; /* Remove border-radius for full screen effect */
        box-shadow: none; /* Remove shadow for full screen effect */
    }
    #level2-outro-screen img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain; /* Image should probably still contain to avoid cropping */
        border-radius: 15px; /* Keep for image fallback */
        box-shadow: 0 0 30px rgba(255, 255, 255, 0.3); /* Keep for image fallback */
    }
    #level2-outro-screen .loading-text {
        color: white;
        font-size: 1.5rem;
        margin-top: 20px;
    }

    /* Style for the Skip Outro Button */
    #skip-outro-btn {
        position: absolute;
        top: 20px;
        right: 20px;
        padding: 8px 15px;
        background: rgba(255, 255, 255, 0.7);
        border: 1px solid #ccc;
        border-radius: 8px;
        font-size: 1rem;
        color: #333;
        cursor: pointer;
        z-index: 2001; /* Above video and loading text */
        transition: background 0.2s, transform 0.2s;
    }
    #skip-outro-btn:hover {
        background: rgba(255, 255, 255, 0.9);
        transform: scale(1.05);
    }


    /* Media Queries for smaller screens */
    @media (max-width: 500px) {
      #card-stack-area, #temp-area, #tools-bar, #code-bar { width: 98vw; }
      #tools-bar button {
          min-width: unset;
          width: 30%;
          margin-bottom: 8px;
          padding: 8px 10px;
          font-size: 0.95rem;
      }
      #tools-bar {
          gap: 6px;
      }
      #temp-area {
        width: 98vw;
        margin: 15px auto 0 auto;
      }
      .temp-slot {
        width: 12vw;
        height: 16vw;
        margin: 0 0.8vw;
      }
      .temp-card {
        font-size: 6vw;
      }
      .card {
        width: 15vw;
        height: 20vw;
        font-size: 8vw;
      }
      body.level-2-active .card {
        width: 12vw;
        height: 16vw;
        font-size: 6vw;
      }
      body.level-2-active .temp-slot {
        width: 11vw;
        height: 15vw;
        margin: 0 0.8vw;
      }
      #code-bar input {
        width: 50%;
      }
      #display-area {
        width: 96vw;
        padding: 5px;
      }
      .display-card {
        width: 10vw;
        height: 13vw;
        font-size: 4.5vw;
      }
    }
  </style>
  <link rel="stylesheet" href="font/iconfont.css">
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
<div id="game-container">
  <div id="loading-screen">
    <div class="loading-content">
      <h1 class="loading-title">Loading.</h1>
      <div class="progress-bar-container">
        <div id="progress-bar"></div>
      </div>
      <p id="loading-text">æ­£åœ¨åŠ è½½èµ„æº...</p>
      <small class="loading-footer">å–µäº†ä¸ªå’ª &copy; 2025 | Designed by å¼€å…ƒ</small>
    </div>
  </div>

  <div id="header-bar">
    <div id="progress-info">
        <span id="level-info">å…³å¡: 1 / 2</span>
        <span class="score-display">åˆ†æ•°: <span id="current-score">0</span></span>
        <span class="target-display">ç›®æ ‡: <span id="target-score">0</span></span>
    </div>
    <button id="music-toggle" title="éŸ³ä¹å¼€å…³">ğŸ¼</button>
  </div>
  <div id="main-area">
    <div id="display-area">
        </div>
    <!-- Cat path element, positioned absolutely -->
    <div id="cat-path">
        <div id="walking-cat">ğŸ‚</div>
    </div>
    <div id="card-stack-area"></div>
    <!-- MODIFICATION: Removed cat-wiggler-path and wiggling-cat. Added three wiggling cat instances -->
    <div id="wiggling-cat-1" class="wiggling-cat-instance">ğŸ‘’</div>
    <div id="wiggling-cat-4" class="wiggling-cat-instance">ğŸ‘’</div>
    <div id="wiggling-cat-7" class="wiggling-cat-instance">ğŸ‘’</div>

    <div id="temp-area">
      <div class="temp-slot"></div>
      <div class="temp-slot"></div>
      <div class="temp-slot"></div>
      <div class="temp-slot"></div>
      <div class="temp-slot"></div>
      <div class="temp-slot"></div>
      <div class="temp-slot"></div>
    </div>
    <div id="tools-bar">
      <button id="undo-btn" disabled title="æ’¤é”€(éœ€å…‘æ¢ç )">â†©ï¸ æ’¤é”€ (<span id="undo-count">0</span>)</button>
      <button id="hint-btn" disabled title="æç¤º(éœ€å…‘æ¢ç )">ğŸ’¡ æç¤º (<span id="hint-count">0</span>)</button>
      <button id="shuffle-btn" disabled title="æ´—ç‰Œ(éœ€å…‘æ¢ç )">ğŸ”€ æ´—ç‰Œ (<span id="shuffle-count">0</span>)</button>
      <button id="restart-btn" title="é‡æ–°å¼€å§‹å½“å‰å…³å¡">ğŸ”„ é‡æ–°å¼€å§‹</button>
    </div>
    <div id="code-bar">
      <input type="text" id="code-input" placeholder="å…‘æ¢ç " maxlength="12">
      <button id="code-btn">å…‘æ¢</button>
    </div>
    <div id="message-bar"></div>
  </div>
  <div id="footer">
    å–µäº†ä¸ªå’ª &copy; 2025 | Designed by å¼€å…ƒ
  </div>

  <div id="start-screen">
    <video id="start-screen-video" autoplay loop muted playsinline>
  <source src="mao.webm" type="video/webm">
  <source src="mao.mp4" type="video/mp4">
  <img src="mao.webp" alt="èƒŒæ™¯å›¾">
</video>
    <h1><span>å–µ</span><span>äº†</span><span>ä¸ª</span><span>å’ª</span><span> ğŸ¾</span></h1>
    <p> </p> <p>
      <button class="start-btn" id="start-btn">å¼€å§‹æ¸¸æˆ</button>
    </p>
    <p>æ”¶é›†å¡ç‰Œï¼Œåˆ†æ•°è¾¾æ ‡ã€å…¨éƒ¨æ¸…ç©ºè¿‡å…³<br>
    <span style="color:#c0392b;">ç¬¬äºŒå…³éš¾åº¦ç•¥æœ‰å‡çº§<br></span>å¯ä½¿ç”¨å…‘æ¢ç è§£é”é“å…·</p>
    <small class="loading-footer">å–µäº†ä¸ªå’ª &copy; 2025 | Designed by å¼€å…ƒ</small>
  </div>

  <!-- MODIFICATION: New Level 2 Outro Screen -->
  <div id="level2-outro-screen" style="display:none;">
    <video id="outro-video" playsinline muted>
        <source src="mao2.mp4" type="video/mp4">
        æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾ã€‚
    </video>
    <img id="outro-image" src="mao2.webp" alt="Level 2 Outro Image" style="display:none;">
    <div class="loading-text" style="display:none;">æ­£åœ¨åŠ è½½...</div>
    <button id="skip-outro-btn" style="display:none;">è·³è¿‡åŠ¨ç”»</button> <!-- Added skip button -->
  </div>

  <div id="level-finish" style="display:none;">
    <div id="netease-player" class="responsive-video-container" style="display:none;">
      <iframe allow="autoplay *; encrypted-media *; fullscreen *; clipboard-write" frameborder="0" height="450" style="width:100%;max-width:660px;overflow:hidden;border-radius:10px;" sandbox="allow-forms allow-popups allow-same-origin allow-scripts allow-storage-access-by-user-activation allow-top-navigation-by-user-activation" src="https://embed.music.apple.com/cn/playlist/favourite-music/pl.u-MDAWvoqtWXGMZrz"></iframe>
    </div>
    <div id="player" style="display:none;">
        <div id="player-content1">
            <div class="music-name"></div>
            <div class="artist-name"></div>
            <div class="time">
                <div class="current-time"></div>
                <div class="total-time"></div>
            </div>
            <div id="s-area">
                <div id="ins-time"></div>
                <div id="s-hover"></div>
                <div id="seek-bar"></div>
            </div>
        </div>
        <div id="player-content2">
            <div class="music-imgs">
                <div class="img"></div>
                <div id="buffer-box">ç¼“å†²,ç¨ç­‰â€¦</div>
            </div>
            <div class="player-controls">
                <div class="btn prev iconfont">&#xe603;</div>
                <div class="btn play-pause icon-jiediankaishi iconfont"></div>
                <div class="btn next iconfont">&#xe602;</div>
            </div>
        </div>
    </div>
    <div id="level-finish-text"></div>
    <button id="next-btn">ä¸‹ä¸€å…³</button>
    <button id="retry-btn" style="margin-left:10px;">é‡ç©</button>
    <button id="gobang-btn" style="margin-left:10px; display:none;">äº”å­æ£‹å¯¹å¼ˆ</button>
    <button id="restart-game-btn" style="margin-left:10px; display:none;">é‡å¼€æ¸¸æˆ</button>
    <button id="close-game-btn-level" style="margin-left:10px;">å…³é—­æ¸¸æˆ</button>
  </div>

  <div id="game-over" style="display:none;">
    <div id="game-over-text"></div>
    <button id="retry-btn2">é‡è¯•</button>
    <button id="close-game-btn-gameover" style="margin-left:10px;">å…³é—­æ¸¸æˆ</button>
  </div>
</div>

<div id="confirm-modal" class="modal-overlay">
  <div class="modal-content">
    <p id="confirm-msg">ä½ ç¡®å®šå—ï¼Ÿ</p>
    <div class="modal-buttons">
        <button id="confirm-yes">ç¡®å®š</button>
        <button id="confirm-no">å–æ¶ˆ</button>
    </div>
  </div>
</div>

<audio id="bgm" loop preload="auto">
  <source src="Get.mp3" type="audio/mpeg">
  <source src="Get.ogg" type="audio/ogg">
  æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘å…ƒç´ ã€‚
</audio>
<audio id="click-sound" src="kaa.mp3" preload="auto"></audio>

<script src="js/jquery-3.4.1.min.js"></script>
<script src="js/index.js"></script>

<script>
// æ¸¸æˆé…ç½®å¸¸é‡
const CARD_ICONS = [
  "ğŸˆ", "ğŸ’", "ğŸª¼", "ğŸ‘’", "ğŸµï¸", "ğŸ§¸", "ğŸ¬", "ğŸ”®", "ğŸ¡", "ğŸˆâ€â¬›", "ğŸ«", "ğŸª­",
  "ğŸ–", "ğŸ§¶", "ğŸŒ»", "ğŸ¦‹", "ğŸ’"
];
const LEVELS = [
  {num: 1, visible: 18, total: 30, stack: 1, rows: 3, cols: 6, overlap: 30, targetScore: 25, totalDisplaySets: 5},
  {num: 2, visible: 60, total: 180, stack: 2, rows: 7, cols: 9, overlap: 24, targetScore: 100, totalDisplaySets: 20}
];
const TEMP_LIMIT = 7; // æš‚å­˜åŒºæœ€å¤§å¡ç‰‡æ•°é‡
const DISPLAY_CARD_MATCH_SCORE = 5; // åŒ¹é…ä¸€ç»„å±•ç¤ºå¡ç‰‡çš„åˆ†æ•°
const INITIAL_DISPLAY_SETS_VISIBLE = 2; // åˆå§‹å¯è§çš„å±•ç¤ºå¡ç‰‡ç»„æ•°é‡

/*
 * å…‘æ¢ç é…ç½®ã€‚
 * é”®æ˜¯å…‘æ¢ç ï¼ˆå°å†™ï¼‰ã€‚
 * å€¼æ˜¯æŒ‡å®šæ¯ä¸ªå·¥å…·æ•°é‡æˆ–ç‰¹æ®Šç±»å‹çš„å¯¹è±¡ã€‚
 */
const REDEMPTION_CODES = {
  "kaiyuan": { undo: 20, hint: 20, shuffle: 20 },
  "å…‘æ¢ç ": { undo: 5, hint: 5, shuffle: 5 },
  "å–µäº†ä¸ªå’ª": { undo: 50, hint: 50, shuffle: 50 },
  "ä¸çŸ¥é“": { undo: 3, hint: 1, shuffle: 1 },
  "å¼€å…ƒ": { undo: 10, hint: 10, shuffle: 10 },
  "é€šå…³": { type: "skip_level" } // æ·»åŠ äº†â€œè·³è¿‡å…³å¡â€å…‘æ¢ç 
};

// DOM å…ƒç´ 
const bgm = document.getElementById('bgm');
const confirmModal = document.getElementById('confirm-modal');
const confirmMsg = document.getElementById('confirm-msg');
const confirmYes = document.getElementById('confirm-yes');
const confirmNo = document.getElementById('confirm-no');
const footer = document.getElementById('footer');
const musicToggleBtn = document.getElementById('music-toggle');
const startBtn = document.getElementById('start-btn');
const nextBtn = document.getElementById('next-btn');
const retryBtnLevelFinish = document.getElementById('retry-btn');
const retryBtnGameOver = document.getElementById('retry-btn2');
const gobangBtn = document.getElementById('gobang-btn');
const restartGameBtn = document.getElementById('restart-game-btn');
const closeGameBtnLevel = document.getElementById('close-game-btn-level');
const closeGameBtnGameOver = document.getElementById('close-game-btn-gameover');
const undoBtn = document.getElementById('undo-btn');
const hintBtn = document.getElementById('hint-btn');
const shuffleBtn = document.getElementById('shuffle-btn');
const restartCurrentLevelBtn = document.getElementById('restart-btn');
const codeInput = document.getElementById('code-input');
const codeBtn = document.getElementById('code-btn');
const levelFinishTextElement = document.getElementById('level-finish-text');
const neteasePlayerDiv = document.getElementById('netease-player');
const playerDiv = document.getElementById('player'); // è‡ªå®šä¹‰éŸ³ä¹æ’­æ”¾å™¨
const currentScoreElement = document.getElementById('current-score');
const targetScoreElement = document.getElementById('target-score');
const levelInfoElement = document.getElementById('level-info');
// const cardCountInfoElement = document.getElementById('card-count-info'); // ç§»é™¤æ­¤è¡Œ
const displayArea = document.getElementById('display-area');
const catPath = document.getElementById('cat-path'); // è·å–å°çŒ«è·¯å¾„å…ƒç´ 
const walkingCat = document.getElementById('walking-cat'); // è·å–è¡Œèµ°çŒ«å’ªå…ƒç´ 

// MODIFICATION: Get references to the three wiggling cat instances
const wigglingCat1 = document.getElementById('wiggling-cat-1');
const wigglingCat4 = document.getElementById('wiggling-cat-4');
const wigglingCat7 = document.getElementById('wiggling-cat-7');

// MODIFICATION: Level 2 Outro Screen elements
const level2OutroScreen = document.getElementById('level2-outro-screen');
const outroVideo = document.getElementById('outro-video');
const outroImage = document.getElementById('outro-image');
const outroLoadingText = level2OutroScreen.querySelector('.loading-text');
const skipOutroBtn = document.getElementById('skip-outro-btn'); // Get the new skip button


let confirmCallback = null; // ç¡®è®¤æ¨¡æ€æ¡†çš„å›è°ƒå‡½æ•°
let outroVideoTimeout = null; // ç”¨äºè§†é¢‘æ’­æ”¾è¶…æ—¶çš„è®¡æ—¶å™¨
let isCatMirrored = false; // To track current orientation of walking cat

// æ¸¸æˆçŠ¶æ€å¯¹è±¡
let game = {
  level: 1,
  cards: [],
  board: [],
  temp: [],
  matched: [],
  usedIcons: [],
  toolUses: {undo: 0, hint: 0, shuffle: 0},
  score: 0, // å½“å‰ç©å®¶åˆ†æ•°
  targetScore: 0, // å½“å‰å…³å¡ç›®æ ‡åˆ†æ•°
  displayCards: [], // å±•ç¤ºå¡ç‰‡ç»„æ•°ç»„ [{icon: "X", id: 1}, {icon: "X", id: 2}, {icon: "X", id: 3}]
  totalDisplaySetsGenerated: 0, // å½“å‰å…³å¡å·²ç”Ÿæˆçš„å±•ç¤ºç»„æ€»æ•°
  progress: 0, // æœªç›´æ¥ç”¨äºå½“å‰è¿›åº¦æ˜¾ç¤ºï¼Œä½†ä¿ç•™
  stepStack: [], // ç”¨äºæ’¤é”€åŠŸèƒ½
  bgmOn: true,
  isNewLevel: false, // æ§åˆ¶æ–°å…³å¡åŠ è½½æ—¶å¡ç‰‡å…¥åœºåŠ¨ç”»çš„æ ‡å¿—
  lock: false // é˜²æ­¢åŠ¨ç”»/è¿‡æ¸¡æœŸé—´å¤šæ¬¡ç‚¹å‡»å¯¼è‡´é—®é¢˜
};

// å·¥å…·å‡½æ•°
/**
 * éšæœºæ‰“ä¹±æ•°ç»„ã€‚
 * @param {Array} arr - è¦æ‰“ä¹±çš„æ•°ç»„ã€‚
 * @returns {Array} æ–°çš„æ‰“ä¹±åçš„æ•°ç»„ã€‚
 */
function randArr(arr) {
  return arr.slice().sort(() => Math.random() - 0.5);
}

/**
 * ä½¿ç”¨ Fisher-Yates ç®—æ³•åŸåœ°æ‰“ä¹±æ•°ç»„ã€‚
 * @param {Array} arr - è¦æ‰“ä¹±çš„æ•°ç»„ã€‚
 */
function shuffle(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
}

/**
 * ä½¿ç”¨ JSON åºåˆ—åŒ–åˆ›å»ºå¯¹è±¡çš„æ·±æ‹·è´ã€‚
 * @param {Object} obj - è¦å…‹éš†çš„å¯¹è±¡ã€‚
 * @returns {Object} å¯¹è±¡çš„æ·±æ‹·è´ã€‚
 */
function deepClone(obj) {
  return JSON.parse(JSON.stringify(obj));
}

/**
 * åœ¨ä¸¤ä¸ªå€¼ä¹‹é—´ç”Ÿæˆä¸€ä¸ªéšæœºæ•°ï¼ˆåŒ…å«ï¼‰ã€‚
 * @param {number} a - ç¬¬ä¸€ä¸ªæ•°å­—ã€‚
 * @param {number} b - ç¬¬äºŒä¸ªæ•°å­—ã€‚
 * @returns {number} åœ¨ a å’Œ b ä¹‹é—´çš„ä¸€ä¸ªéšæœºæ•°ã€‚
 */
function randBetween(a, b) { return a + Math.random() * (b - a); }

/**
 * æ’­æ”¾æˆ–æš‚åœèƒŒæ™¯éŸ³ä¹ã€‚
 * @param {boolean} on - true ä¸ºæ’­æ”¾ï¼Œfalse ä¸ºæš‚åœã€‚
 */
function playBgm(on) {
  if (!bgm) return;
  if (on) {
    const playPromise = bgm.play();
    if (playPromise !== undefined) {
      playPromise.catch(error => {
        console.error("BGM è‡ªåŠ¨æ’­æ”¾è¢«é˜»æ­¢ï¼š", error);
        game.bgmOn = false; // å¦‚æœè‡ªåŠ¨æ’­æ”¾å¤±è´¥ï¼Œæ›´æ–°çŠ¶æ€
        musicToggleBtn.innerHTML = 'â–¶ï¸'; // æ›´æ–° UI
      });
    }
  } else {
    bgm.pause();
  }
}

// ç”¨äºé«˜æ•ˆæ’­æ”¾çš„ç‚¹å‡»éŸ³æ•ˆæ± 
let clickSoundPool = [];
const MAX_CLICK_SOUNDS = 10; // æœ€å¤§å¹¶å‘ç‚¹å‡»éŸ³æ•ˆ

/**
 * ä¸ºç‚¹å‡»éŸ³æ•ˆåˆ›å»ºä¸€ä¸ªæ–°çš„ Audio å®ä¾‹ã€‚
 * @returns {HTMLAudioElement} æ–°çš„ Audio å…ƒç´ ã€‚
 */
function createClickSoundInstance() {
    const audio = new Audio('kaa.mp3');
    audio.preload = 'auto';
    audio.volume = 0.4;
    return audio;
}

// åˆå§‹åŒ–ç‚¹å‡»éŸ³æ•ˆæ± 
for (let i = 0; i < MAX_CLICK_SOUNDS; i++) {
    clickSoundPool.push(createClickSoundInstance());
}

/**
 * ä»éŸ³æ•ˆæ± ä¸­æ’­æ”¾ç‚¹å‡»éŸ³æ•ˆã€‚
 */
function playClickSound() {
  if (game.bgmOn) { // ä»…åœ¨ BGM å¯ç”¨æ—¶æ’­æ”¾ï¼ˆä½œä¸ºé€šç”¨éŸ³æ•ˆå¼€å…³ï¼‰
    let soundInstance = clickSoundPool.find(audio => audio.paused || audio.ended);
    if (!soundInstance) {
        soundInstance = createClickSoundInstance();
        // å¯é€‰ï¼šå¦‚æœæ± å·²æ»¡ï¼Œæ›¿æ¢æœ€æ—§çš„å®ä¾‹ï¼Œæˆ–è€…åªæ˜¯ä¸´æ—¶åˆ›å»º
    }
    soundInstance.currentTime = 0; // é‡ç½®åˆ°å¼€å§‹ä»¥ä¾¿ç«‹å³æ’­æ”¾
    soundInstance.play().catch(e => console.error("ç‚¹å‡»éŸ³æ•ˆæ’­æ”¾å¤±è´¥ï¼š", e));
  }
}

/**
 * æ˜¾ç¤ºè‡ªå®šä¹‰ç¡®è®¤æ¨¡æ€æ¡†ã€‚
 * @param {string} msg - è¦æ˜¾ç¤ºçš„æ¶ˆæ¯ã€‚
 * @param {Function} callback - å¦‚æœç‚¹å‡»â€œç¡®å®šâ€åˆ™è°ƒç”¨çš„å‡½æ•°ã€‚
 */
function showConfirm(msg, callback) {
  confirmMsg.textContent = msg;
  confirmCallback = callback;
  confirmModal.style.display = 'flex';
}

/**
 * éšè—è‡ªå®šä¹‰ç¡®è®¤æ¨¡æ€æ¡†ã€‚
 */
function hideConfirm() {
  confirmModal.style.display = 'none';
  confirmCallback = null;
}

// ç¡®è®¤æ¨¡æ€æ¡†æŒ‰é’®çš„äº‹ä»¶ç›‘å¬å™¨
confirmYes.onclick = () => {
  const callback = confirmCallback;
  hideConfirm();
  if (callback) {
    setTimeout(callback, 20); // å…è®¸æ¨¡æ€æ¡†éšè—çš„çŸ­å»¶è¿Ÿ
  }
};
confirmNo.onclick = hideConfirm;

/**
 * ç”Ÿæˆä¸€ç»„å±•ç¤ºå¡ç‰‡ï¼ˆ3 å¼ ç›¸åŒå›¾æ ‡çš„å¡ç‰‡ï¼‰ã€‚
 * å›¾æ ‡ä»æ¸¸æˆæ¿ä¸Šå½“å‰å¯ç”¨çš„å”¯ä¸€å›¾æ ‡ä¸­é€‰æ‹©ã€‚
 * @param {Array<string>} excludeIcons - è¦ä»é€‰æ‹©ä¸­æ’é™¤çš„å›¾æ ‡æ•°ç»„ã€‚
 * @returns {Array} åŒ…å« 3 ä¸ªç”¨äºå±•ç¤ºçš„å¡ç‰‡å¯¹è±¡çš„æ•°ç»„ï¼Œå¦‚æœæ²¡æœ‰åˆé€‚çš„å›¾æ ‡åˆ™è¿”å› nullã€‚
 */
function generateDisplayCardSet(excludeIcons = []) {
    let chosenIcon = null;

    // --- æ–°å¢é€»è¾‘ï¼šä¼˜å…ˆä»å‰ 1-4 å±‚ï¼ˆå †æ ˆ 0-3ï¼‰çš„å¯è§å¡ç‰‡ä¸­é€‰æ‹© ---
    const visibleLayeredCards = game.board.filter(c =>
        !c.matched && isCardClickable(c, game.board) && c.stack >= 0 && c.stack <= 3
    );
    const visibleLayeredIconCounts = {};
    visibleLayeredCards.forEach(c => visibleLayeredIconCounts[c.icon] = (visibleLayeredIconCounts[c.icon] || 0) + 1);

    let potentialVisibleLayeredIcons = Object.keys(visibleLayeredIconCounts).filter(icon => {
        if (excludeIcons.includes(icon)) return false;
        return visibleLayeredIconCounts[icon] >= 3;
    });

    if (potentialVisibleLayeredIcons.length > 0) {
        chosenIcon = potentialVisibleLayeredIcons[Math.floor(Math.random() * potentialVisibleLayeredIcons.length)];
    } else {
        // --- ç°æœ‰é€»è¾‘ï¼ˆå¦‚æœå¯è§åˆ†å±‚å¡ç‰‡ä¸­æ²¡æœ‰ä¸‰è”ç‰Œåˆ™å›é€€ï¼‰ ---
        // 1. ä¸»è¦æ¥æºï¼šä»æ¸¸æˆæ¿ä¸Šæ‰€æœ‰å¯ç‚¹å‡»å¡ç‰‡ + æš‚å­˜åŒºä¸­æŸ¥æ‰¾ä¸‰è”ç‰Œ
        const allClickableBoardCards = game.board.filter(c => !c.matched && isCardClickable(c, game.board));
        const combinedClickableIcons = [...allClickableBoardCards.map(c => c.icon), ...game.temp.map(c => c.icon)];
        const combinedClickableIconCounts = {};
        combinedClickableIcons.forEach(icon => combinedClickableIconCounts[icon] = (combinedClickableIconCounts[icon] || 0) + 1);

        let potentialCombinedIcons = Object.keys(combinedClickableIconCounts).filter(icon => {
            if (excludeIcons.includes(icon)) return false;
            return combinedClickableIconCounts[icon] >= 3;
        });

        if (potentialCombinedIcons.length > 0) {
            chosenIcon = potentialCombinedIcons[Math.floor(Math.random() * potentialCombinedIcons.length)];
        } else {
            // 2. æ¬¡è¦æ¥æºï¼ˆå›é€€ï¼‰ï¼šå¦‚æœä»ç„¶æ²¡æœ‰å¯ç‚¹å‡»å¡ç‰‡ä¸­çš„ä¸‰è”ç‰Œï¼Œåˆ™ä»æ¸¸æˆä¸­æ‰€æœ‰å¡ç‰‡ï¼ˆå³ä½¿è¢«è¦†ç›–ï¼‰ä¸­æŸ¥æ‰¾
            const allIconsInGame = game.cards.map(c => c.icon);
            const allIconCounts = {};
            allIconsInGame.forEach(icon => allIconCounts[icon] = (allIconCounts[icon] || 0) + 1);

            const anyTripletIcons = Object.keys(allIconCounts).filter(icon => {
                if (excludeIcons.includes(icon)) return false;
                return allIconCounts[icon] >= 3;
            });

            if (anyTripletIcons.length > 0) {
                chosenIcon = anyTripletIcons[Math.floor(Math.random() * anyTripletIcons.length)];
            } else {
                // æœ€åæ‰‹æ®µï¼šå¦‚æœæ ¹æœ¬æ²¡æœ‰ä¸‰è”ç‰Œï¼Œé€‰æ‹©ä»»ä½•å­˜åœ¨çš„å›¾æ ‡ï¼ˆè¿™ç§æƒ…å†µåº”è¯¥å¾ˆå°‘å‘ç”Ÿï¼‰
                const availableIconsWithoutExclusion = allIconsInGame.filter(icon => !excludeIcons.includes(icon));
                if (availableIconsWithoutExclusion.length > 0) {
                    chosenIcon = availableIconsWithoutExclusion[Math.floor(Math.random() * availableIconsWithoutExclusion.length)];
                } else if (allIconsInGame.length > 0) { // å¦‚æœæ‰€æœ‰å›¾æ ‡éƒ½åœ¨æ’é™¤åˆ—è¡¨ä¸­ï¼Œåˆ™åªé€‰æ‹©ä»»ä½•ä¸€ä¸ª
                    chosenIcon = allIconsInGame[Math.floor(Math.random() * allIconsInGame.length)];
                } else {
                    return null; // æ²¡æœ‰å¯ç”¨çš„å¡ç‰‡å›¾æ ‡
                }
            }
        }
    }

    if (chosenIcon) {
        // è¿”å› 3 ä¸ªå…·æœ‰æ‰€é€‰å›¾æ ‡çš„å¡ç‰‡å¯¹è±¡
        return [
            { icon: chosenIcon, id: Date.now() + 1 },
            { icon: chosenIcon, id: Date.now() + 2 },
            { icon: chosenIcon, id: Date.now() + 3 }
        ];
    } else {
        return null; // å¦‚æœ game.cards å·²æ­£ç¡®åˆå§‹åŒ–ï¼Œåˆ™ä¸åº”åˆ°è¾¾æ­¤å¤„
    }
}


/**
 * ä¸ºç»™å®šå…³å¡ç”Ÿæˆå¡ç‰‡å’Œæ¸¸æˆæ¿å¸ƒå±€ã€‚
 * @param {number} levelIdx - å½“å‰å…³å¡å·ï¼ˆ1 æˆ– 2ï¼‰ã€‚
 * @returns {Object} åŒ…å«ç”Ÿæˆçš„å¡ç‰‡ã€æ¸¸æˆæ¿å’Œå·²ä½¿ç”¨çš„å›¾æ ‡ã€‚
 */
function genLevel(levelIdx){
  const lv = LEVELS[levelIdx - 1];

  // åˆå§‹åŒ–å…³å¡åˆ†æ•°å’Œç›®æ ‡åˆ†æ•°
  game.score = 0;
  game.targetScore = lv.targetScore;
  game.totalDisplaySetsGenerated = 0; // æ–°å…³å¡åŠ è½½æ—¶é‡ç½®è®¡æ•°

  let allIcons = [];
  const requiredUniqueIcons = Math.ceil(lv.total / 3);
  let availableIcons = randArr(CARD_ICONS).slice(0, Math.min(CARD_ICONS.length, requiredUniqueIcons + 2)); // ç¡®ä¿è¶³å¤Ÿçš„å”¯ä¸€å›¾æ ‡

  let iconPool = [];
  for (let i = 0; i < requiredUniqueIcons; i++) {
    for (let j = 0; j < 3; j++) {
      iconPool.push(availableIcons[i % availableIcons.length]);
    }
  }
  // å¡«å……å‰©ä½™ç©ºä½ä»¥è¾¾åˆ°æ€»å¡ç‰‡æ•°
  while (iconPool.length < lv.total) {
      const remaining = lv.total - iconPool.length;
      if (remaining < 3) { // å¦‚æœå‰©ä½™ä¸è¶³ 3 å¼ å¡ç‰‡ï¼Œåˆ™é€ä¸€æ·»åŠ 
          for (let i = 0; i < remaining; i++) {
              iconPool.push(availableIcons[i % availableIcons.length]);
          }
      } else { // å¦åˆ™ï¼Œæ·»åŠ ä¸€ä¸ªä¸‰è”ç‰Œ
          const iconToAdd = availableIcons[Math.floor(Math.random() * availableIcons.length)];
          iconPool.push(iconToAdd, iconToAdd, iconToAdd);
      }
  }
  shuffle(iconPool); // æ‰“ä¹±æœ€ç»ˆçš„å›¾æ ‡æ± 
  allIcons = iconPool;

  let cards = [];
  for(let i = 0; i < lv.total; i++){
    cards.push({
      id: i,
      icon: allIcons[i],
      matched: false
    });
  }
  // åœ¨ç”Ÿæˆå±•ç¤ºå¡ç‰‡ä¹‹å‰åœ¨æ­¤å¤„è®¾ç½® game.cardsï¼Œä»¥ä¾¿ generateDisplayCardSet å¯ä»¥ä½¿ç”¨å®ƒã€‚
  game.cards = cards;

  let board = [];
  const areaW = document.getElementById('card-stack-area').offsetWidth;
  const areaH = document.getElementById('card-stack-area').offsetHeight;

  let cardW = (levelIdx === 2) ? 50 : 65;
  let cardH = (levelIdx === 2) ? 65 : 85;
  let stackDepth = lv.stack;

  const cardsPerStackLayer = Math.ceil(lv.total / stackDepth);

  // åœ¨æ¸¸æˆæ¿ä¸Šå®šä½å¡ç‰‡
  for (let cardIdx = 0; cardIdx < lv.total; cardIdx++) {
    const s = Math.min(Math.floor(cardIdx / cardsPerStackLayer), stackDepth - 1); // ç¡®å®šå †æ ˆå±‚

    let x = 0, y = 0;
    let maxAttempts = 50; // æŸ¥æ‰¾éé‡å ä½ç½®çš„æœ€å¤§å°è¯•æ¬¡æ•°
    let foundPosition = false;
    for (let attempt = 0; attempt < maxAttempts; attempt++) {
      let tempX = randBetween(5, areaW - cardW - 5);
      let tempY = randBetween(5, areaH - cardH - 5);

      // æ ¹æ®å †æ ˆæ·»åŠ è½»å¾®åç§»ä»¥å®ç°è§†è§‰æ·±åº¦
      tempX += (s * 5 * (Math.random() - 0.5));
      tempY += (s * 5 * (Math.random() - 0.5));

      // å°†ä½ç½®é™åˆ¶åœ¨è¾¹ç•Œå†…
      tempX = Math.max(5, Math.min(tempX, areaW - cardW - 5));
      tempY = Math.max(5, Math.min(tempY, areaH - cardH - 5));

      let overlap = false;
      // æ£€æŸ¥ä¸ç›¸åŒæˆ–æ›´ä½å †æ ˆå±‚ä¸­çš„å¡ç‰‡æ˜¯å¦é‡å 
      for (const existingCard of board) {
        if (existingCard.stack <= s) {
          const dx = Math.abs(tempX - existingCard.x);
          const dy = Math.abs(tempY - existingCard.y);
          if (dx < cardW * 0.7 && dy < cardH * 0.7) { // é‡å é˜ˆå€¼
            overlap = true;
            break;
          }
        }
      }

      if (!overlap) {
        x = tempX;
        y = tempY;
        foundPosition = true;
        break;
      }
    }

    // å¦‚æœæœªæ‰¾åˆ°éé‡å ä½ç½®çš„å¤‡ç”¨æ–¹æ¡ˆ
    if (!foundPosition) {
        x = randBetween(5, areaW - cardW - 5);
        y = randBetween(5, areaH - cardH - 5);
    }

    const z = s * 1000 + cardIdx; // ç”¨äºåˆ†å±‚çš„ Z ç´¢å¼•

    board.push({
      id: cards[cardIdx].id,
      icon: cards[cardIdx].icon,
      x, y, z,
      matched: false,
      covered: false, // æœªæ˜ç¡®ä½¿ç”¨ä½†ä¸ºäº†æ¸…æ™°èµ·è§
      stack: s
    });
  }

  board.sort((a, b) => a.z - b.z); // æŒ‰ z ç´¢å¼•æ’åºä»¥ç¡®å®šæ¸²æŸ“é¡ºåº
  game.board = board; // å°†æ¸¸æˆæ¿åˆ†é…ç»™æ¸¸æˆçŠ¶æ€

  // ç”Ÿæˆåˆå§‹å±•ç¤ºå¡ç‰‡ï¼Œç¡®ä¿å›¾æ ‡å”¯ä¸€
  game.displayCards = [];
  const usedDisplayIconsForLevel = new Set(); // è·Ÿè¸ªæ­¤å…³å¡ä¸­å±•ç¤ºç»„ä½¿ç”¨çš„å›¾æ ‡
  for (let i = 0; i < INITIAL_DISPLAY_SETS_VISIBLE; i++) {
      const newSet = generateDisplayCardSet(Array.from(usedDisplayIconsForLevel));
      if (newSet) {
          game.displayCards.push({ id: `display-set-${i}`, cards: newSet, matched: false });
          usedDisplayIconsForLevel.add(newSet[0].icon); // æ·»åŠ æ–°ç”Ÿæˆçš„é›†åˆçš„å›¾æ ‡
          game.totalDisplaySetsGenerated++;
      }
  }

  return {cards: game.cards, board: game.board, usedIcons: availableIcons.slice(0, Math.ceil(lv.total/3))};
}

/**
 * æ£€æŸ¥å¡ç‰‡æ˜¯å¦å¯ç‚¹å‡»ï¼ˆæœªåŒ¹é…ä¸”æœªè¢«å…¶ä»–å¡ç‰‡è¦†ç›–ï¼‰ã€‚
 * @param {Object} card - è¦æ£€æŸ¥çš„å¡ç‰‡ã€‚
 * @param {Array} board - å½“å‰æ¸¸æˆæ¿ã€‚
 * @returns {boolean} å¦‚æœå¡ç‰‡å¯ç‚¹å‡»åˆ™ä¸º trueï¼Œå¦åˆ™ä¸º falseã€‚
 */
function isCardClickable(card, board){
  if(card.matched) return false;

  const activeCards = board.filter(c => !c.matched); // åªè€ƒè™‘æœªåŒ¹é…çš„å¡ç‰‡

  const cardW = (game.level === 2) ? 50 : 65;
  const cardH = (game.level === 2) ? 65 : 85;
  const overlapThresholdX = cardW * 0.7; // X è½´é‡å é˜ˆå€¼
  const overlapThresholdY = cardH * 0.7; // Y è½´é‡å é˜ˆå€¼

  for (const otherCard of activeCards) {
    if (card.id === otherCard.id) {
      continue;
    }

    // å¦‚æœå¦ä¸€å¼  Z ç´¢å¼•æ›´é«˜çš„å¡ç‰‡æ˜æ˜¾é‡å ï¼Œåˆ™å¡ç‰‡è¢«è¦†ç›–
    if (otherCard.z > card.z) {
      const dx = Math.abs(otherCard.x - card.x);
      const dy = Math.abs(otherCard.y - card.y);

      if (dx < overlapThresholdX && dy < overlapThresholdY) {
        return false; // å¡ç‰‡è¢«è¦†ç›–
      }
    }
  }
  return true; // å¡ç‰‡å¯ç‚¹å‡»
}

/**
 * å¤„ç†å¡ç‰‡çš„ç‚¹å‡»äº‹ä»¶ã€‚
 * @param {number} id - è¢«ç‚¹å‡»å¡ç‰‡çš„ IDã€‚
 */
function clickCard(id) {
  if (game.lock) return; // é˜²æ­¢åŠ¨ç”»æœŸé—´å¤šæ¬¡ç‚¹å‡»

  let cardData = game.board.find(c => c.id === id);

  if (!cardData || cardData.matched || !isCardClickable(cardData, game.board)) return;

  // é¢„æ£€æŸ¥æ·»åŠ æ­¤å¡ç‰‡æ˜¯å¦ä¼šåœ¨æ²¡æœ‰åŒ¹é…çš„æƒ…å†µä¸‹è¶…å‡ºæš‚å­˜åŒºé™åˆ¶
  let tempCheck = [...game.temp, { icon: cardData.icon, id: cardData.id }];
  let iconCntCheck = {};
  tempCheck.forEach(c => iconCntCheck[c.icon] = (iconCntCheck[c.icon] || 0) + 1);
  let matchedIconCheck = Object.keys(iconCntCheck).find(k => iconCntCheck[k] === 3);

  if (game.temp.length >= TEMP_LIMIT && !matchedIconCheck) {
      gameOver('æš‚å­˜åŒºå·²è¶…é™ï¼Œæ¸¸æˆå¤±è´¥ï¼');
      return;
  }

  saveStep(); // ä¿å­˜å½“å‰æ¸¸æˆçŠ¶æ€ä»¥ä¾›æ’¤é”€
  game.lock = true; // è·å–é”å®š

  const clickedCardEl = document.querySelector(`#card-stack-area .card[data-id='${id}']`);
  if (!clickedCardEl) {
    game.lock = false;
    return;
  }

  const startRect = clickedCardEl.getBoundingClientRect();

  // åˆ›å»ºå¹¶è®¾ç½®é£è¡Œå¡ç‰‡å…ƒç´ çš„æ ·å¼
  const flyingCard = document.createElement('div');
  flyingCard.className = 'flying-card';
  flyingCard.innerHTML = cardData.icon;
  document.body.appendChild(flyingCard);

  flyingCard.style.left = `${startRect.left}px`;
  flyingCard.style.top = `${startRect.top}px`;
  flyingCard.style.width = `${startRect.width}px`;
  flyingCard.style.height = `${startRect.height}px`;

  // éšè—åŸå§‹å¡ç‰‡
  clickedCardEl.style.opacity = '0';
  clickedCardEl.style.pointerEvents = 'none';

  playClickSound(); // æ’­æ”¾ç‚¹å‡»éŸ³æ•ˆ

  const animationDuration = 150; // é£è¡Œå¡ç‰‡åŠ¨ç”»æŒç»­æ—¶é—´
  const tempAppearanceDelay = 80; // å¡ç‰‡å‡ºç°åœ¨æš‚å­˜åŒºä¹‹å‰çš„å»¶è¿Ÿ

  // è®¡ç®—é£è¡Œå¡ç‰‡çš„ç›®çš„åœ°
  requestAnimationFrame(() => {
    // æ¨¡æ‹Ÿå°†å¡ç‰‡æ·»åŠ åˆ°æš‚å­˜åŒºä»¥æŸ¥æ‰¾å…¶æ­£ç¡®çš„æ’åºä½ç½®
    const tempForPositionCalculation = [...game.temp, { icon: cardData.icon, id: cardData.id }];
    tempForPositionCalculation.sort((a, b) => a.icon.localeCompare(b.icon) || a.id - b.id);
    const endSlotIndex = tempForPositionCalculation.findIndex(c => c.id === id);
    const tempSlots = document.querySelectorAll('#temp-area .temp-slot');

    if (endSlotIndex < 0 || endSlotIndex >= tempSlots.length) {
        console.error("è®¡ç®—é£è¡Œå¡ç‰‡çš„ç»“æŸæ§½ç´¢å¼•æ— æ•ˆã€‚ä¸­æ­¢åŠ¨ç”»ã€‚");
        document.body.removeChild(flyingCard);
        game.lock = false;
        return;
    }

    const endRect = tempSlots[endSlotIndex].getBoundingClientRect();
    const tempSlotStyle = window.getComputedStyle(tempSlots[endSlotIndex]);
    const flyingCardFinalWidth = parseFloat(tempSlotStyle.width) * 0.9;
    const flyingCardFinalHeight = parseFloat(tempSlotStyle.height) * 0.9;

    const destLeft = endRect.left + (endRect.width - flyingCardFinalWidth) / 2;
    const destTop = endRect.top + (endRect.height - flyingCardFinalHeight) / 2;

    // åº”ç”¨åŠ¨ç”»çš„ç›®æ ‡æ ·å¼
    flyingCard.style.left = `${destLeft}px`;
    flyingCard.style.top = `${destTop}px`;
    flyingCard.style.transform = `scale(${flyingCardFinalWidth / parseFloat(startRect.width)})`;
  });

  // åŠ¨ç”»ç»“æŸåç§»é™¤é£è¡Œå¡ç‰‡
  setTimeout(() => {
    document.body.removeChild(flyingCard);
  }, animationDuration);

  // é£è¡ŒåŠ¨ç”»åæ›´æ–°æ¸¸æˆçŠ¶æ€å¹¶æ¸²æŸ“
  setTimeout(() => {
    cardData.matched = true; // å°†å¡ç‰‡æ ‡è®°ä¸ºå·²åŒ¹é…
    game.temp.push({ icon: cardData.icon, id: cardData.id, matched: false }); // æ·»åŠ åˆ°æš‚å­˜åŒº
    game.temp.sort((a, b) => a.icon.localeCompare(b.icon) || a.id - b.id); // æš‚å­˜åŒºæ’åº

    renderTemp(); // é‡æ–°æ¸²æŸ“æš‚å­˜åŒº
    renderBoard(); // é‡æ–°æ¸²æŸ“æ¸¸æˆæ¿ï¼ˆæ›´æ–°å¯ç‚¹å‡»çŠ¶æ€ï¼‰
    renderProgressAndScore(); // æ›´æ–°è¿›åº¦å’Œåˆ†æ•°æ˜¾ç¤º
    updateWigglingCatVisibility(); // MODIFICATION: Update wiggling cat visibility

    // æ£€æŸ¥æš‚å­˜åŒºä¸­æ˜¯å¦å­˜åœ¨ä¸‰è”ç‰ŒåŒ¹é…
    let iconCnt = {};
    game.temp.forEach(c => {
      if (!c.matched) iconCnt[c.icon] = (iconCnt[c.icon] || 0) + 1;
    });

    let matchedIcon = Object.keys(iconCnt).find(k => iconCnt[k] === 3);

    if (matchedIcon) {
      // æ ‡è®°æš‚å­˜åŒºä¸­åŒ¹é…çš„å¡ç‰‡
      game.temp.forEach(c => { if (c.icon === matchedIcon) c.matched = true; });

      // æ£€æŸ¥åŒ¹é…çš„å›¾æ ‡æ˜¯å¦ä¹Ÿä¸ä»»ä½•å±•ç¤ºå¡ç‰‡åŒ¹é…
      game.displayCards.forEach(displaySet => {
          if (!displaySet.matched && displaySet.cards[0].icon === matchedIcon) {
              displaySet.matched = true; // å°†å±•ç¤ºç»„æ ‡è®°ä¸ºå·²åŒ¹é…
              game.score += DISPLAY_CARD_MATCH_SCORE; // æ·»åŠ åˆ†æ•°
              renderProgressAndScore(); // ç«‹å³æ›´æ–°åˆ†æ•°æ˜¾ç¤º

              // åœ¨åŒ¹é…çš„å±•ç¤ºç»„æ—è¾¹æ·»åŠ åˆ†æ•°åŠ¨ç”»
              const matchedDisplayGroupEl = document.querySelector(`#display-area .display-group[data-id='${displaySet.id}']`);
              if (matchedDisplayGroupEl) {
                  const groupRect = matchedDisplayGroupEl.getBoundingClientRect();
                  const scoreAnimDiv = document.createElement('div');
                  scoreAnimDiv.className = 'score-animation';
                  scoreAnimDiv.textContent = `+${DISPLAY_CARD_MATCH_SCORE}`;
                  document.body.appendChild(scoreAnimDiv);

                  // å®šä½åŠ¨ç”»ç›¸å¯¹äºåŒ¹é…çš„å±•ç¤ºç»„
                  scoreAnimDiv.style.left = `${groupRect.left + groupRect.width / 2}px`;
                  scoreAnimDiv.style.top = `${groupRect.top + groupRect.height / 2}px`;
                  scoreAnimDiv.style.transform = 'translate(-50%, -50%)'; // æ°´å¹³å’Œå‚ç›´å±…ä¸­

                  // åŠ¨ç”»ç»“æŸåç§»é™¤å…ƒç´ 
                  scoreAnimDiv.addEventListener('animationend', () => {
                      scoreAnimDiv.remove();
                  }, { once: true });
              }


              // å»¶è¿Ÿåç”¨æ–°çš„ä¸€ç»„æ›¿æ¢åŒ¹é…çš„å±•ç¤ºç»„
              setTimeout(() => {
                  const currentLevelConfig = LEVELS[game.level - 1];
                  // ä¼ é€’å½“å‰å·²ä½¿ç”¨çš„å±•ç¤ºå›¾æ ‡ä»¥å°½å¯èƒ½é¿å…é‡å¤
                  const newSet = generateDisplayCardSet(game.displayCards.map(ds => ds.cards[0].icon));
                  if (newSet) {
                      displaySet.cards = newSet; // æ›¿æ¢å†…å®¹
                      displaySet.matched = false; // é‡ç½®åŒ¹é…çŠ¶æ€
                      game.totalDisplaySetsGenerated++;
                  } else {
                      // å¦‚æœæ‰€æœ‰ totalDisplaySets éƒ½å·²ç”Ÿæˆï¼Œåˆ™åªç§»é™¤æ­¤ç»„
                      game.displayCards = game.displayCards.filter(ds => ds.id !== displaySet.id);
                  }
                  renderDisplay(); // é‡æ–°æ¸²æŸ“å±•ç¤ºåŒº
              }, 400); // çŸ­æš‚å»¶è¿Ÿä»¥å®ç°è§†è§‰æ•ˆæœ
          }
      });

      setTimeout(() => {
        game.temp = game.temp.filter(c => !c.matched); // ä»æš‚å­˜åŒºä¸­ç§»é™¤åŒ¹é…çš„å¡ç‰‡
        renderTemp();
        renderBoard();
        checkWin(); // æ£€æŸ¥æ¸¸æˆæ˜¯å¦èƒœåˆ©
        game.lock = false; // é‡Šæ”¾é”å®š
      }, 100); // åŒ¹é…çš„è§†è§‰æ•ˆæœçš„çŸ­å»¶è¿Ÿ
    } else {
      checkWin();
      game.lock = false; // é‡Šæ”¾é”å®š
    }
  }, tempAppearanceDelay);
}

/**
 * æ£€æŸ¥æ¸¸æˆæ˜¯å¦å·²èƒœåˆ©ã€‚
 */
function checkWin(){
  const allCardsMatched = game.board.every(c=>c.matched);
  const scoreMet = game.score >= game.targetScore;

  if(allCardsMatched && scoreMet){
    setTimeout(()=>{
      if(game.level===1){
        showLevelFinish('æ­å–œæ­å–œï¼ç¬¬ä¸€å…³é€šå…³ï¼');
      }else{
        // MODIFICATION: Call playLevel2Outro for Level 2 completion
        playLevel2Outro();
      }
    },330); // æ˜¾ç¤ºèƒœåˆ©å±å¹•å‰çš„çŸ­å»¶è¿Ÿ
  } else if (allCardsMatched && !scoreMet) {
      // æ‰€æœ‰å¡ç‰‡å·²æ¸…é™¤ä½†åˆ†æ•°æœªè¾¾æ ‡
      gameOver(`å¡ç‰Œå·²å…¨éƒ¨æ¶ˆé™¤ï¼Œä½†åˆ†æ•°æœªè¾¾æ ‡ï¼<br>å½“å‰åˆ†æ•°: ${game.score} / ç›®æ ‡åˆ†æ•°: ${game.targetScore}`);
  }
}

/**
 * å°†å½“å‰æ¸¸æˆçŠ¶æ€ä¿å­˜åˆ°æ­¥éª¤å †æ ˆä»¥ä¾›æ’¤é”€ã€‚
 */
function saveStep(){
  game.stepStack.push({
    board: deepClone(game.board),
    temp: deepClone(game.temp),
    score: game.score, // ä¿å­˜åˆ†æ•°ä»¥ä¾›æ’¤é”€
    displayCards: deepClone(game.displayCards), // ä¿å­˜å±•ç¤ºå¡ç‰‡ä»¥ä¾›æ’¤é”€
    totalDisplaySetsGenerated: game.totalDisplaySetsGenerated // ä¿å­˜ç”Ÿæˆè®¡æ•°
  });
  if(game.stepStack.length > 20) game.stepStack.shift(); // é™åˆ¶å †æ ˆå¤§å°
}

/**
 * æ’¤é”€ä¸Šä¸€ä¸ªæ¸¸æˆæ­¥éª¤ã€‚
 */
function undoStep(){
  if(game.stepStack.length > 0){
    let prev = game.stepStack.pop();
    game.board = deepClone(prev.board);
    game.temp = deepClone(prev.temp);
    game.score = prev.score; // æ¢å¤åˆ†æ•°
    game.displayCards = deepClone(prev.displayCards); // æ¢å¤å±•ç¤ºå¡ç‰‡
    game.totalDisplaySetsGenerated = prev.totalDisplaySetsGenerated; // æ¢å¤ç”Ÿæˆè®¡æ•°
    renderAll();
    showMessage('å·²æ’¤é”€');
    updateWigglingCatVisibility(); // MODIFICATION: Update wiggling cat visibility
  } else {
    showMessage('æ— æ³•æ’¤é”€æ›´å¤š', '#888');
  }
}

/**
 * æ‰“ä¹±æ¸¸æˆæ¿ä¸ŠæœªåŒ¹é…çš„å¡ç‰‡ã€‚
 */
function shuffleStep(){
  saveStep(); // æ‰“ä¹±å‰ä¿å­˜çŠ¶æ€ä»¥ä¾›æ’¤é”€
  game.lock = true; // åŠ¨ç”»æœŸé—´é”å®šæ¸¸æˆ

  let unmatchedCardsElements = document.querySelectorAll('#card-stack-area .card:not(.matched)');
  unmatchedCardsElements.forEach(el => {
      el.classList.add('card-shuffling-out');
  });

  setTimeout(() => {
      let unmatched = game.board.filter(c=>!c.matched);
      let icons = unmatched.map(c=>c.icon);
      shuffle(icons); // æ‰“ä¹±å›¾æ ‡

      unmatched.forEach((c,i)=>{
          c.icon = icons[i]; // åˆ†é…æ–°çš„æ‰“ä¹±åçš„å›¾æ ‡
      });

      // é‡æ–°æ¸²æŸ“å°†åˆ›å»ºæ–°å…ƒç´ ï¼Œè‡ªåŠ¨åº”ç”¨å¡ç‰‡å…¥åœºåŠ¨ç”»
      renderAll();
      showMessage('å·²æ´—ç‰Œ');
      game.lock = false; // é‡æ–°æ¸²æŸ“åé‡Šæ”¾é”å®š
      updateWigglingCatVisibility(); // MODIFICATION: Update wiggling cat visibility
  }, 300); // card-shuffle-out åŠ¨ç”»æŒç»­æ—¶é—´
}

/**
 * é€šè¿‡çªå‡ºæ˜¾ç¤ºå¯ä»¥å½¢æˆä¸‰è”ç‰Œçš„å¡ç‰‡æ¥æä¾›æç¤ºã€‚
 */
function hintStep(){
  let tempIcons = game.temp.map(c => c.icon);
  let clickableBoardCards = game.board.filter(c => !c.matched && isCardClickable(c, game.board));
  let clickableBoardIcons = clickableBoardCards.map(c => c.icon);

  let allAvailableIcons = [...tempIcons, ...clickableBoardIcons];

  let iconCounts = {};
  allAvailableIcons.forEach(icon => {
    iconCounts[icon] = (iconCounts[icon] || 0) + 1;
  });

  let targetIcon = null; // å¯ä»¥å½¢æˆä¸‰è”ç‰Œçš„å›¾æ ‡
  for (let icon in iconCounts) {
    if (iconCounts[icon] >= 3) {
      targetIcon = icon;
      break;
    }
  }

  // åœ¨åº”ç”¨æ–°æç¤ºä¹‹å‰ç§»é™¤ä»»ä½•ç°æœ‰æç¤ºåŠ¨ç”»/æ ·å¼
  document.querySelectorAll('.card.hinted-shake').forEach(el => {
      el.classList.remove('hinted-shake');
      el.style.borderColor = '';
      el.style.boxShadow = '';
  });
  document.querySelectorAll('#temp-area .temp-card.hinted-shake').forEach(el => {
      el.classList.remove('hinted-shake');
      el.style.borderColor = '';
      el.style.boxShadow = '';
  });

  if (targetIcon) {
    let hintDone = 0;
    const tempSlots = document.querySelectorAll('#temp-area .temp-slot');
    const hintedElements = []; // è®°å½•éœ€è¦åŠ¨ç”»çš„å…ƒç´ 

    // çªå‡ºæ˜¾ç¤ºæš‚å­˜åŒºä¸­çš„å¡ç‰‡
    for (let i = 0; i < game.temp.length && hintDone < 3; i++) {
      if (game.temp[i].icon === targetIcon && !game.temp[i].matched) {
        const tempCardElement = tempSlots[i].querySelector('.temp-card');
        if (tempCardElement) {
          tempCardElement.style.borderColor = '#e65c4f';
          tempCardElement.style.boxShadow = '0 0 16px #ff8c69';
          tempCardElement.classList.add('hinted-shake');
          hintedElements.push(tempCardElement);
          hintDone++;
        }
      }
    }

    // çªå‡ºæ˜¾ç¤ºæ¸¸æˆæ¿ä¸Šå¯ç‚¹å‡»çš„å¡ç‰‡
    for (let i = 0; i < clickableBoardCards.length && hintDone < 3; i++) {
      let boardCard = clickableBoardCards[i];
      if (boardCard.icon === targetIcon) {
        let doms = document.querySelector(`#card-stack-area .card[data-id='${boardCard.id}']`);
        if (doms) {
          doms.classList.add('hinted-shake');
          doms.style.borderColor = '#e65c4f';
          doms.style.boxShadow = '0 0 16px #ff8c69';
          hintedElements.push(doms);
          hintDone++;
        }
      }
    }

    showMessage('å·²æç¤ºå¯æ¶ˆé™¤ä¸‰å¼ ');

    // çŸ­æš‚å»¶è¿Ÿåç§»é™¤åŠ¨ç”»ç±»å¹¶é‡ç½®æ ·å¼
    setTimeout(() => {
        hintedElements.forEach(el => {
            el.classList.remove('hinted-shake');
            el.style.borderColor = '';
            el.style.boxShadow = '';
        });
        renderAll(); // é‡æ–°æ¸²æŸ“ä»¥ç¡®ä¿æ ·å¼å¹²å‡€
    }, 1200);
  } else {
    showMessage('å½“å‰æ— å¯ä¸‰æ¶ˆ', "#888");
  }
}

/**
 * æ˜¾ç¤ºæ¸¸æˆç»“æŸå±å¹•ã€‚
 * @param {string} msg - æ¸¸æˆç»“æŸæ¶ˆæ¯ã€‚
 */
function gameOver(msg){
  game.lock = true; // é”å®šæ¸¸æˆäº¤äº’
  document.getElementById('card-stack-area').innerHTML = '';
  document.querySelectorAll('#temp-area .temp-slot').forEach(slot => { slot.innerHTML = ''; });
  displayArea.innerHTML = ''; // æ¸…ç©ºå±•ç¤ºåŒº
  document.getElementById('level-info').textContent = '';
  // cardCountInfoElement.textContent = ''; // ç§»é™¤æ­¤è¡Œ
  currentScoreElement.textContent = '0';
  targetScoreElement.textContent = '0';
  document.getElementById('message-bar').textContent = '';

  // MODIFICATION: Hide wiggling cats on game over
  hideWigglingCats();

  setTimeout(() => {
    document.getElementById('game-over').style.display = 'flex';
    document.getElementById('game-over-text').innerHTML = msg;
  }, 100);
}

/**
 * åˆå§‹åŒ–æ–°çš„æ¸¸æˆå…³å¡ã€‚
 * @param {number} level - è¦å¼€å§‹çš„å…³å¡å·ã€‚
 */
function startGame(level){
  footer.style.display = 'block'; // ç¡®ä¿é¡µè„šå¯è§

  game.level = level;
  // ä¸º CSS è°ƒæ•´åº”ç”¨/ç§»é™¤å…³å¡ç‰¹å®šçš„ body ç±»
  if (level === 2) {
    document.body.classList.add('level-2-active');
  } else {
    document.body.classList.remove('level-2-active');
  }

  let lvData = genLevel(level); // ç”Ÿæˆå…³å¡æ•°æ®
  game.cards = lvData.cards; // ç¡®ä¿ game.cards å·²è®¾ç½®
  game.board = lvData.board; // ç¡®ä¿ game.board å·²è®¾ç½®
  game.usedIcons = lvData.usedIcons;
  game.temp = [];
  game.matched = [];
  game.toolUses = {undo: 0, hint: 0, shuffle: 0}; // é‡ç½®å·¥å…·ä½¿ç”¨æ¬¡æ•°
  game.stepStack = []; // æ¸…ç©ºæ’¤é”€å †æ ˆ
  game.lock = false; // é‡Šæ”¾ä»»ä½•é”å®š
  game.isNewLevel = true; // è®¾ç½®å¡ç‰‡å…¥åœºåŠ¨ç”»æ ‡å¿—
  renderAll(); // æ¸²æŸ“æ‰€æœ‰æ¸¸æˆå…ƒç´ 
  updateToolButtons(); // æ›´æ–°å·¥å…·æŒ‰é’®çŠ¶æ€
  // MODIFICATION START
  // ç¡®ä¿åœ¨å¼€å§‹ä»»ä½•å…³å¡æ—¶ BGM åº”è¯¥æ’­æ”¾
  if (game.bgmOn) {
      playBgm(true);
  }
  // MODIFICATION END
  positionCatWalker(); // æ¸¸æˆå¼€å§‹åå®šä½çŒ«å’ªè¡Œèµ°è€…
  // positionWigglingCat(); // MODIFICATION: This is now handled by updateWigglingCatVisibility
  updateWigglingCatVisibility(); // Initial check for wiggling cat visibility
}

/**
 * æ¸²æŸ“æ¸¸æˆæ¿ä¸Šçš„å¡ç‰‡ã€‚
 */
function renderBoard(){
  const area = document.getElementById('card-stack-area');
  area.innerHTML = ''; // æ¸…é™¤ç°æœ‰å¡ç‰‡
  let cardsToRender = game.board.filter(c => !c.matched); // åªæ¸²æŸ“æœªåŒ¹é…çš„å¡ç‰‡

  cardsToRender.sort((a, b) => a.z - b.z); // æŒ‰ Z ç´¢å¼•æ’åºä»¥å®ç°æ­£ç¡®åˆ†å±‚

  const isInitialRenderForLevel = game.isNewLevel; // æ•è·åŠ¨ç”»çŠ¶æ€

  cardsToRender.forEach((card, index) => {
    let el = document.createElement('div');
    const clickable = isCardClickable(card, game.board);
    el.className = "card" + (clickable ? "" : " disabled"); // å¦‚æœä¸å¯ç‚¹å‡»åˆ™æ·»åŠ â€œdisabledâ€ç±»
    el.style.left = card.x + 'px';
    el.style.top = card.y + 'px';
    el.style.zIndex = card.z;
    el.innerHTML = card.icon;
    el.dataset.id = card.id; // å°†å¡ç‰‡ ID å­˜å‚¨ä¸ºæ•°æ®å±æ€§

    if(clickable){
      el.onclick = () => clickCard(card.id); // é™„åŠ ç‚¹å‡»å¤„ç†ç¨‹åº
    }
    // ä¸ºæ–°å…³å¡åº”ç”¨å…¥åœºåŠ¨ç”»
    if (isInitialRenderForLevel) {
        el.classList.add('card-entering');
        el.style.animationDelay = `${index * 0.03}s`; // é”™å¼€åŠ¨ç”»
        el.addEventListener('animationend', function handler() {
            el.classList.remove('card-entering');
            el.style.animationDelay = ''; // æ¸…ç†åŠ¨ç”»å»¶è¿Ÿ
            el.removeEventListener('animationend', handler);
        }, { once: true });
    }
    area.appendChild(el);
  });
  game.isNewLevel = false; // æ¸²æŸ“åé‡ç½®æ ‡å¿—
}

/**
 * æ¸²æŸ“æš‚å­˜åŒºä¸­çš„å¡ç‰‡ã€‚
 */
function renderTemp(){
  const tempSlots = document.querySelectorAll('#temp-area .temp-slot');
  tempSlots.forEach((slot, i) => {
    slot.innerHTML = ''; // æ¸…é™¤ç°æœ‰å†…å®¹
    if (i < game.temp.length) {
      const c = game.temp[i];
      let el = document.createElement('div');
      el.className = "temp-card" + (c.matched ? " matched" : ""); // å¦‚æœå·²åŒ¹é…åˆ™æ·»åŠ â€œmatchedâ€ç±»
      el.innerHTML = c.icon;
      slot.appendChild(el);
    }
  });

  // --- çˆ±å¿ƒåŠ¨ç”»é€»è¾‘ ---
  let persistentHeart = document.getElementById('persistent-heart');

  if (game.temp.length === 7) {
    const seventhTempSlot = tempSlots[6]; // è·å–ç¬¬ 7 ä¸ªæ§½ä½ï¼ˆç´¢å¼• 6ï¼‰
    if (seventhTempSlot) {
      const mainArea = document.getElementById('main-area');
      const cardStackArea = document.getElementById('card-stack-area');

      // è·å–è¾¹ç•Œå®¢æˆ·ç«¯çŸ©å½¢ä»¥å®ç°ç›¸å¯¹äºè§†å£çš„ç²¾ç¡®ç»å¯¹ä½ç½®
      const seventhSlotRect = seventhTempSlot.getBoundingClientRect();
      const cardStackRect = cardStackArea.getBoundingClientRect();
      const mainAreaRect = mainArea.getBoundingClientRect();

      // è®¡ç®—çˆ±å¿ƒçš„å‚ç›´ä¸­ç‚¹ï¼Œåœ¨ cardStackArea çš„åº•éƒ¨å’Œç¬¬ 7 ä¸ªæš‚å­˜æ§½çš„é¡¶éƒ¨ä¹‹é—´
      const heartVerticalMidpointAbsolute = cardStackRect.bottom + (seventhSlotRect.top - cardStackRect.bottom) / 2;

      // å°†æ­¤ç»å¯¹ä½ç½®è½¬æ¢ä¸ºç›¸å¯¹äº mainArea é¡¶éƒ¨çš„ä½ç½®
      const heartTopRelativeToMainArea = heartVerticalMidpointAbsolute - mainAreaRect.top;

      // è®¡ç®—ç¬¬ 7 ä¸ªæ§½çš„æ°´å¹³ä¸­å¿ƒç›¸å¯¹äº mainArea
      const heartLeftRelativeToMainArea = (seventhTempSlot.left + seventhTempSlot.offsetWidth / 2) - mainAreaRect.left;

      if (!persistentHeart) {
        persistentHeart = document.createElement('div');
        persistentHeart.id = 'persistent-heart'; // ä¸ºæŒä¹…å¼•ç”¨åˆ†é…å”¯ä¸€ ID
        persistentHeart.className = 'heart-animation';
        persistentHeart.innerHTML = 'â¤';
        mainArea.appendChild(persistentHeart);
      }

      persistentHeart.style.left = `${heartLeftRelativeToMainArea}px`;
      persistentHeart.style.top = `${heartTopRelativeToMainArea}px`;
      persistentHeart.style.transform = 'translate(-50%, -50%)'; // å±…ä¸­çˆ±å¿ƒå›¾æ ‡æœ¬èº«
      persistentHeart.style.display = 'block'; // ç¡®ä¿å¯è§
    }
  } else {
    // å¦‚æœç¬¬ 7 ä¸ªæ§½æœªæ»¡ï¼Œåˆ™éšè—çˆ±å¿ƒ
    if (persistentHeart) {
      persistentHeart.style.display = 'none';
    }
  }
}

/**
 * æ¸²æŸ“å±•ç¤ºåŒºä¸­çš„å¡ç‰‡ã€‚
 */
function renderDisplay() {
    displayArea.innerHTML = ''; // æ¸…é™¤ç°æœ‰å±•ç¤ºå¡ç‰‡
    game.displayCards.forEach(displaySet => {
        const groupDiv = document.createElement('div');
        groupDiv.className = 'display-group';
        groupDiv.dataset.id = displaySet.id; // æ·»åŠ  data-id ä»¥ä¾›é€‰æ‹©
        displaySet.cards.forEach(card => {
            const cardDiv = document.createElement('div');
            cardDiv.className = 'display-card' + (displaySet.matched ? ' matched-display' : '');
            cardDiv.innerHTML = card.icon;
            groupDiv.appendChild(cardDiv);
        });
        displayArea.appendChild(groupDiv);
    });
}

/**
 * æ›´æ–°æ¸¸æˆè¿›åº¦ã€åˆ†æ•°å’Œç›®æ ‡æ˜¾ç¤ºã€‚
 */
function renderProgressAndScore(){
  // let left = game.board.filter(c=>!c.matched).length; // ç§»é™¤æ­¤è¡Œ
  levelInfoElement.textContent = `å…³å¡: ${game.level} / 2`;
  // cardCountInfoElement.textContent = `å‰©ä½™å¡ç‰Œ: ${left}`; // ç§»é™¤æ­¤è¡Œ
  currentScoreElement.textContent = game.score;
  targetScoreElement.textContent = game.targetScore;
  updateWigglingCatVisibility(); // Call this when score or target score might change
}

/**
 * å‘ç”¨æˆ·æ˜¾ç¤ºä¸´æ—¶æ¶ˆæ¯ã€‚
 * @param {string} msg - è¦æ˜¾ç¤ºçš„æ¶ˆæ¯ã€‚
 * @param {string} [color] - æ¶ˆæ¯çš„å¯é€‰é¢œè‰²ã€‚
 */
function showMessage(msg, color){
  let bar = document.getElementById('message-bar');
  bar.style.color = color || '#c0392b'; // é»˜è®¤ä¸ºçº¢è‰²
  bar.textContent = msg || '';
  if(msg) setTimeout(()=>{bar.textContent='';}, 2300); // å»¶è¿Ÿåæ¸…é™¤æ¶ˆæ¯
}

/**
 * æ›´æ–°å·¥å…·æŒ‰é’®ï¼ˆæ’¤é”€ã€æç¤ºã€æ´—ç‰Œï¼‰åŠå…¶è®¡æ•°å™¨çš„æ˜¾ç¤ºã€‚
 */
function updateToolButtons() {
  document.getElementById('undo-count').textContent = game.toolUses.undo;
  document.getElementById('hint-count').textContent = game.toolUses.hint;
  document.getElementById('shuffle-count').textContent = game.toolUses.shuffle;
  undoBtn.disabled = game.toolUses.undo <= 0;
  hintBtn.disabled = game.toolUses.hint <= 0;
  shuffleBtn.disabled = game.toolUses.shuffle <= 0;
}

/**
 * æ¸²æŸ“æ‰€æœ‰æ¸¸æˆå…ƒç´ ï¼ˆæ¸¸æˆæ¿ã€æš‚å­˜åŒºã€å±•ç¤ºåŒºã€è¿›åº¦ã€å·¥å…·æŒ‰é’®ï¼‰ã€‚
 */
function renderAll(){
  renderBoard();
  renderTemp();
  renderDisplay(); // æ¸²æŸ“å±•ç¤ºå¡ç‰‡
  renderProgressAndScore(); // æ›´æ–°è¿›åº¦å’Œåˆ†æ•°
  updateToolButtons();
  positionCatWalker(); // ç¡®ä¿æ‰€æœ‰å…ƒç´ æ¸²æŸ“åçŒ«å’ªè¡Œèµ°è€…å·²å®šä½
  updateWigglingCatVisibility(); // Ensure wiggling cat visibility is updated
}

/**
 * æ˜¾ç¤ºå…³å¡å®Œæˆå±å¹•å¹¶æ ¹æ®å½“å‰å…³å¡è¿›è¡Œé…ç½®ã€‚
 * @param {string} msg - è¦åœ¨å…³å¡å®Œæˆå±å¹•ä¸Šæ˜¾ç¤ºçš„æ¶ˆæ¯ã€‚
 */
function showLevelFinish(msg){
  // Clear any existing video timeout
  if (outroVideoTimeout) {
      clearTimeout(outroVideoTimeout);
      outroVideoTimeout = null;
  }
  // Pause and reset video if it was playing
  if (outroVideo) {
      outroVideo.pause();
      outroVideo.currentTime = 0;
  }

  level2OutroScreen.style.display = 'none'; // Hide outro screen if it's visible
  skipOutroBtn.style.display = 'none'; // Hide skip button
  game.lock = false; // Release lock after outro
  document.getElementById('level-finish').style.display='flex';
  levelFinishTextElement.innerHTML = msg;

  // æ ¹æ®å½“å‰å…³å¡æ˜¾ç¤º/éšè—â€œä¸‹ä¸€å…³â€æŒ‰é’®
  nextBtn.style.display = (game.level === 1) ? 'inline-block' : 'none';

  if (game.level === 1) {
    // å…³å¡ 1 å®Œæˆå±å¹•ç‰¹å®šåŠ¨ç”»å’Œå†…å®¹
    levelFinishTextElement.style.animation = 'shake 3s infinite, show-card-property 6s forwards';
    levelFinishTextElement.innerHTML += '<br>ä¸‹ä¸€å…³åæœ‰å½©è›‹ğŸª…ï¼';

    // æ˜¾ç¤ºè‡ªå®šä¹‰æ’­æ”¾å™¨ï¼Œéšè—ç½‘æ˜“æ’­æ”¾å™¨ï¼Œé…ç½®æŒ‰é’®
    playerDiv.style.display = 'block';
    neteasePlayerDiv.style.display = 'none';
    gobangBtn.style.display = 'none';
    restartGameBtn.style.display = 'none';
    retryBtnLevelFinish.style.display = 'inline-block';

  } else if (game.level === 2) {
    // å…³å¡ 2 å®Œæˆå±å¹•ç‰¹å®šåŠ¨ç”»å’Œå†…å®¹
    levelFinishTextElement.style.animation = 'pulse-scale 2s infinite alternate, wave 2s infinite';

    // éšè—è‡ªå®šä¹‰æ’­æ”¾å™¨ï¼Œæ˜¾ç¤ºç½‘æ˜“æ’­æ”¾å™¨ï¼Œé…ç½®æŒ‰é’®
    playerDiv.style.display = 'none';
    neteasePlayerDiv.style.display = 'block';
    gobangBtn.style.display = 'inline-block';
    restartGameBtn.style.display = 'inline-block';
    retryBtnLevelFinish.style.display = 'none';
  }

  // playBgm(false); // Moved to playLevel2Outro
}

/**
 * åŠ è½½ååˆå§‹åŒ–æ¸¸æˆè®¾ç½®å’Œå…ƒç´ ã€‚
 */
function initializeGame(){
  musicToggleBtn.innerHTML = game.bgmOn ? 'ğŸ¼' : 'ğŸ”‡';
  updateToolButtons();

  // è®¾ç½® BGM éŸ³é‡
  if (bgm) {
      bgm.volume = 0.3;
      // æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦å¯ä»¥æ’­æ”¾ MP3 å’Œ OGG
      console.log("Browser can play MP3:", bgm.canPlayType('audio/mpeg'));
      console.log("Browser can play OGG:", bgm.canPlayType('audio/ogg'));
  }
  // å·²ä»æ­¤å¤„ç§»é™¤ playBgm(game.bgmOn)ã€‚
}

/**
 * å¤„ç†å…³é—­æ¸¸æˆçª—å£çš„é€»è¾‘ï¼Œå¹¶å¸¦æœ‰å¤‡ç”¨æ¶ˆæ¯ã€‚
 * @param {string} type - 'level' æˆ– 'gameover' ä»¥åŒºåˆ†æ¶ˆæ¯ã€‚
 */
function handleCloseGame(type) {
    showConfirm('ç¡®å®šè¦å…³é—­æ¸¸æˆå—ï¼Ÿ', () => {
        // å°è¯•å…³é—­çª—å£ã€‚è¿™å¯èƒ½åªåœ¨çª—å£æ˜¯ç”±è„šæœ¬ï¼ˆä¾‹å¦‚ï¼Œé€šè¿‡æ‚¨åŸŸä¸­çš„ window.open()ï¼‰æ‰“å¼€çš„æƒ…å†µä¸‹æ‰æœ‰æ•ˆã€‚
        // å¦åˆ™ï¼Œæµè§ˆå™¨é€šå¸¸ä¼šå‡ºäºå®‰å…¨åŸå› é˜»æ­¢å®ƒã€‚
        window.close();

        // å¦‚æœ window.close() å¤±è´¥ï¼Œåˆ™æä¾›å¤‡ç”¨æ–¹æ¡ˆæˆ–æ¶ˆæ¯
        setTimeout(() => {
            document.getElementById('game-container').style.display = 'none';

            let messageHtml = '';
            if (type === 'level') {
                messageHtml = `
                    <p>å½“å‰å®¢æˆ·ç«¯æš‚ä¸æ”¯æŒè‡ªåŠ¨å…³é—­ï¼Œ</p><p>è¯·ç‚¹å‡»é¡µé¢å…³é—­æ ‡ç­¾å…³é—­ã€‚</p>
                    <br> å¦‚è‹¥é‡æ–°å¼€å§‹æ¸¸æˆï¼Œè¯·ç‚¹å‡»<br><br>
                    <button onclick="window.location.href='https://kaiyuanzhuadmin.github.io/cat/'"
                            class="text-red-600 hover:text-red-800 font-medium transition-colors duration-300 flex items-center justify-center mt-4"
                            style="padding: 10px 20px; border: 1px solid #dc2626; background-color: #fef2f2; cursor: pointer; border-radius: 0.375rem;">
                      <span class="ml-1 flex items-center">é‡æ–°å¼€å§‹<i class="fa fa-refresh ml-1"></i></span>
                    </button>
                `;
            } else if (type === 'gameover') {
                messageHtml = `
                    <p>å½“å‰å®¢æˆ·ç«¯æš‚ä¸æ”¯æŒè‡ªåŠ¨å…³é—­</p><p>å°æç¤ºï¼šå¯è¾“å…¥â€œkaiyuanâ€å…‘æ¢æç¤ºæ¬¡æ•°ã€‚</p>
                    <br> å¦‚æœæƒ³é‡æ–°å¼€å§‹æ¸¸æˆï¼Œè¯·ç‚¹å‡»<br><br>
                    <button onclick="window.location.href='https://kaiyuanzhuadmin.github.io/cat/'"
                            class="text-red-600 hover:text-red-800 font-medium transition-colors duration-300 flex items-center justify-center mt-4"
                            style="padding: 10px 20px; border: 1px solid #dc2626; background-color: #fef2f2; cursor: pointer; border-radius: 0.375rem;">
                      <span class="ml-1 flex items-center">é‡æ–°å¼€å§‹<i class="fa fa-refresh ml-1"></i></span>
                    </button>
                `;
            }

            document.body.innerHTML = `
                <div class="game-thankyou-screen" style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:60vh; font-size:1.2em; color:#5d4037; text-align:center;opacity: 1;">
                  ${messageHtml}
                  <br>
                  <small class="loading-footer mt-8">å–µäº†ä¸ªå’ª &copy; 2025 | Designed by å¼€å…ƒ</small>
                </div>
            `;

            // åŠ¨æ€åŠ è½½ Font Awesome CSS ä»¥ä¾¿åœ¨å¤‡ç”¨æ¶ˆæ¯ä¸­ä½¿ç”¨å›¾æ ‡
            const fontAwesomeLink = document.createElement('link');
            fontAwesomeLink.href = 'https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css';
            fontAwesomeLink.rel = 'stylesheet';
            document.head.appendChild(fontAwesomeLink);
        }, 100); // ç¨ä½œå»¶è¿Ÿä»¥å…è®¸ window.close() å°è¯•
    });
}

// äº‹ä»¶ç›‘å¬å™¨
document.addEventListener('DOMContentLoaded', function() {
    // åˆå§‹åŒ–åŠ è½½å±å¹•
    initializeLoadingScreen();
    attemptVideoAutoplay();
    // ä»£ç è¾“å…¥åé¦ˆå’Œè‡ªåŠ¨å…‘æ¢é€»è¾‘
    const feedbackDiv = document.createElement('div');
    feedbackDiv.style.color = 'red';
    feedbackDiv.style.fontSize = '12px';
    feedbackDiv.style.marginTop = '5px';
    codeInput.parentNode.insertBefore(feedbackDiv, codeInput.nextSibling);

    codeInput.addEventListener('input', function() {
        const code = codeInput.value.trim();
        feedbackDiv.textContent = '';
        codeInput.style.borderColor = '';
        // æ”¯æŒä¸­æ–‡ã€è‹±æ–‡ï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰å’Œæ•°å­—çš„æ­£åˆ™è¡¨è¾¾å¼
        const codeRegex = /^[\u4e00-\u9fa5a-zA-Z0-9]*$/;

        if (code.length === 7) {
            const isValidFormat = codeRegex.test(code);
            if (isValidFormat) {
                feedbackDiv.textContent = 'å­—ç¬¦æ•°æ­£ç¡®';
                feedbackDiv.style.color = 'green';
                codeInput.style.borderColor = 'green';
                codeBtn.disabled = false;
                // æœ‰æ•ˆçš„ 7 ä¸ªå­—ç¬¦è¾“å…¥æ—¶è‡ªåŠ¨è§¦å‘å…‘æ¢æŒ‰é’®ç‚¹å‡»
                codeBtn.click();
            } else {
                feedbackDiv.textContent = 'å…‘æ¢ç åŒ…å«ä¸æ”¯æŒçš„å­—ç¬¦';
                feedbackDiv.style.color = 'red';
                codeInput.style.borderColor = 'red';
                codeBtn.disabled = true; // å¦‚æœæ ¼å¼æ— æ•ˆåˆ™ç¦ç”¨
            }
        } else if (code.length < 7) {
            feedbackDiv.textContent = `è¿˜å¯è¾“å…¥ ${7 - code.length} ä½`;
            feedbackDiv.style.color = 'orange';
            codeInput.style.borderColor = 'orange';
        } else { // code.length > 7 æˆ–ä¸ºç©º
            codeBtn.disabled = true;
        }
    });

    // å…‘æ¢æŒ‰é’®ç‚¹å‡»åæ¸…é™¤è¾“å…¥å¹¶é‡ç½®åé¦ˆ
    codeBtn.addEventListener('click', function() {
       codeInput.value = '';
       feedbackDiv.textContent = '';
       codeInput.style.borderColor = '';
    });
    codeBtn.disabled = true; // åˆå§‹ç¦ç”¨æŒ‰é’®

    // å…è®¸å›è½¦é”®è§¦å‘ä»£ç å…‘æ¢
    codeInput.addEventListener('keyup', function(event) {
      if (event.keyCode === 13 || event.key === 'Enter') {
        event.preventDefault(); // é˜»æ­¢é»˜è®¤å›è½¦è¡Œä¸º
        if (!codeBtn.disabled) { // ä»…åœ¨æŒ‰é’®å¯ç”¨æ—¶ç‚¹å‡»
            codeBtn.click();
        }
      }
      });

    // æ·»åŠ çª—å£å¤§å°è°ƒæ•´äº‹ä»¶ç›‘å¬å™¨ä»¥é‡æ–°å®šä½çŒ«å’ªè¡Œèµ°è€…å’Œæ‰­åŠ¨çŒ«å’ª
    window.addEventListener('resize', positionCatWalker);
    window.addEventListener('resize', updateWigglingCatVisibility); // MODIFICATION: Use this to re-position wiggling cats

    // Skip outro button event listener
    skipOutroBtn.addEventListener('click', () => {
        showLevelFinish('<p> <br> </p>æ‰€æœ‰å…³å¡å…¨éƒ¨é€šå…³ï¼<br> ğŸ‰ ä½ å¤ªæ£’å•¦ï¼ğŸ‰');
    });

    // Walking cat animation iteration listener
    if (walkingCat) {
        walkingCat.addEventListener('animationiteration', () => {
            isCatMirrored = !isCatMirrored;

            // Fade out
            walkingCat.style.opacity = '0';

            // After a very brief moment (allowing fade-out to start), change transform and fade back in
            setTimeout(() => {
                walkingCat.style.transform = isCatMirrored ? 'scaleX(-1)' : 'scaleX(1)';
                walkingCat.style.opacity = '1';
            }, 1); // Minimal delay (1ms) to ensure the opacity change is registered.
                   // The actual "fade" is handled by the CSS transition duration.
        });
    }
});

// Tool button click handlers
undoBtn.onclick = function(){
  if(game.toolUses.undo > 0 && game.stepStack.length > 0){
    undoStep();
    game.toolUses.undo--;
    updateToolButtons();
  } else if (game.toolUses.undo > 0 && game.stepStack.length === 0) {
    showMessage('æ— æ³•æ’¤é”€æ›´å¤š', '#888');
  }
};
hintBtn.onclick = function(){
  if(game.toolUses.hint > 0){
    hintStep();
    game.toolUses.hint--;
    updateToolButtons();
  }
};
shuffleBtn.onclick = function(){
  if(game.toolUses.shuffle > 0){
    shuffleStep();
    game.toolUses.shuffle--;
    updateToolButtons();
  }
};

// Restart current level button handler
restartCurrentLevelBtn.onclick = function() {
    showConfirm('ç¡®å®šè¦é‡æ–°å¼€å§‹å½“å‰å…³å¡å—ï¼Ÿæ‰€æœ‰é“å…·ä½¿ç”¨æ¬¡æ•°å°†é‡ç½®ã€‚', () => {
        startGame(game.level);
        setTimeout(() => {
            showMessage('å…³å¡å·²é‡æ–°å¼€å§‹ï¼', '#3e5a2b');
        }, 50);
    });
};

// Redemption code button handler
codeBtn.onclick = function(){
  let val = codeInput.value.trim().toLowerCase();

  if (REDEMPTION_CODES[val]) {
    const rewards = REDEMPTION_CODES[val];

    if (rewards.type === "skip_level") {
      // Simulate winning current level by matching all cards and setting score
      game.board.forEach(card => card.matched = true);
      game.score = game.targetScore; // Ensure score meets target
      renderBoard();
      renderProgressAndScore();
      checkWin();
      showMessage(`å…‘æ¢æˆåŠŸï¼å½“å‰å…³å¡å·²è·³è¿‡ï¼`, "#3e5a2b");
    } else {
      // Existing tool redemption logic
      game.toolUses.undo += rewards.undo;
      game.toolUses.hint += rewards.hint;
      game.toolUses.shuffle += rewards.shuffle;

      // Optional: Add check to prevent reusing codes (e.g., delete REDEMPTION_CODES[val];)

      showMessage(`å…‘æ¢æˆåŠŸï¼è·å¾—æ’¤é”€x${rewards.undo}, æç¤ºx${rewards.hint}, æ´—ç‰Œx${rewards.shuffle}`, "#3e5a2b");
    }
    updateToolButtons();
  } else {
    showMessage('å…‘æ¢ç é”™è¯¯', "#c0392b");
  }
  codeInput.value = ''; // Clear input field
};

// Music toggle button handler
musicToggleBtn.onclick = function(){
  game.bgmOn = !game.bgmOn;
  this.innerHTML = game.bgmOn ? 'ğŸ¼' : 'ğŸ”‡';
  playBgm(game.bgmOn);
};

// Start game button handler
startBtn.onclick = function(){
  document.getElementById('start-screen').style.display = 'none';
  startGame(1);
  // playBgm(game.bgmOn) is now handled in startGame
};

// Level finish screen buttons
nextBtn.onclick = function(){
  document.getElementById('level-finish').style.display = 'none';
  startGame(2);
};
retryBtnLevelFinish.onclick = function(){
  document.getElementById('level-finish').style.display = 'none';
  startGame(game.level); // Replay current level
};
retryBtnGameOver.onclick = function(){
  document.getElementById('game-over').style.display = 'none';
  startGame(game.level); // Replay current level from game over screen
};

// External links/actions
gobangBtn.onclick = function() {
  window.open('https://kaiyuanzhuadmin.github.io/kaiyuan/', '_blank');
};
restartGameBtn.onclick = function() {
    window.location.href = 'https://kaiyuanzhuadmin.github.io/cat/'; // Redirect to restart game
};

// Close game buttons
closeGameBtnLevel.onclick = () => handleCloseGame('level');
closeGameBtnGameOver.onclick = () => handleCloseGame('gameover');

/**
 * Initializes the loading screen and handles its progress.
 */
function initializeLoadingScreen() {
    const loadingScreen = document.getElementById('loading-screen');
    const progressBar = document.getElementById('progress-bar');
    const loadingText = document.getElementById('loading-text');

    let progress = 0;
    const assets = ["åŠ è½½å­—ä½“...", "åŠ è½½éŸ³æ•ˆ...", "åŠ è½½å›¾ç‰‡...", "åˆå§‹åŒ–å…³å¡...", "å‡†å¤‡å–µå’ª...", "å®Œæˆ!"];
    let assetIndex = 0;
    loadingText.textContent = assets[0];

    const interval = setInterval(() => {
        progress += Math.random() * 15 + 5; // Simulate loading progress

        if (progress >= 100) {
            progress = 100;
            clearInterval(interval);

            progressBar.style.width = progress + '%';
            loadingText.textContent = assets[assets.length - 1];

            setTimeout(() => {
                loadingScreen.style.opacity = '0';
                loadingScreen.addEventListener('transitionend', () => {
                    loadingScreen.style.display = 'none';
                    document.title = "å–µäº†ä¸ªå’ª"; // Set final page title
                    initializeGame(); // Initialize game
                }, { once: true });
            }, 400); // Fade out duration
        } else {
            progressBar.style.width = progress + '%';
            const nextAssetThreshold = (assetIndex + 1) * 20;
            if (progress > nextAssetThreshold && assetIndex < assets.length - 1) {
                assetIndex++;
                loadingText.textContent = assets[assetIndex]; // Update loading text
            }
        }
    }, 250); // Update interval
}
function attemptVideoAutoplay() {
    const video = document.getElementById('start-screen-video');
    if (!video) return;

    // 1. Try direct play (works for some Android WeChat and desktop browsers)
    const playPromise = video.play();

    if (playPromise !== undefined) {
        playPromise.catch(error => {
            console.log("Video direct play failed, waiting for user interaction or WeixinJSBridgeReady event.", error);
            // Playback failed, add touch listener as fallback
            document.body.addEventListener('touchstart', function onFirstTouch() {
                video.play().catch(e => console.error("Video playback failed after touch:", e));
                // Remove listener after first touch to avoid repeated triggers
                document.body.removeEventListener('touchstart', onFirstTouch);
            }, { once: true }); // Using {once: true} also ensures it runs only once
        });
    }

    // 2. Add WeixinJSBridgeReady listener specifically for WeChat environment
    if (typeof WeixinJSBridge == "object" && typeof WeixinJSBridge.invoke == "function") {
        WeixinJSBridge.invoke('getNetworkType', {}, function(e) {
            video.play().catch(err => console.error("Video playback failed after WeixinJSBridge ready:", err));
        });
    } else {
        document.addEventListener("WeixinJSBridgeReady", function() {
            WeixinJSBridge.invoke('getNetworkType', {}, function(e) {
                video.play().catch(err => console.error("Video playback failed after WeixinJSBridgeReady event triggered:", err));
            });
        }, false);
    }
}

/**
 * Position the walking cat animation element.
 * This function should be called after main game elements are rendered and on window resize to ensure correct positioning.
 */
function positionCatWalker() {
    const displayArea = document.getElementById('display-area');
    const catPath = document.getElementById('cat-path');
    const mainArea = document.getElementById('main-area');

    if (!displayArea || !catPath || !mainArea) {
        console.warn("Missing elements for walking cat positioning.");
        return;
    }

    // Calculate the position of displayArea's bottom relative to mainArea's top
    const displayAreaBottomRelativeToMainArea = displayArea.offsetTop + displayArea.offsetHeight;

    // Set catPath's top just below the displayArea
    catPath.style.top = `${displayAreaBottomRelativeToMainArea}px`;
    // Ensure catPath spans the full width of mainArea for animation
    catPath.style.width = `${mainArea.offsetWidth}px`;
}

/**
 * MODIFICATION: Positions a single wiggling cat instance over a specific temp slot.
 * @param {HTMLElement} wigglingCatEl - The wiggling cat DOM element.
 * @param {number} slotIndex - The 0-based index of the target temp slot.
 */
function positionWigglingCat(wigglingCatEl, slotIndex) {
    const tempSlots = document.querySelectorAll('#temp-area .temp-slot');
    const cardStackArea = document.getElementById('card-stack-area');
    const mainArea = document.getElementById('main-area');

    if (!wigglingCatEl || tempSlots.length === 0 || !cardStackArea || !mainArea || slotIndex < 0 || slotIndex >= tempSlots.length) {
        console.warn(`Missing elements or invalid slot index for wiggling cat positioning (slotIndex: ${slotIndex}).`);
        wigglingCatEl.style.display = 'none'; // Ensure it's hidden if positioning fails
        return;
    }

    const targetTempSlot = tempSlots[slotIndex];

    const cardStackRect = cardStackArea.getBoundingClientRect();
    const targetTempSlotRect = targetTempSlot.getBoundingClientRect();
    const mainAreaRect = mainArea.getBoundingClientRect();

    // Calculate the vertical midpoint of the gap between cardStackArea bottom and targetTempSlot top
    const gapMidpointAbsolute = cardStackRect.bottom + (targetTempSlotRect.top - cardStackRect.bottom) / 2;

    // Convert this absolute position to a position relative to mainArea's top
    const topRelativeToMainArea = gapMidpointAbsolute - mainAreaRect.top;

    // Calculate the horizontal center of the target slot relative to mainArea
    const leftRelativeToMainArea = (targetTempSlotRect.left + targetTempSlot.offsetWidth / 2) - mainAreaRect.left;

    // Set wigglingCatEl's top and left, adjusting by half its height/width to center it
    wigglingCatEl.style.top = `${topRelativeToMainArea - (wigglingCatEl.offsetHeight / 2)}px`;
    wigglingCatEl.style.left = `${leftRelativeToMainArea}px`; // Already centered with transformX(-50%)
    wigglingCatEl.style.display = 'block'; // Make it visible
}

/**
 * MODIFICATION: Hides all wiggling cat instances.
 */
function hideWigglingCats() {
    wigglingCat1.style.display = 'none';
    wigglingCat4.style.display = 'none';
    wigglingCat7.style.display = 'none';
}

/**
 * MODIFICATION: Updates the visibility and position of wiggling cats based on remaining cards.
 */
function updateWigglingCatVisibility() {
    // Change condition to show wiggling cats when score meets target
    if (game.score >= game.targetScore) {
        // Show and position cats
        positionWigglingCat(wigglingCat1, 0); // Above first slot (index 0)
        positionWigglingCat(wigglingCat4, 3); // Above fourth slot (index 3)
        positionWigglingCat(wigglingCat7, 6); // Above seventh slot (index 6)
    } else {
        // Hide cats
        hideWigglingCats();
    }
}

/**
 * MODIFICATION: Handles the Level 2 outro video/image playback.
 */
function playLevel2Outro() {
    game.lock = true; // Lock game interaction during outro
    playBgm(false); // Pause BGM

    level2OutroScreen.style.display = 'flex';
    outroLoadingText.style.display = 'block'; // Show loading text
    skipOutroBtn.style.display = 'block'; // Show skip button

    outroVideo.style.display = 'none';
    outroImage.style.display = 'none';

    // Set a timeout for video playback fallback
    outroVideoTimeout = setTimeout(() => {
        console.warn("Outro video timed out or failed to play, falling back to image/finish screen.");
        outroVideo.style.display = 'none';
        outroImage.style.display = 'block';
        outroLoadingText.textContent = 'è§†é¢‘æ— æ³•æ’­æ”¾ï¼Œæ˜¾ç¤ºå›¾ç‰‡...';
        // After showing image for a bit, transition to finish screen
        setTimeout(() => {
            showLevelFinish('<p> <br> </p>æ‰€æœ‰å…³å¡å…¨éƒ¨é€šå…³ï¼<br> ğŸ‰ ä½ å¤ªæ£’å•¦ï¼ğŸ‰');
        }, 3000); // Display image for 3 seconds before moving on
    }, 7000); // 7 seconds timeout for video to start playing or end

    // Attempt to play video
    outroVideo.load(); // Load the video
    const playPromise = outroVideo.play();

    if (playPromise !== undefined) {
        playPromise.then(() => {
            // Video started playing successfully
            console.log("Outro video started playing.");
            outroVideo.style.display = 'block';
            outroLoadingText.style.display = 'none'; // Hide loading text once video plays
            // Clear the timeout as video is playing
            if (outroVideoTimeout) {
                clearTimeout(outroVideoTimeout);
                outroVideoTimeout = null;
            }
        }).catch(error => {
            // Video autoplay failed, immediately trigger fallback
            console.error("Outro video autoplay failed:", error);
            outroVideo.style.display = 'none';
            outroImage.style.display = 'block';
            outroLoadingText.textContent = 'è§†é¢‘æ— æ³•æ’­æ”¾ï¼Œæ˜¾ç¤ºå›¾ç‰‡...';
            // Clear the timeout and proceed to finish screen after a short image display
            if (outroVideoTimeout) {
                clearTimeout(outroVideoTimeout);
                outroVideoTimeout = null;
            }
            setTimeout(() => {
                showLevelFinish('<p> <br> </p>æ‰€æœ‰å…³å¡å…¨éƒ¨é€šå…³ï¼<br> ğŸ‰ ä½ å¤ªæ£’å•¦ï¼ğŸ‰');
            }, 3000); // Display image for 3 seconds
        });
    }

    // Event listener for video ending
    outroVideo.onended = () => {
        console.log("Outro video ended.");
        // Clear the timeout if video ended naturally
        if (outroVideoTimeout) {
            clearTimeout(outroVideoTimeout);
            outroVideoTimeout = null;
        }
        showLevelFinish('<p> <br> </p>æ‰€æœ‰å…³å¡å…¨éƒ¨é€šå…³ï¼<br> ğŸ‰ ä½ å¤ªæ£’å•¦ï¼ğŸ‰');
    };

    // Event listener for video errors (e.g., failed to load, unsupported format)
    outroVideo.onerror = (e) => {
        console.error("Outro video error:", e);
        // Immediately trigger fallback to image/finish screen
        if (outroVideoTimeout) {
            clearTimeout(outroVideoTimeout);
            outroVideoTimeout = null;
        }
        outroVideo.style.display = 'none';
        outroImage.style.display = 'block';
        outroLoadingText.textContent = 'è§†é¢‘åŠ è½½å¤±è´¥ï¼Œæ˜¾ç¤ºå›¾ç‰‡...';
        setTimeout(() => {
            showLevelFinish('<p> <br> </p>æ‰€æœ‰å…³å¡å…¨éƒ¨é€šå…³ï¼<br> ğŸ‰ ä½ å¤ªæ£’å•¦ï¼ğŸ‰');
        }, 3000); // Display image for 3 seconds
    };
}
</script>
</body>
</html>
